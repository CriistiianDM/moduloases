'use strict';define(['jquery','core/config','block_ases/loading_indicator','block_ases/csv','block_ases/bootstrap','block_ases/sweetalert','block_ases/jqueryui','block_ases/select2','block_ases/jquery.dataTables'],function(a,b,c,d){var k=[],p=function(){return b.wwwroot+'/blocks/ases/managers/monitor_assignments/monitor_assignments_api.php'},q=function(u,v){var x=JSON.stringify({function:'get_monitor_practicing_and_students_report',params:{instance_id:u,semester_name:v}});return a.ajax({url:p(),contentType:'application/csv',method:'POST',data:x})},r=function(){return a('#monitor_assignments_instance_id').data('instance-id')},s=function(){return a('#monitor_assignments_instance_id').data('semester-name')},t=function(u,v){c.show(),q(u,v).then(function(w){d.csv_string_to_file_for_download(w,'asignaciones_monitor_con_practicantes.csv'),c.hide()}).catch(function(w){c.hide(),console.log(w)})};return{init:function init(){function u(y,z,A){'monitor'===y?(c.show(),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_current_practicant_by_monitor',params:[z,A]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(B){c.hide(),0==B.status_code?B.data_response?w(z,B.data_response,!0):setTimeout(function(){swal({title:'Informaci\xF3n',text:'El monitor seleccionado no tiene asignado un practicante.',type:'info'},function(){})},0):console.log(B)},failure:function failure(B){c.hide(),console.log(B)}})):'student'==y&&(c.show(),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_current_monitor_by_student',params:[z,A]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(B){c.hide(),0==B.status_code?B.data_response?(u('monitor',z,B.data_response),v(z,B.data_response)):setTimeout(function(){swal({title:'Informaci\xF3n',text:'El estudiante seleccionado no tiene asignado un monitor.',type:'info'},function(){})},0):console.log(B)},failure:function failure(B){c.hide(),console.log(B)}}))}function v(y,z){a('#student_assigned').addClass('items_assigned_empty'),a('#student_assigned').html('Consultando <span>.</span><span>.</span><span>.</span>'),a('.student_item').removeClass('oculto-asignado'),a('#student_column').animate({scrollTop:a('#student_column').scrollTop()+a('#student_assigned').position().top},0),c.show(),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_monitors_students_relationship_by_instance',params:[y]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(A){if(c.hide(),0==A.status_code){var B=A.data_response;a('.monitor_item').removeClass('active'),a('.monitor_item[data-id=\''+z+'\']').addClass('active'),a('.student_item').find('.add').removeClass('oculto-asignar'),a('.student_item').removeClass('assigned'),a('.student_item').removeClass('not-assigned'),a('.student_item').addClass('not-assigned'),a('#student_assigned').removeClass('items_assigned_empty'),a('#student_assigned').text('');for(var C=!1,D=0;D<B.length;D++)B[D].id_monitor==z?(C||(C=!0,a('#student_assigned').removeClass('items_assigned_empty')),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').removeClass('not-assigned'),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').addClass('assigned'),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').find('.add').addClass('oculto-asignar'),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').clone().appendTo('#student_assigned'),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').not('#student_assigned .student_item').addClass('oculto-asignado')):(a('.student_item[data-id=\''+B[D].id_estudiante+'\']').find('.add').addClass('oculto-asignar'),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').find('.delete').addClass('oculto-eliminar'),a('.student_item[data-id=\''+B[D].id_estudiante+'\']').addClass('oculto-asignado'));a('#student_assigned').find('.student_item').find('.add').addClass('oculto-asignar'),a('#student_assigned').find('.student_item').find('.delete').removeClass('oculto-eliminar'),C||(a('#student_assigned').addClass('items_assigned_empty'),a('#student_assigned').text('No tiene estudiantes asignados.'))}else console.log(A)},failure:function failure(A){c.hide(),console.log(A)}})}function w(y,z){var A=2<arguments.length&&arguments[2]!==void 0&&arguments[2];c.show(),a('#monitor_assigned').addClass('items_assigned_empty'),a('#monitor_assigned').html('Consultando <span>.</span><span>.</span><span>.</span>'),a('.monitor_item').removeClass('oculto-asignado'),a('#monitor_column').animate({scrollTop:a('#monitor_column').scrollTop()+a('#monitor_assigned').position().top},0),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_practicant_monitor_relationship_by_instance',params:[y]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(B){if(c.hide(),0==B.status_code){var C=B.data_response;a('.practicant_item').removeClass('active'),a('.practicant_item[data-id=\''+z+'\']').addClass('active'),a('.monitor_item').find('.add').removeClass('oculto-asignar'),a('.monitor_item').find('.transfer').removeClass('oculto-tranferir'),a('.monitor_item').removeClass('assigned'),a('.monitor_item').removeClass('not-assigned'),a('.monitor_item').addClass('not-assigned'),a('.student_item').removeClass('assigned'),a('.student_item').removeClass('not-assigned'),a('.student_item').addClass('not-assigned'),A||(a('#student_assigned').text('No ha seleccionado un monitor.'),a('#student_assigned').addClass('items_assigned_empty')),a('#monitor_assigned').text('');for(var D=!1,E=0;E<C.length;E++)C[E].id_practicante==z?(D||(D=!0,a('#monitor_assigned').removeClass('items_assigned_empty')),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').removeClass('not-assigned'),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').addClass('assigned'),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').find('.add').addClass('oculto-asignar'),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').clone().appendTo('#monitor_assigned'),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').not('#monitor_assigned .monitor_item').addClass('oculto-asignado')):(a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').find('.add').addClass('oculto-asignar'),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').find('.delete').addClass('oculto-eliminar'),a('.monitor_item[data-id=\''+C[E].id_monitor+'\']').addClass('oculto-asignado'));a('#monitor_assigned').find('.monitor_item').find('.add').addClass('oculto-asignar'),a('#monitor_assigned').find('.monitor_item').find('.delete').removeClass('oculto-eliminar'),a('.monitor_item').not('#monitor_assigned .monitor_item').find('.transfer').addClass('oculto-tranferir'),D||(a('#monitor_assigned').addClass('items_assigned_empty'),a('#monitor_assigned').text('No tiene monitores asignados.'))}else console.log(B)},failure:function failure(B){c.hide(),console.log(B)}})}function x(){k=[];var y=a('#monitor_assignments_instance_id').data('instance-id'),A=s();a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_practicants_monitors_and_students',params:[y,A]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(B){total=0,B.data_response.forEach(function(D){k[D.nombre_usuario_moodle__profesional]==void 0?k[D.nombre_usuario_moodle__profesional]=1:k[D.nombre_usuario_moodle__profesional]++,k[D.codigo_practicante]==void 0?k[D.codigo_practicante]=1:k[D.codigo_practicante]++,k[D.codigo_monitor]==void 0?k[D.codigo_monitor]=1:k[D.codigo_monitor]++,k.TODOS==void 0?k.TODOS=1:k.TODOS++}),a('.item-general-list').each(function(){var E=a(this).data('username');a(this).find('.item-text').find('.asignation_counter').text(k[E])}),a('.total_counter').text(k.TODOS);var C=a('#select-professional').find(':selected').attr('data-username');a('.asignation_counter_prof').text(k[C]),a('#select-professional').find('option').each(function(){var E=a(this).data('username'),F=a(this).data('fullname');a(this).text(F+' - ( '+k[E]+' )')})},failure:function failure(B){console.log(B)}})}a('#button-get-complete-report').click(function(){t(r(),s())});a('#student-name-filter').keyup(function(){a('.student_item').removeClass('oculto-filtro-nombre');var y=a(this).val();''==y?a(this).removeClass('filter-active'):(/\d/.test(y)?a('.student_item').not('.item-general-list.student_item[data-username*="'+y.toUpperCase()+'"]').addClass('oculto-filtro-nombre'):a('.student_item').not('.item-general-list.student_item[data-name*="'+y.toUpperCase()+'"]').addClass('oculto-filtro-nombre'),a(this).addClass('filter-active'))}),a('#monitor-name-filter').keyup(function(){a('.monitor_item').removeClass('oculto-filtro-nombre');var y=a(this).val();''==y?a(this).removeClass('filter-active'):(/\d/.test(y)?a('.monitor_item').not('.item-general-list.monitor_item[data-username*="'+y.toUpperCase()+'"]').addClass('oculto-filtro-nombre'):a('.monitor_item').not('.item-general-list.monitor_item[data-name*="'+y.toUpperCase()+'"]').addClass('oculto-filtro-nombre'),a(this).addClass('filter-active'))}),a('#btn-student-name-filter').click(function(){a('#student-name-filter').val(''),a('.student_item').removeClass('oculto-filtro-nombre'),a('#student-name-filter').removeClass('filter-active')}),a('#btn-monitor-name-filter').click(function(){a('#monitor-name-filter').val(''),a('.monitor_item').removeClass('oculto-filtro-nombre'),a('#monitor-name-filter').removeClass('filter-active')}),a(document).ready(function(){x(),a('select').trigger('change')}),a(document).on('click','.practicant_item',function(){a('.monitor_item').removeClass('active'),w(a('#monitor_assignments_instance_id').data('instance-id'),a(this).attr('data-id'))}),a(document).on('click','.monitor_item',function(){v(a('#monitor_assignments_instance_id').data('instance-id'),a(this).attr('data-id'))}),a(document).on('click','.student_item',function(){var y=a(this).attr('data-id');a('.student_item').removeClass('active'),a(this).addClass('active'),a('.student_item[data-id=\''+y+'\']').addClass('active'),u('student',a('#monitor_assignments_instance_id').data('instance-id'),y)}),a(document).on('click','.add',function(y){y.stopImmediatePropagation();var z=a(this),A=a('#monitor_assignments_instance_id').data('instance-id'),B=a(this).parent(),C=-1,D=B.attr('data-id'),E=B.attr('data-item'),F='';if('student'==E){if(F='create_monitor_student_relationship',C=a('.monitor_item.active').attr('data-id'),null==C)return void setTimeout(function(){swal({title:'Error',text:'Debe seleccionar primero a un monitor.',type:'error'},function(){})},0);}else if('monitor'==E&&(F='create_practicant_monitor_relationship',C=a('.practicant_item.active').attr('data-id'),null==C))return void setTimeout(function(){swal({title:'Error',text:'Debe seleccionar primero a un practicante.',type:'error'},function(){})},0);a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':F,params:[A,C,D]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(G){0===G.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Asignaci\xF3n registrada correctamente.',type:'success'},function(){'student'==E?(v(A,C),B.find('.add').addClass('oculto-asignar')):'monitor'==E&&(w(A,C),B.find('.add').addClass('oculto-asignar'))})},0):-5===G.status_code?'student'==E?setTimeout(function(){swal({title:'Informaci\xF3n',text:'La asignaci\xF3n ya existe en el periodo actual, si tiene problemas con esto, puede probar de nuevo recargando la pesta\xF1a.',type:'info'},function(){})},0):'monitor'==E&&setTimeout(function(){swal({title:'Informaci\xF3n',text:'Este monitor ya se encuentra asignado.',type:'info'},function(){})},0):setTimeout(function(){swal({title:'Error',text:'Reporte este error.',type:'error'},function(){})},0),x()},failure:function failure(G){console.log(G)}})}),a(document).on('click','.delete',function(y){y.stopImmediatePropagation();var z=a(this),A=a('#monitor_assignments_instance_id').data('instance-id'),B=a(this).parent(),C=-1,D=B.attr('data-id'),E=B.attr('data-item'),F='';'student'==E?(F='delete_monitor_student_relationship',C=a('.monitor_item.active').attr('data-id')):'monitor'==E&&(F='delete_practicant_monitor_relationship',C=a('.practicant_item.active').attr('data-id')),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':F,params:[A,C,D]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(G){0===G.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Asignaci\xF3n eliminada correctamente',type:'success'},function(){'student'==E?(v(A,C),B.find('.add').removeClass('oculto-asignar')):'monitor'==E&&(w(A,C),B.find('.add').addClass('oculto-asignar'))})},0):1===G.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Est\xE1 intentando eliminar una asignaci\xF3n que ya no existe, si tiene problemas con esto, puede probar de nuevo recargando la pesta\xF1a.',type:'info'},function(){})},0):(setTimeout(function(){swal({title:'Error',text:'Reporte este error.',type:'error'},function(){})},0),console.log(G)),x()},failure:function failure(G){console.log(G)}})}),a(document).on('click','.transfer',function(y){y.stopImmediatePropagation();var z=a(this).parent().data('name'),A=a(this).parent().data('id');a('#modalTransfer').modal('show'),a('#old_monitor_name').text(z);var B='<option value="" disabled selected>Seleccione un monitor</option>\n';a('#monitor_assigned > .monitor_item').each(function(){var C=a(this).data('name'),D=a(this).data('id');B+='<option data-old="'+A+'" data-new="'+D+'">'+C+'</option>\n'}),a('#transfer-monitor-list').html(''),a('#transfer-monitor-list').append(B)}),a(document).on('click','#btn-execute-transfer',function(){a('#modalTransfer').modal('hide');var z=a('#monitor_assignments_instance_id').data('instance-id'),B=a('#transfer-monitor-list').find(':selected').data('old'),C=a('#transfer-monitor-list').find(':selected').data('new');a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'transfer',params:[z,B,C]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(D){0===D.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Estudiantes transferidos correctamente.',type:'success'},function(){v(z,C)})},0):1===D.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'El monitor no tiene estudiantes para transferir.',type:'info'},function(){})},0):(setTimeout(function(){swal({title:'Error',text:'Reporte este error.',type:'error'},function(){}),swal.close()},0),console.log(D)),x()},failure:function failure(D){console.log(D)}})}),a('select').change(function(){var y=a(this).attr('data-id').split('_')[0],z=a(this).attr('data-id').split('_')[1];if('monitor'==y&&'faculty'==z){var A=a(this).find(':selected').attr('data-id-facultad');'-1'==A?(a(this).removeClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-facultad')):(a(this).addClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-facultad'),a('.item-general-list.monitor_item').not('.item-general-list.monitor_item[data-id-facultad=\''+A+'\']').addClass('oculto-facultad'))}else if('monitor'==y&&'program'==z){var B=a(this).find(':selected').attr('data-cod-programa');'-1'==B?(a(this).removeClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-programa')):(a(this).addClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-programa'),a('.item-general-list.monitor_item').not('.item-general-list.monitor_item[data-cod-programa=\''+B+'\']').addClass('oculto-programa'))}else if('student'==y&&'faculty'==z){var A=a(this).find(':selected').attr('data-id-facultad');'-1'==A?(a(this).removeClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-facultad')):(a(this).addClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-facultad'),a('.item-general-list.student_item').not('.item-general-list.student_item[data-id-facultad=\''+A+'\']').addClass('oculto-facultad'))}else if('student'==y&&'program'==z){var B=a(this).find(':selected').attr('data-cod-programa');'-1'==B?(a(this).removeClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-programa')):(a(this).addClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-programa'),a('.item-general-list.student_item').not('.item-general-list.student_item[data-cod-programa=\''+B+'\']').addClass('oculto-programa'))}else if('professional'==y){var C=a(this).find(':selected').attr('data-id');'-1'==C?(a(this).removeClass('filter-active'),a('.item-general-list.practicant_item').removeClass('oculto-jefe')):(a(this).addClass('filter-active'),a('.item-general-list.practicant_item').removeClass('oculto-jefe'),a('.item-general-list.practicant_item').not('.item-general-list.practicant_item[data-id-jefe=\''+C+'\']').addClass('oculto-jefe'))}})}}});