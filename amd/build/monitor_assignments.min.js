define(["jquery","core/config","block_ases/loading_indicator","block_ases/csv","block_ases/bootstrap","block_ases/sweetalert","block_ases/jqueryui","block_ases/select2","block_ases/jquery.dataTables"],function(t,e,a,n,i,s,o,r){var d=[],l=function(){return t("#monitor_assignments_instance_id").data("semester-name")},m=function(i,s){a.show(),function(a,n){var i={function:"get_monitor_practicing_and_students_report",params:{instance_id:a,semester_name:n}},s=JSON.stringify(i);return t.ajax({url:e.wwwroot+"/blocks/ases/managers/monitor_assignments/monitor_assignments_api.php",contentType:"application/csv",method:"POST",data:s})}(i,s).then(t=>{n.csv_string_to_file_for_download(t,"asignaciones_monitor_con_practicantes.csv"),a.hide()}).catch(t=>{a.hide(),console.log(t)})};return{init:function(){function e(e,n){t("#student_assigned").addClass("items_assigned_empty"),t("#student_assigned").html("Consultando <span>.</span><span>.</span><span>.</span>"),t(".student_item").removeClass("oculto-asignado"),t("#student_column").animate({scrollTop:t("#student_column").scrollTop()+t("#student_assigned").position().top},0),a.show(),t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"get_monitors_students_relationship_by_instance",params:[e]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(e){if(a.hide(),0==e.status_code){var i=e.data_response;t(".monitor_item").removeClass("active"),t(".monitor_item[data-id='"+n+"']").addClass("active"),t(".student_item").find(".add").removeClass("oculto-asignar"),t(".student_item").removeClass("assigned"),t(".student_item").removeClass("not-assigned"),t(".student_item").addClass("not-assigned"),t("#student_assigned").removeClass("items_assigned_empty"),t("#student_assigned").text("");for(var s=!1,o=0;o<i.length;o++)i[o].id_monitor==n?(s||(s=!0,t("#student_assigned").removeClass("items_assigned_empty")),t(".student_item[data-id='"+i[o].id_estudiante+"']").removeClass("not-assigned"),t(".student_item[data-id='"+i[o].id_estudiante+"']").addClass("assigned"),t(".student_item[data-id='"+i[o].id_estudiante+"']").find(".add").addClass("oculto-asignar"),t(".student_item[data-id='"+i[o].id_estudiante+"']").clone().appendTo("#student_assigned"),t(".student_item[data-id='"+i[o].id_estudiante+"']").not("#student_assigned .student_item").addClass("oculto-asignado")):(t(".student_item[data-id='"+i[o].id_estudiante+"']").find(".add").addClass("oculto-asignar"),t(".student_item[data-id='"+i[o].id_estudiante+"']").find(".delete").addClass("oculto-eliminar"),t(".student_item[data-id='"+i[o].id_estudiante+"']").addClass("oculto-asignado"));t("#student_assigned").find(".student_item").find(".add").addClass("oculto-asignar"),t("#student_assigned").find(".student_item").find(".delete").removeClass("oculto-eliminar"),s||(t("#student_assigned").addClass("items_assigned_empty"),t("#student_assigned").text("No tiene estudiantes asignados."))}else console.log(e)},failure:function(t){a.hide(),console.log(t)}})}function n(e,n,i=!1){a.show(),t("#monitor_assigned").addClass("items_assigned_empty"),t("#monitor_assigned").html("Consultando <span>.</span><span>.</span><span>.</span>"),t(".monitor_item").removeClass("oculto-asignado"),t("#monitor_column").animate({scrollTop:t("#monitor_column").scrollTop()+t("#monitor_assigned").position().top},0),t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"get_practicant_monitor_relationship_by_instance",params:[e]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(e){if(a.hide(),0==e.status_code){var s=e.data_response;t(".practicant_item").removeClass("active"),t(".practicant_item[data-id='"+n+"']").addClass("active"),t(".monitor_item").find(".add").removeClass("oculto-asignar"),t(".monitor_item").find(".transfer").removeClass("oculto-tranferir"),t(".monitor_item").removeClass("assigned"),t(".monitor_item").removeClass("not-assigned"),t(".monitor_item").addClass("not-assigned"),t(".student_item").removeClass("assigned"),t(".student_item").removeClass("not-assigned"),t(".student_item").addClass("not-assigned"),i||(t("#student_assigned").text("No ha seleccionado un monitor."),t("#student_assigned").addClass("items_assigned_empty")),t("#monitor_assigned").text("");for(var o=!1,r=0;r<s.length;r++)s[r].id_practicante==n?(o||(o=!0,t("#monitor_assigned").removeClass("items_assigned_empty")),t(".monitor_item[data-id='"+s[r].id_monitor+"']").removeClass("not-assigned"),t(".monitor_item[data-id='"+s[r].id_monitor+"']").addClass("assigned"),t(".monitor_item[data-id='"+s[r].id_monitor+"']").find(".add").addClass("oculto-asignar"),t(".monitor_item[data-id='"+s[r].id_monitor+"']").clone().appendTo("#monitor_assigned"),t(".monitor_item[data-id='"+s[r].id_monitor+"']").not("#monitor_assigned .monitor_item").addClass("oculto-asignado")):(t(".monitor_item[data-id='"+s[r].id_monitor+"']").find(".add").addClass("oculto-asignar"),t(".monitor_item[data-id='"+s[r].id_monitor+"']").find(".delete").addClass("oculto-eliminar"),t(".monitor_item[data-id='"+s[r].id_monitor+"']").addClass("oculto-asignado"));t("#monitor_assigned").find(".monitor_item").find(".add").addClass("oculto-asignar"),t("#monitor_assigned").find(".monitor_item").find(".delete").removeClass("oculto-eliminar"),t(".monitor_item").not("#monitor_assigned .monitor_item").find(".transfer").addClass("oculto-tranferir"),o||(t("#monitor_assigned").addClass("items_assigned_empty"),t("#monitor_assigned").text("No tiene monitores asignados."))}else console.log(e)},failure:function(t){a.hide(),console.log(t)}})}function i(){d=[];var e=t("#monitor_assignments_instance_id").data("instance-id"),a=l();t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"get_practicants_monitors_and_students",params:[e,a]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(e){total=0,e.data_response.forEach(t=>{null==d[t.nombre_usuario_moodle__profesional]?d[t.nombre_usuario_moodle__profesional]=1:d[t.nombre_usuario_moodle__profesional]++,null==d[t.codigo_practicante]?d[t.codigo_practicante]=1:d[t.codigo_practicante]++,null==d[t.codigo_monitor]?d[t.codigo_monitor]=1:d[t.codigo_monitor]++,null==d.TODOS?d.TODOS=1:d.TODOS++}),t(".item-general-list").each(function(e){let a=t(this).data("username");t(this).find(".item-text").find(".asignation_counter").text(d[a])}),t(".total_counter").text(d.TODOS);var a=t("#select-professional").find(":selected").attr("data-username");t(".asignation_counter_prof").text(d[a]),t("#select-professional").find("option").each(function(e){let a=t(this).data("username"),n=t(this).data("fullname");t(this).text(n+" - ( "+d[a]+" )")})},failure:function(t){console.log(t)}})}t("#button-get-complete-report").click(function(){m(t("#monitor_assignments_instance_id").data("instance-id"),l())}),t("#student-name-filter").keyup(function(){t(".student_item").removeClass("oculto-filtro-nombre");var e=t(this).val();""!=e?(/\d/.test(e)?t(".student_item").not('.item-general-list.student_item[data-username*="'+e.toUpperCase()+'"]').addClass("oculto-filtro-nombre"):t(".student_item").not('.item-general-list.student_item[data-name*="'+e.toUpperCase()+'"]').addClass("oculto-filtro-nombre"),t(this).addClass("filter-active")):t(this).removeClass("filter-active")}),t("#monitor-name-filter").keyup(function(){t(".monitor_item").removeClass("oculto-filtro-nombre");var e=t(this).val();""!=e?(/\d/.test(e)?t(".monitor_item").not('.item-general-list.monitor_item[data-username*="'+e.toUpperCase()+'"]').addClass("oculto-filtro-nombre"):t(".monitor_item").not('.item-general-list.monitor_item[data-name*="'+e.toUpperCase()+'"]').addClass("oculto-filtro-nombre"),t(this).addClass("filter-active")):t(this).removeClass("filter-active")}),t("#btn-student-name-filter").click(function(){t("#student-name-filter").val(""),t(".student_item").removeClass("oculto-filtro-nombre"),t("#student-name-filter").removeClass("filter-active")}),t("#btn-monitor-name-filter").click(function(){t("#monitor-name-filter").val(""),t(".monitor_item").removeClass("oculto-filtro-nombre"),t("#monitor-name-filter").removeClass("filter-active")}),t(document).ready(function(){i(),t(".asign-select-filter").trigger("change")}),t(document).on("click",".practicant_item",function(){t(".monitor_item").removeClass("active"),n(t("#monitor_assignments_instance_id").data("instance-id"),t(this).attr("data-id"))}),t(document).on("click",".monitor_item",function(){let i=t("#monitor_assignments_instance_id").data("instance-id"),s=t(this).attr("data-id");e(i,s),a.show(),t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"get_current_practicant_by_monitor",params:[i,s]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){a.hide(),0==t.status_code?t.data_response?n(i,t.data_response,!0):setTimeout(function(){swal({title:"Información",text:"El monitor seleccionado no tiene asignado un practicante.",type:"info"},function(){})},0):console.log(t)},failure:function(t){a.hide(),console.log(t)}})}),t(document).on("click",".student_item",function(){var i=t(this).attr("data-id");t(".student_item").removeClass("active"),t(this).addClass("active"),t(".student_item[data-id='"+i+"']").addClass("active"),function i(s,o,r){"monitor"===s?(a.show(),t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"get_current_practicant_by_monitor",params:[o,r]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){a.hide(),0==t.status_code?t.data_response?n(o,t.data_response,!0):setTimeout(function(){swal({title:"Información",text:"El monitor seleccionado no tiene asignado un practicante.",type:"info"},function(){})},0):console.log(t)},failure:function(t){a.hide(),console.log(t)}})):"student"===s&&(a.show(),t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"get_current_monitor_by_student",params:[o,r]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){a.hide(),0==t.status_code?t.data_response?(i("monitor",o,t.data_response),e(o,t.data_response)):setTimeout(function(){swal({title:"Información",text:"El estudiante seleccionado no tiene asignado un monitor.",type:"info"},function(){})},0):console.log(t)},failure:function(t){a.hide(),console.log(t)}}))}("student",t("#monitor_assignments_instance_id").data("instance-id"),i)}),t(document).on("click",".add",function(a){a.stopImmediatePropagation();t(this);var s=t("#monitor_assignments_instance_id").data("instance-id"),o=t(this).parent(),r=-1,d=o.attr("data-id"),l=o.attr("data-item"),m="";if("student"==l){if(m="create_monitor_student_relationship",null==(r=t(".monitor_item.active").attr("data-id")))return void setTimeout(function(){swal({title:"Error",text:"Debe seleccionar primero a un monitor.",type:"error"},function(){})},0)}else if("monitor"==l&&(m="create_practicant_monitor_relationship",null==(r=t(".practicant_item.active").attr("data-id"))))return void setTimeout(function(){swal({title:"Error",text:"Debe seleccionar primero a un practicante.",type:"error"},function(){})},0);t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:m,params:[s,r,d]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){0===t.status_code?setTimeout(function(){swal({title:"Información",text:"Asignación registrada correctamente.",type:"success"},function(){"student"==l?(e(s,r),o.find(".add").addClass("oculto-asignar")):"monitor"==l&&(n(s,r),o.find(".add").addClass("oculto-asignar"))})},0):-5===t.status_code?"student"==l?setTimeout(function(){swal({title:"Información",text:"La asignación ya existe en el periodo actual, si tiene problemas con esto, puede probar de nuevo recargando la pestaña.",type:"info"},function(){})},0):"monitor"==l&&setTimeout(function(){swal({title:"Información",text:"Este monitor ya se encuentra asignado.",type:"info"},function(){})},0):setTimeout(function(){swal({title:"Error",text:"Reporte este error.",type:"error"},function(){})},0),i()},failure:function(t){console.log(t)}})}),t(document).on("click",".delete",function(a){a.stopImmediatePropagation();t(this);var s=t("#monitor_assignments_instance_id").data("instance-id"),o=t(this).parent(),r=-1,d=o.attr("data-id"),l=o.attr("data-item"),m="";"student"==l?(m="delete_monitor_student_relationship",r=t(".monitor_item.active").attr("data-id")):"monitor"==l&&(m="delete_practicant_monitor_relationship",r=t(".practicant_item.active").attr("data-id")),t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:m,params:[s,r,d]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){0===t.status_code?setTimeout(function(){swal({title:"Información",text:"Asignación eliminada correctamente",type:"success"},function(){"student"==l?(e(s,r),o.find(".add").removeClass("oculto-asignar")):"monitor"==l&&(n(s,r),o.find(".add").addClass("oculto-asignar"))})},0):1===t.status_code?setTimeout(function(){swal({title:"Información",text:"Está intentando eliminar una asignación que ya no existe, si tiene problemas con esto, puede probar de nuevo recargando la pestaña.",type:"info"},function(){})},0):(setTimeout(function(){swal({title:"Error",text:"Reporte este error.",type:"error"},function(){})},0),console.log(t)),i()},failure:function(t){console.log(t)}})}),t(document).on("click",".transfer",function(e){e.stopImmediatePropagation();var a=t(this).parent().data("name"),n=t(this).parent().data("id");t("#old_monitor_name").text(a);var i='<option value="" disabled selected>Seleccione un monitor</option>\n';t("#monitor_assigned > .monitor_item").each(function(){var e=t(this).data("name"),a=t(this).data("id");i+='<option data-old="'+n+'" data-new="'+a+'">'+e+"</option>\n"}),t("#transfer-monitor-list").html(""),t("#transfer-monitor-list").append(i)}),t(document).on("click","#btn-execute-transfer",function(a){t("#modalTransfer").modal("hide");var n=t("#monitor_assignments_instance_id").data("instance-id"),s=t("#transfer-monitor-list").find(":selected").data("old"),o=t("#transfer-monitor-list").find(":selected").data("new");t.ajax({type:"POST",url:"../managers/monitor_assignments/monitor_assignments_api.php",data:JSON.stringify({function:"transfer",params:[n,s,o]}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){0===t.status_code?setTimeout(function(){swal({title:"Información",text:"Estudiantes transferidos correctamente.",type:"success"},function(){e(n,o)})},0):1===t.status_code?setTimeout(function(){swal({title:"Información",text:"El monitor no tiene estudiantes para transferir.",type:"info"},function(){})},0):(setTimeout(function(){swal({title:"Error",text:"Reporte este error.",type:"error"},function(){}),swal.close()},0),console.log(t)),i()},failure:function(t){console.log(t)}})}),t(".asign-select-filter").change(function(){var e=t(this).attr("data-id").split("_")[0],a=t(this).attr("data-id").split("_")[1];if("monitor"==e&&"faculty"==a)"-1"!=(n=t(this).find(":selected").attr("data-id-facultad"))?(t(this).addClass("filter-active"),t(".item-general-list.monitor_item").removeClass("oculto-facultad"),t(".item-general-list.monitor_item").not(".item-general-list.monitor_item[data-id-facultad='"+n+"']").addClass("oculto-facultad")):(t(this).removeClass("filter-active"),t(".item-general-list.monitor_item").removeClass("oculto-facultad"));else if("monitor"==e&&"program"==a){"-1"!=(i=t(this).find(":selected").attr("data-cod-programa"))?(t(this).addClass("filter-active"),t(".item-general-list.monitor_item").removeClass("oculto-programa"),t(".item-general-list.monitor_item").not(".item-general-list.monitor_item[data-cod-programa='"+i+"']").addClass("oculto-programa")):(t(this).removeClass("filter-active"),t(".item-general-list.monitor_item").removeClass("oculto-programa"))}else if("student"==e&&"faculty"==a){var n;"-1"!=(n=t(this).find(":selected").attr("data-id-facultad"))?(t(this).addClass("filter-active"),t(".item-general-list.student_item").removeClass("oculto-facultad"),t(".item-general-list.student_item").not(".item-general-list.student_item[data-id-facultad='"+n+"']").addClass("oculto-facultad")):(t(this).removeClass("filter-active"),t(".item-general-list.student_item").removeClass("oculto-facultad"))}else if("student"==e&&"program"==a){var i;"-1"!=(i=t(this).find(":selected").attr("data-cod-programa"))?(t(this).addClass("filter-active"),t(".item-general-list.student_item").removeClass("oculto-programa"),t(".item-general-list.student_item").not(".item-general-list.student_item[data-cod-programa='"+i+"']").addClass("oculto-programa")):(t(this).removeClass("filter-active"),t(".item-general-list.student_item").removeClass("oculto-programa"))}else if("professional"==e){var s=t(this).find(":selected").attr("data-id");"-1"!=s?(t(this).addClass("filter-active"),t(".item-general-list.practicant_item").removeClass("oculto-jefe"),t(".item-general-list.practicant_item").not(".item-general-list.practicant_item[data-id-jefe='"+s+"']").addClass("oculto-jefe")):(t(this).removeClass("filter-active"),t(".item-general-list.practicant_item").removeClass("oculto-jefe"))}})}}});