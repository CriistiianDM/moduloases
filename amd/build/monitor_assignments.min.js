'use strict';define(['jquery','core/config','block_ases/loading_indicator','block_ases/csv','block_ases/bootstrap','block_ases/sweetalert','block_ases/jqueryui','block_ases/select2','block_ases/jquery.dataTables'],function(a,b,c,d){var k=[],p=function(){return b.wwwroot+'/blocks/ases/managers/monitor_assignments/monitor_assignments_api.php'},q=function(u,v){var x=JSON.stringify({function:'get_monitor_practicing_and_students_report',params:{instance_id:u,semester_name:v}});return a.ajax({url:p(),contentType:'application/csv',method:'POST',data:x})},r=function(){return a('#monitor_assignments_instance_id').data('instance-id')},s=function(){return a('#monitor_assignments_instance_id').data('semester-name')},t=function(u,v){c.show(),q(u,v).then(function(w){d.csv_string_to_file_for_download(w,'asignaciones_monitor_con_practicantes.csv'),c.hide()}).catch(function(w){c.hide(),console.log(w)})};return{init:function init(){function u(x,y){a('#student_assigned').addClass('items_assigned_empty'),a('#student_assigned').html('Consultando <span>.</span><span>.</span><span>.</span>'),a('.student_item').removeClass('oculto-asignado'),a('#student_column').animate({scrollTop:a('#student_column').scrollTop()+a('#student_assigned').position().top},0),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_monitors_students_relationship_by_instance',params:[x]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(z){if(0==z.status_code){var A=z.data_response;a('.monitor_item').removeClass('active'),a('.monitor_item[data-id=\''+y+'\']').addClass('active'),a('.student_item').find('.add').removeClass('oculto-asignar'),a('.student_item').removeClass('assigned'),a('.student_item').removeClass('not-assigned'),a('.student_item').addClass('not-assigned'),a('#student_assigned').removeClass('items_assigned_empty'),a('#student_assigned').text('');for(var B=!1,C=0;C<A.length;C++)A[C].id_monitor==y?(B||(B=!0,a('#student_assigned').removeClass('items_assigned_empty')),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').removeClass('not-assigned'),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').addClass('assigned'),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').find('.add').addClass('oculto-asignar'),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').clone().appendTo('#student_assigned'),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').not('#student_assigned .student_item').addClass('oculto-asignado')):(a('.student_item[data-id=\''+A[C].id_estudiante+'\']').find('.add').addClass('oculto-asignar'),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').find('.delete').addClass('oculto-eliminar'),a('.student_item[data-id=\''+A[C].id_estudiante+'\']').addClass('oculto-asignado'));a('#student_assigned').find('.student_item').find('.add').addClass('oculto-asignar'),a('#student_assigned').find('.student_item').find('.delete').removeClass('oculto-eliminar'),B||(a('#student_assigned').addClass('items_assigned_empty'),a('#student_assigned').text('No tiene estudiantes asignados.'))}else console.log(z)},failure:function failure(z){console.log(z)}})}function v(x,y){a('#monitor_assigned').addClass('items_assigned_empty'),a('#monitor_assigned').html('Consultando <span>.</span><span>.</span><span>.</span>'),a('.monitor_item').removeClass('oculto-asignado'),a('#monitor_column').animate({scrollTop:a('#monitor_column').scrollTop()+a('#monitor_assigned').position().top},0),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_practicant_monitor_relationship_by_instance',params:[x]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(z){if(0==z.status_code){var A=z.data_response;a('.practicant_item').removeClass('active'),a('.practicant_item[data-id=\''+y+'\']').addClass('active'),a('.monitor_item').find('.add').removeClass('oculto-asignar'),a('.monitor_item').find('.transfer').removeClass('oculto-tranferir'),a('.monitor_item').removeClass('assigned'),a('.monitor_item').removeClass('not-assigned'),a('.monitor_item').addClass('not-assigned'),a('.student_item').removeClass('assigned'),a('.student_item').removeClass('not-assigned'),a('.student_item').addClass('not-assigned'),a('#student_assigned').text('No ha seleccionado un monitor.'),a('#student_assigned').addClass('items_assigned_empty'),a('#monitor_assigned').text('');for(var B=!1,C=0;C<A.length;C++)A[C].id_practicante==y?(B||(B=!0,a('#monitor_assigned').removeClass('items_assigned_empty')),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').removeClass('not-assigned'),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').addClass('assigned'),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').find('.add').addClass('oculto-asignar'),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').clone().appendTo('#monitor_assigned'),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').not('#monitor_assigned .monitor_item').addClass('oculto-asignado')):(a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').find('.add').addClass('oculto-asignar'),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').find('.delete').addClass('oculto-eliminar'),a('.monitor_item[data-id=\''+A[C].id_monitor+'\']').addClass('oculto-asignado'));a('#monitor_assigned').find('.monitor_item').find('.add').addClass('oculto-asignar'),a('#monitor_assigned').find('.monitor_item').find('.delete').removeClass('oculto-eliminar'),a('.monitor_item').not('#monitor_assigned .monitor_item').find('.transfer').addClass('oculto-tranferir'),B||(a('#monitor_assigned').addClass('items_assigned_empty'),a('#monitor_assigned').text('No tiene monitores asignados.'))}else console.log(z)},failure:function failure(z){console.log(z)}})}function w(){k=[];var x=a('#monitor_assignments_instance_id').data('instance-id');a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'get_practicants_monitors_and_students',params:[x,'2019A']}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(z){total=0,z.data_response.forEach(function(B){k[B.nombre_usuario_moodle__profesional]==void 0?k[B.nombre_usuario_moodle__profesional]=1:k[B.nombre_usuario_moodle__profesional]++,k[B.codigo_practicante]==void 0?k[B.codigo_practicante]=1:k[B.codigo_practicante]++,k[B.codigo_monitor]==void 0?k[B.codigo_monitor]=1:k[B.codigo_monitor]++,k.TODOS==void 0?k.TODOS=1:k.TODOS++}),a('.item-general-list').each(function(){var C=a(this).data('username');a(this).find('.item-text').find('.asignation_counter').text(k[C])}),a('.total_counter').text(k.TODOS);var A=a('#select-professional').find(':selected').attr('data-username');a('.asignation_counter_prof').text(k[A]),a('#select-professional').find('option').each(function(){var C=a(this).data('username'),D=a(this).data('fullname');a(this).text(D+' - ( '+k[C]+' )')})},failure:function failure(z){console.log(z)}})}a('#button-get-complete-report').click(function(){t(r(),s())});a('#student-name-filter').keyup(function(){a('.student_item').removeClass('oculto-filtro-nombre');var x=a(this).val();''==x?a(this).removeClass('filter-active'):(/\d/.test(x)?a('.student_item').not('.item-general-list.student_item[data-username*="'+x.toUpperCase()+'"]').addClass('oculto-filtro-nombre'):a('.student_item').not('.item-general-list.student_item[data-name*="'+x.toUpperCase()+'"]').addClass('oculto-filtro-nombre'),a(this).addClass('filter-active'))}),a('#monitor-name-filter').keyup(function(){a('.monitor_item').removeClass('oculto-filtro-nombre');var x=a(this).val();''==x?a(this).removeClass('filter-active'):(/\d/.test(x)?a('.monitor_item').not('.item-general-list.monitor_item[data-username*="'+x.toUpperCase()+'"]').addClass('oculto-filtro-nombre'):a('.monitor_item').not('.item-general-list.monitor_item[data-name*="'+x.toUpperCase()+'"]').addClass('oculto-filtro-nombre'),a(this).addClass('filter-active'))}),a('#btn-student-name-filter').click(function(){a('#student-name-filter').val(''),a('.student_item').removeClass('oculto-filtro-nombre'),a('#student-name-filter').removeClass('filter-active')}),a('#btn-monitor-name-filter').click(function(){a('#monitor-name-filter').val(''),a('.monitor_item').removeClass('oculto-filtro-nombre'),a('#monitor-name-filter').removeClass('filter-active')}),a(document).ready(function(){w(),a('select').trigger('change')}),a(document).on('click','.practicant_item',function(){v(a('#monitor_assignments_instance_id').data('instance-id'),a(this).attr('data-id'))}),a(document).on('click','.monitor_item',function(){u(a('#monitor_assignments_instance_id').data('instance-id'),a(this).attr('data-id'))}),a(document).on('click','.student_item',function(){var x=a(this).attr('data-id');a('.student_item').removeClass('active'),a(this).addClass('active'),a('.student_item[data-id=\''+x+'\']').addClass('active')}),a(document).on('click','.add',function(x){x.stopImmediatePropagation();var y=a(this),z=a('#monitor_assignments_instance_id').data('instance-id'),A=a(this).parent(),B=-1,C=A.attr('data-id'),D=A.attr('data-item'),E='';'student'==D?(E='create_monitor_student_relationship',B=a('.monitor_item.active').attr('data-id')):'monitor'==D&&(E='create_practicant_monitor_relationship',B=a('.practicant_item.active').attr('data-id')),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':E,params:[z,B,C]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(F){0===F.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Asignaci\xF3n registrada correctamente.',type:'success'},function(){'student'==D?(u(z,B),A.find('.add').addClass('oculto-asignar')):'monitor'==D&&(v(z,B),A.find('.add').addClass('oculto-asignar'))})},0):-5===F.status_code?'student'==D?setTimeout(function(){swal({title:'Informaci\xF3n',text:'La asignaci\xF3n ya existe en el periodo actual, si tiene problemas con esto, puede probar de nuevo recargando la pesta\xF1a.',type:'info'},function(){})},0):'monitor'==D&&setTimeout(function(){swal({title:'Informaci\xF3n',text:'Este monitor ya se encuentra asignado.',type:'info'},function(){})},0):setTimeout(function(){swal({title:'Error',text:'Reporte este error.',type:'error'},function(){})},0),w()},failure:function failure(F){console.log(F)}})}),a(document).on('click','.delete',function(x){x.stopImmediatePropagation();var y=a(this),z=a('#monitor_assignments_instance_id').data('instance-id'),A=a(this).parent(),B=-1,C=A.attr('data-id'),D=A.attr('data-item'),E='';'student'==D?(E='delete_monitor_student_relationship',B=a('.monitor_item.active').attr('data-id')):'monitor'==D&&(E='delete_practicant_monitor_relationship',B=a('.practicant_item.active').attr('data-id')),a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':E,params:[z,B,C]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(F){0===F.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Asignaci\xF3n eliminada correctamente',type:'success'},function(){'student'==D?(u(z,B),A.find('.add').removeClass('oculto-asignar')):'monitor'==D&&(v(z,B),A.find('.add').addClass('oculto-asignar'))})},0):1===F.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Est\xE1 intentando eliminar una asignaci\xF3n que ya no existe, si tiene problemas con esto, puede probar de nuevo recargando la pesta\xF1a.',type:'info'},function(){})},0):(setTimeout(function(){swal({title:'Error',text:'Reporte este error.',type:'error'},function(){})},0),console.log(F)),w()},failure:function failure(F){console.log(F)}})}),a(document).on('click','.transfer',function(x){x.stopImmediatePropagation();var y=a(this).parent().data('name'),z=a(this).parent().data('id');a('#modalTransfer').modal('show'),a('#old_monitor_name').text(y);var A='<option value="" disabled selected>Seleccione un monitor</option>\n';a('#monitor_assigned > .monitor_item').each(function(){var B=a(this).data('name'),C=a(this).data('id');A+='<option data-old="'+z+'" data-new="'+C+'">'+B+'</option>\n'}),a('#transfer-monitor-list').html(''),a('#transfer-monitor-list').append(A)}),a(document).on('click','#btn-execute-transfer',function(){a('#modalTransfer').modal('hide');var y=a('#monitor_assignments_instance_id').data('instance-id'),A=a('#transfer-monitor-list').find(':selected').data('old'),B=a('#transfer-monitor-list').find(':selected').data('new');a.ajax({type:'POST',url:'../managers/monitor_assignments/monitor_assignments_api.php',data:JSON.stringify({'function':'transfer',params:[y,A,B]}),contentType:'application/json; charset=utf-8',dataType:'json',success:function success(C){0===C.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'Estudiantes transferidos correctamente.',type:'success'},function(){u(y,B)})},0):1===C.status_code?setTimeout(function(){swal({title:'Informaci\xF3n',text:'El monitor no tiene estudiantes para transferir.',type:'info'},function(){})},0):(setTimeout(function(){swal({title:'Error',text:'Reporte este error.',type:'error'},function(){}),swal.close()},0),console.log(C)),w()},failure:function failure(C){console.log(C)}})}),a('select').change(function(){var x=a(this).attr('data-id').split('_')[0],y=a(this).attr('data-id').split('_')[1];if('monitor'==x&&'faculty'==y){var z=a(this).find(':selected').attr('data-id-facultad');'-1'==z?(a(this).removeClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-facultad')):(a(this).addClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-facultad'),a('.item-general-list.monitor_item').not('.item-general-list.monitor_item[data-id-facultad=\''+z+'\']').addClass('oculto-facultad'))}else if('monitor'==x&&'program'==y){var A=a(this).find(':selected').attr('data-cod-programa');'-1'==A?(a(this).removeClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-programa')):(a(this).addClass('filter-active'),a('.item-general-list.monitor_item').removeClass('oculto-programa'),a('.item-general-list.monitor_item').not('.item-general-list.monitor_item[data-cod-programa=\''+A+'\']').addClass('oculto-programa'))}else if('student'==x&&'faculty'==y){var z=a(this).find(':selected').attr('data-id-facultad');'-1'==z?(a(this).removeClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-facultad')):(a(this).addClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-facultad'),a('.item-general-list.student_item').not('.item-general-list.student_item[data-id-facultad=\''+z+'\']').addClass('oculto-facultad'))}else if('student'==x&&'program'==y){var A=a(this).find(':selected').attr('data-cod-programa');'-1'==A?(a(this).removeClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-programa')):(a(this).addClass('filter-active'),a('.item-general-list.student_item').removeClass('oculto-programa'),a('.item-general-list.student_item').not('.item-general-list.student_item[data-cod-programa=\''+A+'\']').addClass('oculto-programa'))}else if('professional'==x){var B=a(this).find(':selected').attr('data-id');'-1'==B?(a(this).removeClass('filter-active'),a('.item-general-list.practicant_item').removeClass('oculto-jefe')):(a(this).addClass('filter-active'),a('.item-general-list.practicant_item').removeClass('oculto-jefe'),a('.item-general-list.practicant_item').not('.item-general-list.practicant_item[data-id-jefe=\''+B+'\']').addClass('oculto-jefe'))}})}}});