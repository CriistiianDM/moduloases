define(["jquery","block_ases/bootstrap","block_ases/datatables","block_ases/sweetalert"],function(t,a,n,e){return{init:function(){var a=this;a.get_id_instance();a.load_attendance_list(),t("#button_add_v2_track").on("click",{object_function:a},a.add_new_groupal_tracking)},load_attendance_list:function(a,n,e){if(void 0==a)a=this.get_id_instance();void 0===n&&(n=null),void 0===e&&(e=null);var s=new Array;s.push({name:"function",value:"load_grupal"}),s.push({name:"idinstancia",value:a}),t.ajax({type:"POST",data:s,url:"../managers/user_management/usermanagement_report.php",success:function(a){if(t("#modal_v2_peer_tracking #list_students_attendance tbody").html(""),0!=a.rows){var e=a.content;if(n)for(x in e)-1!=n.indexOf(x)?t("#modal_v2_peer_tracking #list_students_attendance tbody").append(" <tr> <td>"+e[x].username+"</td> <td>"+e[x].firstname+"</td> <td>"+e[x].lastname+'</td>  <td><input type="checkbox" checked="checked" id="asistencia" name="asistencia"  value="'+e[x].idtalentos+'"/></td>  </tr>'):t("#modal_v2_peer_tracking #list_students_attendance tbody").append("<tr> <td>"+e[x].username+"</td> <td>"+e[x].firstname+"</td> <td>"+e[x].lastname+'</td>  <td><input type="checkbox" id="asistencia" name="asistencia" value="'+e[x].idtalentos+'"/></td>  </tr>');else for(x in e)t("#modal_v2_peer_tracking #list_students_attendance tbody").append("<tr> <td>"+e[x].username+"</td> <td>"+e[x].firstname+"</td> <td>"+e[x].lastname+'</td>  <td><input type="checkbox" id="asistencia" name="asistencia" value="'+e[x].idtalentos+'"/></td>  </tr>')}else t("#modal_v2_peer_tracking #list_students_attendance tbody").append("<a>No registra ningun estudiante a su cargo.Por favor dirigete a la oficina de Sistemas de talentos pilos para gestionar tu situación</a>");var s=t("#upd_seg").prop("name");t("#edit_seg").prop("name",s)},dataType:"json",cache:"false",error:function(t){alert("error al cargar listado de asistencia")}})},add_new_groupal_tracking:function(a){if(void 0==a)a=this.get_id_instance();t("#modal_v2_peer_tracking").fadeIn(300);var n=t("#current_user_id").val();t(".id_creado_por").find("input").val(n)},get_cohorts_without_assignment:function(a){if(void 0==a)a=this.get_id_instance();t.ajax({type:"POST",data:{function:"load_cohorts_without_assignment",instance:a},url:"../managers/instance_management/instance_configuration_serverproc.php",success:function(a){if(0==a.status)e("Error",a.msg,"error");else if(1==a.status){var n="",s=a.msg;0==s.length?n+="<option>No hay cohortes disponibles para asignar</option>":t.each(s,function(t){n+="<option value='"+s[t].id+"'>",n+=s[t].idnumber+" "+s[t].name+"</option>"}),t("#select_cohorts").html(n)}else{var o="Error al cargar las cohortes no asignadas. Por favor recargue la página.";e("Error",o+="Si el problema persiste contacte al área de sistemas.","error")}},dataType:"json",cache:!1,async:!1,error:function(){e("Error","Error al cargar las cohortes sin asignación","error")}})},load_cohorts_assigned:function(a){if(void 0==a)a=this.get_id_instance();t.ajax({type:"POST",data:{function:"load_cohorts",instance:a},url:"../managers/instance_management/instance_configuration_serverproc.php",success:function(a){if(0==a.status)t("#div_cohorts_table").html("<center><span>La instancia no tiene cohortes asignadas</span></center>");else{var n="";n+="<h4>Cohortes asignadas a la instancia</h4><hr/>",n+="<table id='cohorts_table' class='col-sm-12' style='width:100%'></table>",t("#div_cohorts_table").html(n),t("#cohorts_table").DataTable(a.msg)}},dataType:"json",cache:!1,async:!1,error:function(){e("Error","Error al cargar las cohortes asignadas","error")}})},unassign_cohort:function(a){var n=t(this).parent().siblings()[0].innerHTML,s=a.data.object_function.get_id_instance();t.ajax({type:"POST",data:{function:"unassign_cohort",instance_id:s,idnumber_cohort:n},url:"../managers/instance_management/instance_configuration_serverproc.php",success:function(t){1==t.status?e("Éxito",t.msg,"success"):e("Error",t.msg,"error")},error:function(t){e("Error","Error al conctarse con el servidor.","error")},dataType:"json",cache:!1,async:!1}),a.data.object_function.get_cohorts_without_assignment(),a.data.object_function.load_cohorts_assigned(),t("span.unassigned_cohort").on("click",{object_function:a.data.object_function},a.data.object_function.unassign_cohort)},get_id_instance:function(){var t=location.search.split("&");for(var a in t){if(t[a].indexOf("instanceid")>=0)return t[a].split("=")[1]}return 0},assign_cohort_instance:function(a){var n=t("#select_cohorts").val(),s=a.data.object_function.get_id_instance();t.ajax({type:"POST",data:{function:"insert_cohort",cohort:n,instance:s},url:"../managers/instance_management/instance_configuration_serverproc.php",success:function(n){if(0==n.status)var s="Error",o="error";else s="Éxito",o="success";e(s,n.msg,o),a.data.object_function.get_cohorts_without_assignment(),a.data.object_function.load_cohorts_assigned(),t("span.unassigned_cohort").on("click",{object_function:a.data.object_function},a.data.object_function.unassign_cohort)},dataType:"json",cache:!1,async:!1,error:function(){e("Error","Error al comunicarse con el servidor.","error")}})}}});