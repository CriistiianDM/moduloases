{"version":3,"sources":["../src/ases_incident_manager.js"],"names":["define","$","sweetalert","jqueryui","li","gmm","document","on","generate_modal","show_modal","detail","title","val","commentary","show","ajax","method","url","contentType","dataType","data","JSON","stringify","success","response","hide","status_code","swal","text","data_response","type","location","reload","error","XMLHttpRequest","textStatus","errorThrown","console","log","format_date","date","day","getDate","month_index","getMonth","year","getFullYear","hour","getHours","minutes","getMinutes","seconds","getSeconds","init","incident_id","load_incident","close_incident","async","url_base","comentarios","parse","opened_by","usuario_registra","closed_by","usuario_cierra","message","cerrada","datetime","Date","fecha_hora_registro","html","firstname","lastname","username","find","attr","id","showCancelButton","confirmButtonText","isConfirm"],"mappings":"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","sourcesContent":["// Standard license block omitted.\r\n/*\r\n * @package    block_ases\r\n * @copyright  ASES\r\n * @author     Jeison Cardona Gómez\r\n * @copyright  Jeison Cardona Gómez < jeison.cardona@correounivalle.edu.co >\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n \r\n /**\r\n  * @module block_ases/ases_incident_manager\r\n  */\r\n\r\n define(\r\n    [\r\n        'jquery', \r\n        'block_ases/sweetalert', \r\n        'block_ases/jqueryui',\r\n        'block_ases/loading_indicator',\r\n        'block_ases/_general_modal_manager'\r\n       ], \r\n        function($, sweetalert, jqueryui, li, gmm ) {\r\n\r\n            $(document).on( \"click\", \"#new-incident\", function(){\r\n\r\n                let div_incident_box = '\\\r\n                <div id=\"incident_box\" style=\"padding:1em; margin-bottom:1.2em;\" >\\\r\n                    <input id=\"new_inc_title\" class=\"form-control\" placeholder=\"Título corto\" type=\"text\">\\\r\n                    <textarea id=\"new_inc_detail\" class=\"form-control\" name=\"\" placeholder=\"Descripción detallada de la incidencia\" rows=\"5\"></textarea>\\\r\n                    <a id=\"new_inc_registrar\" class=\"btn btn-info\" style=\"float:right; margin-top:0.5em;\" href=\"javascript:void(0)\">Registrar</a>\\\r\n                </div>\\\r\n            ';\r\n\r\n                gmm.generate_modal(\r\n                    \"modal-new-incident\", \"Registro de incidencia interna\", div_incident_box, \"modal-body-new-incident\",\r\n                    function(){gmm.show_modal( \".modal-new-incident\", 300 )}\r\n                );\r\n            });\r\n\r\n            $(document).on(\"click\", \"#new_inc_registrar\", function(){\r\n\r\n                let system_info = \"<h1>Incidencia interna</h1>\";\r\n                let detail = {\r\n                    title:$(\"#new_inc_title\").val(),\r\n                    commentary:$(\"#new_inc_detail\").val()\r\n                };\r\n\r\n                if( (detail.title != \"\") && (detail.commentary != \"\") ){\r\n                    li.show();\r\n                    $.ajax({\r\n                        method: \"POST\",\r\n                        url: \"../managers/incident_manager/incident_api.php\",\r\n                        contentType: \"application/json\",\r\n                        dataType: \"json\",\r\n                        data: JSON.stringify({\"function\":\"create_incident\", \"params\":[ detail, system_info ]}) ,\r\n                        success: function( response ){\r\n                            li.hide();\r\n                            if( response.status_code === 0 ){\r\n                                swal(\r\n                                    {title:'Éxito',\r\n                                    text: 'Se ha registrado correctamente la incidencia, ticket #' + response.data_response,\r\n                                    type: 'success'},\r\n                                    function(){\r\n                                        location.reload();\r\n                                    }\r\n                                );\r\n                            }else{\r\n                                swal(\r\n                                    'Error!',\r\n                                    'Oops!: ' + response.data_response,\r\n                                    'error'\r\n                                );\r\n                            }\r\n                        },\r\n                        error: function( XMLHttpRequest, textStatus, errorThrown ) {\r\n                            li.hide();\r\n                            console.log( \"some error \" + textStatus + \" \" + errorThrown );\r\n                            console.log( XMLHttpRequest );\r\n                        }\r\n                    });\r\n                }else{\r\n                    swal(\r\n                        'Oops!',\r\n                        'Verifica que tanto el título como la descripción no estén vacíos.',\r\n                        'warning'\r\n                    );\r\n                }\r\n\r\n            });\r\n\r\n            function format_date(date) {\r\n                let month_names = [\r\n                  \"Enero\", \"Febrero\", \"Marzo\",\r\n                  \"Abril\", \"Mayo\", \"Junio\", \"Julio\",\r\n                  \"Agosto\", \"Septiembre\", \"Octubre\",\r\n                  \"Noviembre\", \"Diciembre\"\r\n                ];\r\n              \r\n                let day = date.getDate();\r\n                let month_index = date.getMonth();\r\n                let year = date.getFullYear();\r\n                let hour = date.getHours();\r\n                let minutes = date.getMinutes();\r\n                let seconds = date.getSeconds();\r\n              \r\n                return day + '-' + month_names[month_index] + '-' + year + ', ' + hour + \":\" + minutes + \":\" + seconds;\r\n            }\r\n   \r\n           console.log( \"ases_incident_manager loaded\" );\r\n\r\n           return {\r\n                init: function(){\r\n\r\n                    $(document).on( \"click\", \".inc_item\", function(){\r\n                            let incident_id = $(this).data(\"id\");\r\n                            load_incident( incident_id );\r\n                        }\r\n                    );\r\n\r\n                    $(document).on( \"click\", \"#close_incident\", function(){\r\n                            let incident_id = $(this).data(\"id\");\r\n                            close_incident( incident_id );\r\n                        }\r\n                    );\r\n\r\n                    function load_incident( incident_id ){\r\n                        li.show();\r\n                        $.ajax({\r\n                            method: \"POST\",\r\n                            url: \"../managers/incident_manager/incident_api.php\",\r\n                            contentType: \"application/json\",\r\n                            dataType: \"json\",\r\n                            data: JSON.stringify({\"function\":\"get_incident\", \"params\":[ incident_id ]}),\r\n                            async: false,\r\n                            success: function( response ){\r\n                                li.hide();\r\n\r\n                                let url_base = $(\"#extras\").data('url-base');\r\n\r\n                                let comentarios = JSON.parse(JSON.parse(response.data_response).comentarios);\r\n                                let opened_by = JSON.parse(response.data_response).usuario_registra;\r\n                                let closed_by = JSON.parse(response.data_response).usuario_cierra;\r\n                                let title = comentarios[0].message.title;\r\n                                let detail = comentarios[0].message.commentary;\r\n                                let cerrada = JSON.parse(response.data_response).cerrada;\r\n                                let datetime = format_date(new Date( JSON.parse(response.data_response).fecha_hora_registro * 1000));\r\n\r\n                                $(\".inc_detail\").html( \"<strong>Detalle: </strong>\" + detail );\r\n                                $(\".opened_by\").html( \"<strong>Abierta por:</strong> \" + opened_by.firstname + \" \" + opened_by.lastname + \" - \" + opened_by.username );\r\n                                $(\".inc_preview\").find(\"a\").attr( \"href\", \"ases_incidents_preview.php?incident_id=\" + incident_id );\r\n                                $(\".record_datetime\").html( \"<strong>Fecha y hora:</strong> \" + datetime );\r\n                                $(\"#close_incident\").attr(\"data-id\", incident_id);\r\n                                $(\".send_message\").html( '<strong>Mensajes: </strong> [ <a target=\"_blank\" rel=\"noopener noreferrer\" href=\"' + url_base + \"/message/index.php?id=\" + opened_by.id + '\">Ir al chat con el usuario</a> ].' );\r\n                                $(\".inc_preview\").show();\r\n\r\n                                if( cerrada != 1 ){\r\n                                    $(\".inc_title\").html( \"<h2>Ticket #\" + incident_id + \" - \" + title + \"</h2>\" );\r\n                                    $(\".inc_opc\").show();\r\n                                }else{\r\n                                    $(\".inc_opc\").hide();\r\n                                    $(\".inc_title\").html( \"<h2>Ticket #\" + incident_id + \" [Cerrada] - \" + title + \"</h2>\" );\r\n                                    $(\".closed_by\").html( \"<strong>Cerrada por:</strong> \" + closed_by.firstname + \" \" + closed_by.lastname );\r\n                                }\r\n                                \r\n                            },\r\n                            error: function( XMLHttpRequest, textStatus, errorThrown ) {\r\n                                li.hide();\r\n                                console.log( \"some error \" + textStatus + \" \" + errorThrown );\r\n                                console.log( XMLHttpRequest );\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    function close_incident(incident_id){\r\n\r\n                        swal({\r\n                            html:true,\r\n                            title: 'Confirmación',\r\n                            text: \"<strong>Nota importante!</strong>: Está cerrando una incidencia.\",\r\n                            type: 'warning',\r\n                            showCancelButton: true,\r\n                            confirmButtonText: 'Sí, cerrar!'\r\n                          }, function(isConfirm) {\r\n                            if (isConfirm) {\r\n                                li.show();\r\n                                $.ajax({\r\n                                    method: \"POST\",\r\n                                    url: \"../managers/incident_manager/incident_api.php\",\r\n                                    contentType: \"application/json\",\r\n                                    dataType: \"json\",\r\n                                    data: JSON.stringify({\"function\":\"close_logged_user_incident\", \"params\":[ incident_id ]}) ,\r\n                                    success: function( response ){\r\n                                        li.hide();\r\n                                        if( response.status_code === 0 ){\r\n                                            swal(\r\n                                                {title:'Éxito',\r\n                                                text: 'Se ha cerrado correctamente la incidencia',\r\n                                                type: 'success'},\r\n                                                function(){\r\n                                                    location.reload();\r\n                                                }\r\n                                            );\r\n                                        }else{\r\n                                            swal(\r\n                                                'Error!',\r\n                                                'Oops!: Al parece no existe la incidencia',\r\n                                                'error'\r\n                                            );\r\n                                        }\r\n                                    },\r\n                                    error: function( XMLHttpRequest, textStatus, errorThrown ) {\r\n                                        li.hide();\r\n                                        console.log( \"some error \" + textStatus + \" \" + errorThrown );\r\n                                        console.log( XMLHttpRequest );\r\n                                    }\r\n                                });\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                }\r\n           }\r\n       }\r\n);"],"file":"ases_incident_manager.min.js"}