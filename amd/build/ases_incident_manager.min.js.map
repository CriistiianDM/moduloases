{"version":3,"sources":["../src/ases_incident_manager.js"],"names":["define","$","sweetalert","jqueryui","li","gmm","document","on","generate_modal","show_modal","detail","title","val","commentary","show","ajax","method","url","contentType","dataType","data","JSON","stringify","success","response","hide","status_code","swal","text","data_response","type","location","reload","error","XMLHttpRequest","textStatus","errorThrown","console","log","format_date","date","day","getDate","month_index","getMonth","year","getFullYear","hour","getHours","minutes","getMinutes","seconds","getSeconds","init","incident_id","load_incident","close_incident","async","url_base","comentarios","parse","opened_by","usuario_registra","closed_by","usuario_cierra","message","cerrada","datetime","Date","fecha_hora_registro","html","firstname","lastname","username","find","attr","id","showCancelButton","confirmButtonText","isConfirm"],"mappings":"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","sourcesContent":["// Standard license block omitted.\n/*\n * @package    block_ases\n * @copyright  ASES\n * @author     Jeison Cardona Gómez\n * @copyright  Jeison Cardona Gómez < jeison.cardona@correounivalle.edu.co >\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n \n /**\n  * @module block_ases/ases_incident_manager\n  */\n\n define(\n    [\n        'jquery', \n        'block_ases/sweetalert', \n        'block_ases/jqueryui',\n        'block_ases/loading_indicator',\n        'block_ases/_general_modal_manager'\n       ], \n        function($, sweetalert, jqueryui, li, gmm ) {\n\n            $(document).on( \"click\", \"#new-incident\", function(){\n\n                let div_incident_box = '\\\n                <div id=\"incident_box\" style=\"padding:1em; margin-bottom:1.2em;\" >\\\n                    <input id=\"new_inc_title\" class=\"form-control\" placeholder=\"Título corto\" type=\"text\">\\\n                    <textarea id=\"new_inc_detail\" class=\"form-control\" name=\"\" placeholder=\"Descripción detallada de la incidencia\" rows=\"5\"></textarea>\\\n                    <a id=\"new_inc_registrar\" class=\"btn btn-info\" style=\"float:right; margin-top:0.5em;\" href=\"javascript:void(0)\">Registrar</a>\\\n                </div>\\\n            ';\n\n                gmm.generate_modal(\n                    \"modal-new-incident\", \"Registro de incidencia interna\", div_incident_box, \"modal-body-new-incident\",\n                    function(){gmm.show_modal( \".modal-new-incident\", 300 )}\n                );\n            });\n\n            $(document).on(\"click\", \"#new_inc_registrar\", function(){\n\n                let system_info = \"<h1>Incidencia interna</h1>\";\n                let detail = {\n                    title:$(\"#new_inc_title\").val(),\n                    commentary:$(\"#new_inc_detail\").val()\n                };\n\n                if( (detail.title != \"\") && (detail.commentary != \"\") ){\n                    li.show();\n                    $.ajax({\n                        method: \"POST\",\n                        url: \"../managers/incident_manager/incident_api.php\",\n                        contentType: \"application/json\",\n                        dataType: \"json\",\n                        data: JSON.stringify({\"function\":\"create_incident\", \"params\":[ detail, system_info ]}) ,\n                        success: function( response ){\n                            li.hide();\n                            if( response.status_code === 0 ){\n                                swal(\n                                    {title:'Éxito',\n                                    text: 'Se ha registrado correctamente la incidencia, ticket #' + response.data_response,\n                                    type: 'success'},\n                                    function(){\n                                        location.reload();\n                                    }\n                                );\n                            }else{\n                                swal(\n                                    'Error!',\n                                    'Oops!: ' + response.data_response,\n                                    'error'\n                                );\n                            }\n                        },\n                        error: function( XMLHttpRequest, textStatus, errorThrown ) {\n                            li.hide();\n                            console.log( \"some error \" + textStatus + \" \" + errorThrown );\n                            console.log( XMLHttpRequest );\n                        }\n                    });\n                }else{\n                    swal(\n                        'Oops!',\n                        'Verifica que tanto el título como la descripción no estén vacíos.',\n                        'warning'\n                    );\n                }\n\n            });\n\n            function format_date(date) {\n                let month_names = [\n                  \"Enero\", \"Febrero\", \"Marzo\",\n                  \"Abril\", \"Mayo\", \"Junio\", \"Julio\",\n                  \"Agosto\", \"Septiembre\", \"Octubre\",\n                  \"Noviembre\", \"Diciembre\"\n                ];\n              \n                let day = date.getDate();\n                let month_index = date.getMonth();\n                let year = date.getFullYear();\n                let hour = date.getHours();\n                let minutes = date.getMinutes();\n                let seconds = date.getSeconds();\n              \n                return day + '-' + month_names[month_index] + '-' + year + ', ' + hour + \":\" + minutes + \":\" + seconds;\n            }\n   \n           console.log( \"ases_incident_manager loaded\" );\n\n           return {\n                init: function(){\n\n                    $(document).on( \"click\", \".inc_item\", function(){\n                            let incident_id = $(this).data(\"id\");\n                            load_incident( incident_id );\n                        }\n                    );\n\n                    $(document).on( \"click\", \"#close_incident\", function(){\n                            let incident_id = $(this).data(\"id\");\n                            close_incident( incident_id );\n                        }\n                    );\n\n                    function load_incident( incident_id ){\n                        li.show();\n                        $.ajax({\n                            method: \"POST\",\n                            url: \"../managers/incident_manager/incident_api.php\",\n                            contentType: \"application/json\",\n                            dataType: \"json\",\n                            data: JSON.stringify({\"function\":\"get_incident\", \"params\":[ incident_id ]}),\n                            async: false,\n                            success: function( response ){\n                                li.hide();\n\n                                let url_base = $(\"#extras\").data('url-base');\n\n                                let comentarios = JSON.parse(JSON.parse(response.data_response).comentarios);\n                                let opened_by = JSON.parse(response.data_response).usuario_registra;\n                                let closed_by = JSON.parse(response.data_response).usuario_cierra;\n                                let title = comentarios[0].message.title;\n                                let detail = comentarios[0].message.commentary;\n                                let cerrada = JSON.parse(response.data_response).cerrada;\n                                let datetime = format_date(new Date( JSON.parse(response.data_response).fecha_hora_registro * 1000));\n\n                                $(\".inc_detail\").html( \"<strong>Detalle: </strong>\" + detail );\n                                $(\".opened_by\").html( \"<strong>Abierta por:</strong> \" + opened_by.firstname + \" \" + opened_by.lastname + \" - \" + opened_by.username );\n                                $(\".inc_preview\").find(\"a\").attr( \"href\", \"ases_incidents_preview.php?incident_id=\" + incident_id );\n                                $(\".record_datetime\").html( \"<strong>Fecha y hora:</strong> \" + datetime );\n                                $(\"#close_incident\").attr(\"data-id\", incident_id);\n                                $(\".send_message\").html( '<strong>Mensajes: </strong> [ <a target=\"_blank\" rel=\"noopener noreferrer\" href=\"' + url_base + \"/message/index.php?id=\" + opened_by.id + '\">Ir al chat con el usuario</a> ].' );\n                                $(\".inc_preview\").show();\n\n                                if( cerrada != 1 ){\n                                    $(\".inc_title\").html( \"<h2>Ticket #\" + incident_id + \" - \" + title + \"</h2>\" );\n                                    $(\".inc_opc\").show();\n                                }else{\n                                    $(\".inc_opc\").hide();\n                                    $(\".inc_title\").html( \"<h2>Ticket #\" + incident_id + \" [Cerrada] - \" + title + \"</h2>\" );\n                                    $(\".closed_by\").html( \"<strong>Cerrada por:</strong> \" + closed_by.firstname + \" \" + closed_by.lastname );\n                                }\n                                \n                            },\n                            error: function( XMLHttpRequest, textStatus, errorThrown ) {\n                                li.hide();\n                                console.log( \"some error \" + textStatus + \" \" + errorThrown );\n                                console.log( XMLHttpRequest );\n                            }\n                        });\n                    }\n\n                    function close_incident(incident_id){\n\n                        swal({\n                            html:true,\n                            title: 'Confirmación',\n                            text: \"<strong>Nota importante!</strong>: Está cerrando una incidencia.\",\n                            type: 'warning',\n                            showCancelButton: true,\n                            confirmButtonText: 'Sí, cerrar!'\n                          }, function(isConfirm) {\n                            if (isConfirm) {\n                                li.show();\n                                $.ajax({\n                                    method: \"POST\",\n                                    url: \"../managers/incident_manager/incident_api.php\",\n                                    contentType: \"application/json\",\n                                    dataType: \"json\",\n                                    data: JSON.stringify({\"function\":\"close_logged_user_incident\", \"params\":[ incident_id ]}) ,\n                                    success: function( response ){\n                                        li.hide();\n                                        if( response.status_code === 0 ){\n                                            swal(\n                                                {title:'Éxito',\n                                                text: 'Se ha cerrado correctamente la incidencia',\n                                                type: 'success'},\n                                                function(){\n                                                    location.reload();\n                                                }\n                                            );\n                                        }else{\n                                            swal(\n                                                'Error!',\n                                                'Oops!: Al parece no existe la incidencia',\n                                                'error'\n                                            );\n                                        }\n                                    },\n                                    error: function( XMLHttpRequest, textStatus, errorThrown ) {\n                                        li.hide();\n                                        console.log( \"some error \" + textStatus + \" \" + errorThrown );\n                                        console.log( XMLHttpRequest );\n                                    }\n                                });\n                            }\n                        });\n                    }\n\n                }\n           }\n       }\n);"],"file":"ases_incident_manager.min.js"}