define(["jquery","block_ases/jquery.dataTables","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print","block_ases/_general_modal_manager","block_ases/select2","block_ases/jqueryui","block_ases/loading_indicator","block_ases/sweetalert","extras","core/ajax"],function(a,e,t,r,o,n,i,s,c,l,d,m){const u=new URLSearchParams(window.location.search).get("monitoriaid");var p=!1;function g(e){a("#div_table").html(""),a("#div_table").fadeIn(500).append('<table id="tableResult" class="stripe row-border order-column" cellspacing="0" width="100%"><thead> </thead></table>'),a("#tableResult").DataTable(e)}function _(){p?a(".dt-button.buttons-print.eliminar").click(function(e){let t=a(e.target).parent().parent().parent().find("td")[0].innerHTML;swal({title:"Cancelar sesión",text:"¿Deseas cancelar la sesión programada el "+t+"?",type:"warning",showCancelButton:!0,confirmButtonText:"Eliminar"},function(t){t&&a.ajax({type:"POST",data:JSON.stringify({function:"eliminar_sesion",params:e.target.id}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(a){h(e),_()},error:function(a){swal("Error!",a,"error"),console.log(a)}})})}):a(".dt-button.buttons-print.eliminar").toggle(),a(".estudiantes").click(function(e){l.show();let t=a(e.target).parent().parent().parent().find("td")[0].innerHTML,r=`Asistentes inscritos a ${a("#nombre_monitoria").html()}, ${a("#horario_semanal").html()}, ${t}`,o={ordering:!1,columns:[{title:"Asiste?",name:"asistenciaCheck",data:"asistenciaCheck",width:"3%"},{title:"Código",name:"codigo",data:"codigo",width:"8%"},{title:"Nombres",name:"nombres",data:"nombres",width:"10%"},{title:"Apellidos",name:"apellidos",data:"apellidos",width:"10%"},{title:"Programa/Dependencia",name:"programa",data:"programa",width:"10%"},{title:"Categoría",name:"categoria",data:"categoria",width:"7%"},{title:"Correo electrónico",name:"correo",data:"correo",width:"13%"},{title:"Celular",name:"celular",data:"celular",width:"5%"},{title:"Asignatura a consultar",name:"asignatura",data:"asignatura",width:"17%"},{title:"Temática a consultar",name:"tematica",data:"tematica",width:"17%"}],autoWidth:!1,select:"false",fixedHeader:{header:!0,footer:!0},language:{search:"Buscar:",oPaginate:{sFirst:"Primero",sLast:"Último",sNext:"Siguiente",sPrevious:"Anterior"},sProcessing:"Procesando...",sLengthMenu:"Mostrar _MENU_ registros",sZeroRecords:"No se encontraron resultados",sEmptyTable:"Ningún dato disponible",sInfo:"Mostrando del _START_ al _END_ de _TOTAL_",sInfoEmpty:" 0 registros",sInfoFiltered:"(filtrado de un total de _MAX_ registros)",sInfoPostFix:"",sSearch:"Buscar:",sUrl:"",sInfoThousands:",",sLoadingRecords:"Cargando...",oAria:{sSortAscending:": Ordenar ascendente",sSortDescending:": Ordenar descendente"}},dom:"lifrtpB",buttons:[{extend:"print",text:"Imprimir",title:r},{extend:"csvHtml5",text:"CSV"},{extend:"excel",text:"Excel",className:"buttons-excel",filename:"Export excel",extension:".xls"}]};a.when(a.ajax({type:"POST",data:JSON.stringify({function:"cargar_asistentes_de_sesion",params:e.target.id}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",error:function(e){console.log("Error consulta BD asistentes monitorias academicas"),a("#debug").html(e.responseText)}})).done(e=>{e.data_response.forEach(a=>{a.asistenciaCheck=`<div style="vertical-align: middle;text-align: center;">${parseInt(a.asistencia)?'<span  class="glyphicon glyphicon-ok config-icon verde">':""}</div>`,a.asignatura+=" ("+(a.profesor.trim()||"PROF. NO ENCONTRADO")+")",a.correo=`<span style="word-break: break-all;">${a.correo}</span>`}),i.generate_modal("modal_estudiantes_inscritos",r,'<table id="asistentes_sesion" class="stripe row-border order-column" cellspacing="0" width="100%"><thead> </thead></table>',null,function(){o.data=e.data_response,a("#asistentes_sesion").DataTable(o),i.show_modal(".modal_estudiantes_inscritos"),l.hide()})})})}return{set_es_profesional:a=>p=a,init:function(){a.datepicker.setDefaults({closeText:"Cerrar",prevText:"&#x3C;Ant",nextText:"Sig&#x3E;",currentText:"Hoy",monthNames:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],monthNamesShort:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],dayNames:["domingo","lunes","martes","miércoles","jueves","viernes","sábado"],dayNamesShort:["dom","lun","mar","mié","jue","vie","sáb"],dayNamesMin:["D","L","M","X","J","V","S"],weekHeader:"Sm",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""}),a("#fecha_hasta").datepicker({showWeek:!0,dateFormat:"dd/M/y"}),a("#fecha_desde").datepicker({showWeek:!0,dateFormat:"dd/M/y"}),a("#fecha_desde").datepicker("setDate",new Date),a("#desplegar-filtrar").click(()=>{a("#flecha").toggleClass("abajo"),a("#rango-fechas-sesiones").toggle(300)}),a("#rango-fechas-sesiones").submit(h),a("#modificar_monitoria").click(this.mostrar_modificar_monitoria),a("#programar_sesiones").click(this.mostrar_programar_sesiones)},construir_tabla:g,init_despues_de_tabla:_,mostrar_modificar_monitoria:function(){a.when(a.ajax({url:"../templates/monitorias_academicas_anadir.mustache",data:null,dataType:"text",async:!0,success:function(a){let e=a;i.generate_modal("modal_fomulario_anadir","Modificar monitoría",e,null,function(){i.show_modal(".modal_fomulario_anadir")})},error:function(){console.log("../templates/monitorias_academicas_anadir.mustache cannot be reached.")}})).done(()=>{!function(){function e(e){if(e.hasOwnProperty("newTag")&&e.newTag)return a(`<span id="materia_nueva" class="opcion-select">${e.text}<span style="opacity:0.5;margin-left:1ch">(agregar)</span><div class="icono-agregar-materia"><span>`);var t=a(`<span id="materia_${e.id}" class="opcion-select">${e.text}<div class="boton-eliminar-materia"><span>`);return t}function t(e){return""===a.trim(e.term)||a.trim(e.term).length<3?null:{id:-1,text:e.term,newTag:!0}}a.ajax({type:"POST",data:JSON.stringify({function:"cargar_materias",params:[]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(r){var o=a.map(r.data_response,function(a){return{id:a.id,text:a.nombre}});a("#materia").select2({data:o,placeholder:"Seleccionar materia",templateResult:e,createTag:t,tags:!0,escapeMarkup:function(a){return a}}).on("select2:closing",function(e){var t=e.params.args.originalEvent;if(null!=t&&a(t.target).hasClass("boton-eliminar-materia")){var r=e.params.args.originalSelect2Event.data;e.preventDefault(),e.stopPropagation(),a.ajax({type:"POST",data:JSON.stringify({function:"eliminar_materia",params:[parseInt(r.id)]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){0==e.status_code?(a("#materia").find(`option[value=${r.id}]`)[0].remove(),a("#materia").trigger("change"),a(t.target).parent(".opcion-select").parent(".select2-results__option").hide()):swal("Error!","Oops!: "+e.error_response,"error")},error:function(e){console.log("Error eliminar bd de materia en backend"),a("#debug").html(e.responseText)}})}}).on("select2:opening",function(e){prevselection=a(e.target).find(":selected"),a("#materia").val(null)}).on("select2:select",function(e){var t=e.params.data;-1==t.id&&a.ajax({type:"POST",data:JSON.stringify({function:"anadir_materia",params:[t.text]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){if(0==e.status_code){a("#materia").find("option[value=-1]")[0].value=e.id;var r=new Option(t.text,e.id,!1,!0);a("#materia").append(r).trigger("change")}else swal("Error!","Oops!: "+e.data_response,"error")},error:function(e){console.log("Error insercion bd de materia en backend"),a("#debug").html(e.responseText)}})}),a("#materia").val(parseInt(a("#materia_id").html())).change()},error:function(a){console.log("Error consulta BD materias"),console.log(a)}})}(),a.ajax({type:"POST",data:JSON.stringify({function:"cargar_monitores",params:[m.getUrlParams(document.location.search).instanceid]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){var t=a.map(e.data_response,function(a){return{id:a.id,text:a.nombre+" "+a.apellido}});a("#monitor").select2({data:t,placeholder:"Seleccionar monitor"}),a("#monitor").val(parseInt(a("#monitor_id").html())).change()},error:function(e){console.log("Error consulta BD monitores"),a("#debug").html(e.responseText)}}),a("#cancel_monitoria_btn").click(()=>{a(".general_modal_close").first().click()}),a("#form_anadir").submit(function(e){e.preventDefault(),l.show();var t=a("#hora_inicio1 option:selected").text()+" "+a("#hora_inicio2 option:selected").text()+" - "+a("#hora_final1 option:selected").text()+" "+a("#hora_final2 option:selected").text(),r=a("#materia").find(":selected").first().val(),o=a("#monitor").find(":selected").first().val();a.ajax({type:"POST",data:JSON.stringify({function:"modificar_monitoria",params:[t,r,o,u]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){l.hide(),a(".general_modal_close").first().click(),0==e.status_code?swal({title:"Monitoria guardada",text:"Se ha modificado correctamente la monitoria",icon:"success"},function(a){location.reload()}):(swal("Error!","Oops!: "+e.data_response,"error"),console.log(e))},error:function(e){console.log("Error insercion bd de monitoria en backend"),a("#debug").html(e.responseText)}})}),a("#form_anadir input[name=fecha_hasta]")[0].required=!1,a("#seleccionar-fecha-anadir").hide(0),a("#input-programar-monitorias-checkbox").hide(0);var e=a("#hora").html().split(" ");a("#hora_inicio1").val(e[0]),a("#hora_inicio2").val(e[1]),a("#hora_final1").val(e[3]),a("#hora_final2").val(e[4]),a("select[name='dia']").val(parseInt(a("#dia").html())).change(),a("select[name='dia']").attr("disabled","disabled")})},mostrar_programar_sesiones:function(){a.when(a.ajax({url:"../templates/monitorias_academicas_programar.mustache",data:null,dataType:"text",async:!0,success:function(e){i.generate_modal("modal_fomulario_programar","Programar sesiones de monitoría",e,null,function(){i.show_modal(".modal_fomulario_programar")}),a(".modal_fomulario_programar").find(".general_modal_content").width("40%")},error:function(){console.log("../templates/monitorias_academicas_programar.mustache cannot be reached.")}})).done(()=>{a("#programar_desde").datepicker({minDate:0,showWeek:!0,dateFormat:"dd/M/y"}),a("#programar_hasta").datepicker({minDate:0,showWeek:!0,dateFormat:"dd/M/y"}),a("#form_programar").submit(function(e){l.show(),e.preventDefault();let t=a("#programar_desde").val();console.log(t);let r=a("#programar_hasta").val(),o=parseInt(a("#dia").html());swal({title:"¿Programar sesiones?",text:"Se programarán sesiones todos los "+["lunes","martes","miércoles","jueves","viernes","sábado","domingo"][o]+" desde "+t+" hasta "+r+".",type:"warning",showCancelButton:!0,confirmButtonText:"Programar"},function(e){e&&a.ajax({type:"POST",data:JSON.stringify({function:"programar_sesiones",params:[u,o,t,r]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(a){l.hide(),location.reload()},error:function(e){swal("Error!",e.responseText,"error"),a("#debug").html(e.responseText)}})})})})}};function f(a){function e(a){return a<10?"0"+a.toString():a.toString()}return parseInt(a.getFullYear().toString()+e(a.getMonth()+1)+e(a.getDate()))}function h(e=null){e&&e.preventDefault(),l.show();var t=f(e?a("#fecha_desde").datepicker("getDate"):new Date),r=f(e?a("#fecha_hasta").datepicker("getDate"):new Date(864e13));console.log(t.toString()+" "+r.toString()),a.ajax({type:"POST",data:JSON.stringify({function:"get_tabla_sesiones",params:[u,t,r]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(a){l.hide(),g(a.data_response),_()},error:function(e){console.log("Error consulta bd de sesiones en backend"),a("#debug").html(e.responseText)}})}}),define("extras",function(){return{getUrlParams:function(a){for(var e=[],t=a.substring(1).split("&"),r=0;r<t.length;r++){var o=t[r].split("=");e[o[0]]=o[1]}return e}}});