{"version":3,"sources":["../src/student_item_grades_report.js"],"names":["define","$","ajdt","notification","templates","init","document","ready","load_report","data","ResumeReport","est_items_perdidos","est_mas_items_perdidos_que_ganados","cantidad_estudiantes","return_total_report","resumeReport","length","_i","cantidad_items_perdidos","cantidad_items_ganados","on","table","DataTable","colIndex","cell","index","column","url","location","search","row","codigo","win","window","open","focus","html","instance_id","define_student_courses_detail_datatable","dataTable","bsort","paging","columns","title","name","description","searching","language","common_lang_config","order","get_filter_column_indexes","filter_column_names","column_names","filter_column_indexes","i","includes","push","add_column_description","each","attr","get_student_item_grades_explicit","tr","student_id","mdl_user_id","ajax","method","done","child","show","fail","err","removeClass","console","log","add_extra_course_info_controls","closest","isShown","hide","callback","addClass","dataType","render","resume_report","then","js","appendNodeContents","initComplete","map","error"],"mappings":"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","sourcesContent":["/**\n * Student item grades report\n * @module amd/src/course_and_techar_report\n * @author Luis Gerardo Manrique Cardona\n * @copyright 2018 Luis Gerardo Manrique Cardona <luis.manrique@correounivalle.edu.co>\n * @license  http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @see https://datatables.net/examples/api/multi_filter_select.html\n */\ndefine([\n    'jquery',\n    'block_ases/ases_jquery_datatable',\n    'core/notification',\n    'core/templates',\n    'block_ases/jquery.dataTables'\n], function($, ajdt, notification, templates, ){\n\n    return {\n        init: function () {\n            $(document).ready(function () {\n\n            });\n        },\n\n        load_report: function (data) {\n            /**\n             * Class Resume Report\n             * @param est_items_perdidos number  Cantidad de estudiantes con uno o más items perdidos\n             * @param est_mas_items_perdidos_que_ganados number Estudiantes con más items perdidos que ganados\n             * @param cantidad_estudiantes number Cantidad de estudiantes\n             *  que ganados con respecto al total de estudiantes\n             * @constructor\n             */\n            var ResumeReport = /* @class */  (function() {\n                function ResumeReport(est_items_perdidos, est_mas_items_perdidos_que_ganados, cantidad_estudiantes) {\n                    this.est_items_perdidos = est_items_perdidos? est_items_perdidos: 0;\n                    this.cantidad_estudiantes = cantidad_estudiantes? cantidad_estudiantes: 0;\n                    this.est_mas_items_perdidos_que_ganados =\n                        est_mas_items_perdidos_que_ganados? est_mas_items_perdidos_que_ganados : 0;\n                }\n\n                /**\n                 * Return the total resume report from data given\n                 * @param data array Data instances\n                 * @returns {ResumeReport}\n                 */\n                ResumeReport.return_total_report = function(data) {\n                    var resumeReport = new ResumeReport();\n                    resumeReport.cantidad_estudiantes = data.length;\n                    for( var _i = 0, data_1 = data; _i < data_1.length; _i++) {\n                        if(data[_i].cantidad_items_perdidos>=1) {\n                            resumeReport.est_items_perdidos++;\n                        }\n                        if(data[_i].cantidad_items_perdidos > data[_i].cantidad_items_ganados) {\n                            resumeReport.est_mas_items_perdidos_que_ganados++;\n                        }\n                    }\n                    return resumeReport;\n                };\n                return ResumeReport;\n            }());\n            /** go to ficha general on click **/\n            $(document).on('click', '#tableStudentItemGradesReport tbody tr td', function () {\n                var pagina = \"student_profile.php\";\n                var table = $(\"#tableStudentItemGradesReport\").DataTable();\n                var colIndex = table.cell(this).index().column;\n                /* Las columnas (de la 1 a la 4 -- index desde 0) son: numero documento, codigo,\n                 apellidos y nombre son links a la ficha estudiante*/\n                if (colIndex>=1 && colIndex <=4 ) {\n                    var url = pagina + location.search + \"&student_code=\" + table.cell(table.row(this).index(), 0).data().codigo;\n                    var win = window.open(url, '_blank');\n                    win.focus();\n                }\n            });\n\n            var table_id = '#tableStudentItemGradesReport';\n            $(table_id).html('<img class=\"icon-loading\" src=\"../icon/loading.gif\"/>'); // loader image\n            var filter_columns = null;\n            var instance_id = data.instance_id;\n            var table = null;\n            /**\n             * Data: {\n             *     instance_id\n             * }\n             *\n             * DataTable:\n             * {\n             *     bsort,\n             *     columns,\n             *     data,\n             *     language,\n             *     order\n             * }\n             * DataTable.data[]:\n             * {\n             *     num_doc,\n             *     lastname,\n             *     firstname,\n             *     mdl_user_id,\n             *     cantidad_items_ganados,\n             *     codigo,\n             *     cantidad_items_perdidos\n             * }\n             *\n             *\n             */\n            function define_student_courses_detail_datatable(data) {\n                var columns = [\n                    {\n                    title: 'Código',\n                    name: 'codigo_asignatura',\n                    data: 'codigo_asignatura',\n                    description: 'Identificador de la asignatura en formato Sede-Codigo-Grupo'\n                    }  ,\n                    {\n                        title: 'Nombre Asignatura',\n                        name: 'nombre_asignatura',\n                        data: 'nombre_asignatura',\n                        description: 'Nombre completo de la asignatura'\n                    },\n                    {\n                        title: 'Profesor',\n                        name: 'nombre_profesor',\n                        data: 'nombre_profesor',\n                        description: 'Nombre completo de el profesor'\n                    },\n                    {\n                        title: 'Notas',\n                        name: 'notas',\n                        data: 'notas',\n                        description: 'Identificador de la asignatura en formato Sede-Codigo-Grupo'\n                    },\n                    {\n                        title: 'Nota Final',\n                        name: 'nota_final',\n                        data: 'nota_final',\n                        description: 'Nota final de la asignatura calculada con las categorias de notas terminadas'\n                    }\n\n                ];\n                var dataTable = {\n                    data: data,\n                    bsort: 0,\n                    paging: false,\n                    columns: columns,\n                    searching: false,\n                    language: ajdt.common_lang_config(),\n                    order: 0\n                };\n                return dataTable;\n            }\n\n            function get_filter_column_indexes(filter_column_names, column_names) {\n                var filter_column_indexes = [];\n                var i;\n                for(i = 0; i < column_names.length; i++) {\n                    if(filter_column_names.includes(column_names[i])) {\n                        filter_column_indexes.push(i);\n                    }\n\n                }\n                return filter_column_indexes;\n            }\n            function add_column_description(columns) {\n                // Añadir descripción a las columnas\n                $(table_id +' th').each(function(index) {\n                    $(this).attr('title', columns[index].description);\n                });\n            }\n\n            function get_student_item_grades_explicit(row, tr) {\n                var data = row.data();\n                var student_id = data.mdl_user_id;\n                var url =  '../managers/student_grades/student_item_grades_report_api.php/student_grades/item_summary/' + student_id;\n                $.ajax({\n                    method: 'get',\n                    url: url\n                }).done(function(data) {\n                    var dataTable = define_student_courses_detail_datatable(data);\n\n                    row.child('<table align=\"center\" id=\"student_item_grades_explicit'+student_id+'\"></table>').show();\n                    $(\"#student_item_grades_explicit\"+student_id).DataTable(dataTable);\n                    }\n\n                ).fail(function(err) {\n                    tr.removeClass('shown');\n                    console.log(err);\n                });\n            }\n            /**\n             * Add the controls for extra info in each course, than display the specific student notes\n             * when the user open the view in the first column buttons\n             */\n            function add_extra_course_info_controls() {\n                $(table_id + ' tbody').on('click', 'td.details-control', function () {\n\n                    var tr = $(this).closest('tr');\n                    var row = table.row(tr);\n\n                    if (row.child.isShown()) {\n                        // This row is already open - close it\n                        row.child.hide();\n                        tr.removeClass('shown');\n                    }\n                    else {\n                        // Open this row\n                        row.child('<img class=\"icon-loading\" src=\"../icon/loading.gif\"/>').show(); // loader image (is replaced when the data arrive)\n                        callback = (html, row) => {\n                            row.child(html).show();\n                        };\n                        get_student_item_grades_explicit(row, tr);\n                        tr.addClass('shown');\n                    }\n                });\n            }\n            function init_datatable () {\n                $.ajax({\n                    method: \"GET\",\n                    url: '../managers/student_grades/student_item_grades_report_api.php/' + instance_id,\n                    dataType: 'json'\n\n                }).done(\n                    function(dataTable) {\n                        $(table_id).html(''); // remove loading image gift\n                        var resumeReport = ResumeReport.return_total_report(dataTable.data);\n                        templates.render('block_ases/student_item_grades_report_summary', {resume_report: resumeReport})\n                            .then(function(html, js) {\n                                templates.appendNodeContents('.student_item_grades_report .summary', html, js);\n                            }).fail(function(ex) {\n                        });\n                        console.log(resumeReport);\n                        table = $(table_id).DataTable(\n                            {\n                                data: dataTable.data,\n                                bsort: dataTable.bsort,\n\n                                columns: dataTable.columns,\n                                language: dataTable.language,\n                                order: dataTable.order,\n                                initComplete: function () {\n\n\n                                    if (!filter_columns || filter_columns.length==0) {\n                                        return;\n                                    }\n                                    var column_names = dataTable.columns.map(column => column.name ? column.name : null);\n                                    var filter_column_indexes = get_filter_column_indexes(filter_columns, column_names);\n                                    this.api().columns(filter_column_indexes).every(function () {\n                                        var column = this;\n\n\n                                        var select = $('<select><option value=\"\"></option></select>')\n                                            .appendTo($(column.header()))\n                                            .on('change', function () {\n                                                var val = $.fn.dataTable.util.escapeRegex(\n                                                    $(this).val()\n                                                );\n\n                                                column\n                                                    .search(val ? '^' + val + '$' : '', true, false)\n                                                    .draw();\n                                            });\n\n                                        column.data().unique().sort().each(function (d, j) {\n                                            select.append('<option value=\"' + d + '\">' + d + '</option>');\n                                        });\n                                    });\n                                }\n                            }\n                        );\n                        add_column_description(dataTable.columns);\n                        add_extra_course_info_controls();\n                    }\n\n                ).fail(\n                    function(error) {\n                        console.log(error);\n                    }\n                );\n\n            }\n            init_datatable();\n\n\n\n        }\n\n    };\n\n});"],"file":"student_item_grades_report.min.js"}