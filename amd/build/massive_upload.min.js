'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};define(['jquery','core/notification','core/templates','block_ases/ases_jquery_datatable','block_ases/jquery.dataTables','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c,d){function l(x,y){var z=x.column(y);return z.name}function m(x,y){for(var z=x.rows().data(),A=[],B=[],C=0;C<z.length;C++)A.push(z[C]);return A.forEach(function(D){var E={};y.forEach(function(F){E[F]=D[F]}),B.push(E)}),B}var n=0,o=function(){return a('#cohorts').val()},p=function(){return a('#endpoints').val()},q=function(){a('#user-notifications .alert-error').remove()},r=function(x,y){'SI'===y.error&&(a(x).addClass('error'),y.errors&&Object.keys(y.errors).forEach(function(z){a('td.'+z,x).addClass('error'),console.log(y.errors);var A=y.errors[z].map(function(C){return C.error_message}),B=A.join('; ');a('td.'+z,x).prop('title',B)}))},s=function(){return'receive_csv.php/'+p()+'/'+o()+'/'+n},t=function(){a.fn.DataTable.isDataTable('#example')&&a('#example').DataTable().destroy()},u=function(x){var y=[];return Object.keys(x).forEach(function(z){y=y.concat(x[z])}),y},v=function(){function x(y,z,A,B,C,D,E){this.data=y,this.object_errors=z?z:[],this.object_warnings=A?A:[],this.success_logs_events=B?B:[],this.error=D,this.initial_object_properties=E?E:[]}return x.prototype.get_messages=function(){for(var y=[],z=0;z<this.data.length;z++)(this.object_errors[z]&&'object'===_typeof(this.object_errors[z])&&this.object_errors[z].constructor!==Array||this.object_warnings[z]&&0<this.object_warnings[z].length||this.success_logs_events[z]&&0<this.success_logs_events[z].length)&&y.push(new w(z+1,this.object_errors[z],this.object_warnings[z],this.success_logs_events[z]));return y},x.get_from_response=function(y){return new x(y.data,y.object_errors,y.warnings,y.success_logs,y.jquery_datatable,y.error,y.initial_object_properties)},x}(),w=function(){return function(y,z,A,B){this.index=y,this.errors=z?u(z):[],this.warnings=A?A:[],this.success_logs=B?B:[]}}();return{init:function init(x){function y(B,C){if(z=a('#example').DataTable(B),C.data_response&&C.data_response.object_properties&&C.data_response.file_headers){var D=C.data_response.object_properties,E=C.data_response.file_headers;console.log(C);var F=D.filter(function(H){return 0>E.indexOf(H)}),G=E.filter(function(H){return-1>=D.indexOf(H)});F.forEach(function(H){a('.'+H).css('background-color','#cccccc')}),G.forEach(function(H){a('.'+H).css('background-color','red')}),console.log(G,F)}}n=x.instance_id;var z=null,A=null;a('#print-data').click(function(){console.log(m(z,A)),console.log(l(z,'error'))}),a('#send-data').click(function(){var B=m(z,A);console.log(B),a.ajax({url:s(),data:{data:B},type:'POST',success:function success(C){console.log(C)}}).done(function(C){console&&console.log&&(console.log(C),console.log('La solicitud se ha completado correctamente.'))}).fail(function(C,D){console&&console.log&&(console.log('La solicitud a fallado: '+D),console.log(C))})}),a('#send-file').click(function(){var B=new FormData(a(this).closest('form').get(0));t(),a.ajax({url:s(),data:B,cache:!1,contentType:!1,dataType:'html',processData:!1,type:'POST',error:function error(C){z&&z.destroy(),console.log(C),q();var D=JSON.parse(C.responseText);console.log(D);var E=D.datatable_preview;if(D.object_errors&&D.object_errors.generic_errors){var F=D.object_errors.generic_errors.map(function(G){return G.error_message});y(E,D.object_errors.generic_errors[0]),F.forEach(function(G){b.addNotification({message:G,type:'error'})})}},success:function success(C){console.log(C),z&&z.destroy(),C=JSON.parse(C),console.log(C),A=C.initial_object_properties;var D=v.get_from_response(C),E=D.object_errors,F=C.jquery_datatable,G=D.get_messages();if(a('#messages_area').html(''),c.render('block_ases/massive_upload_messages',{data:G}).then(function(K,L){c.appendNodeContents('#messages_area',K,L)}),Object.keys(E).forEach(function(K){F.data[K].errors=E[K]}),F.data.forEach(function(K,L){K.index=L+1}),F.data.forEach(function(K,L){K.error=E[L]&&(0<E[L].length||E[L].constructor===Object)?'SI':'NO'}),F.columns.unshift({name:'index',data:'index',title:'Linea'}),F.columns.push({name:'error',title:'Error',data:'error'}),F.rowCallback=r,F.initComplete=d.add_column_filters(['error:name']),0===C.errors.length)z=a('#example').DataTable(F);else{var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var J,H,I=C.errors[Symbol.iterator]();!(_iteratorNormalCompletion=(J=I.next()).done);_iteratorNormalCompletion=!0)H=J.value,console.log(H)}catch(K){_didIteratorError=!0,_iteratorError=K}finally{try{!_iteratorNormalCompletion&&I.return&&I.return()}finally{if(_didIteratorError)throw _iteratorError}}}}})})}}});