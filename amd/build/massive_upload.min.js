'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};define(['jquery','core/notification','core/templates','block_ases/ases_jquery_datatable','core/config','block_ases/jquery.dataTables','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c,d,e){var o=0,p=function(){return a('#cohorts').val()},q=function(){return a('#endpoints').val()},r=function(){a('#user-notifications .alert-error').remove()},s=function(A,B){'SI'===B.error&&(a(A).addClass('error'),B.errors&&Object.keys(B.errors).forEach(function(C){a('td.'+C,A).addClass('error'),console.log(B.errors);var D=B.errors[C].map(function(F){return F.error_message}),E=D.join('; ');a('td.'+C,A).prop('title',E)}))},t=function(){return e.wwwroot+'/blocks/ases/managers/mass_management/mass_upload_api.php/'+q()+'/'+p()+'/'+o},u=function(){a.fn.DataTable.isDataTable('#example')&&a('#example').DataTable().destroy()},v=function(A){var B=[];return Object.keys(A).forEach(function(C){B=B.concat(A[C])}),B},w=function(){function A(B,C,D,E,F,G,H){this.data=B,this.object_errors=C?C:[],this.object_warnings=D?D:[],this.jquery_datatable=F?F:{},this.success_logs_events=E?E:[],this.error=G,this.initial_object_properties=H?H:[]}return A.prototype.get_messages=function(){console.log(this);for(var B=[],C=0;C<this.data.length;C++)(this.object_errors[C]&&'object'===_typeof(this.object_errors[C])&&this.object_errors[C].constructor!==Array||this.object_warnings[C]&&0<this.object_warnings[C].length||this.success_logs_events[C]&&0<this.success_logs_events[C].length)&&B.push(new z(C+1,this.object_errors[C],this.object_warnings[C],this.success_logs_events[C]));return B},A.get_from_response=function(B){var C=JSON.parse(B);return new A(C.data,C.object_errors,C.object_warnings,C.success_log_events,C.jquery_datatable,C.error,C.initial_object_properties)},A}(),x=function(A,B){if(a('#example').DataTable(A),B.data_response&&B.data_response.object_properties&&B.data_response.file_headers){var C=B.data_response.object_properties,D=B.data_response.file_headers;console.log(B);var E=C.filter(function(G){return 0>D.indexOf(G)}),F=D.filter(function(G){return-1>=C.indexOf(G)});E.forEach(function(G){a('.'+G).css('background-color','#cccccc')}),F.forEach(function(G){a('.'+G).css('background-color','red')}),console.log(F,E)}},y=function(A){a('#example').DataTable(A)},z=function(){return function(B,C,D,E){this.index=B,this.errors=C?v(C):[],this.warnings=D?D:[],this.success_logs=E?E:[]}}();return{init:function init(A){o=A.instance_id,a('#send-file').click(function(){var B=new FormData(a(this).closest('form').get(0));u(),a.ajax({url:t(),data:B,cache:!1,contentType:!1,dataType:'html',processData:!1,type:'POST'}).then(function(C){r();var D=w.get_from_response(C),E=D.object_errors,F=D.jquery_datatable,G=D.get_messages();console.log(G,'mesasges'),c.render('block_ases/massive_upload_messages',{data:G}).then(function(H,I){c.appendNodeContents('#messages_area',H,I)}),Object.keys(E).forEach(function(H){F.data[H].errors=E[H]}),F.data.forEach(function(H,I){H.index=I+1}),F.data.forEach(function(H,I){H.error=E[I]&&(0<E[I].length||E[I].constructor===Object)?'SI':'NO'}),F.columns.unshift({name:'index',data:'index',title:'Linea'}),F.columns.push({name:'error',title:'Error',data:'error'}),F.rowCallback=s,F.initComplete=d.add_column_filters(['error:name']),D.error||y(F)}).catch(function(C){u(),console.log(C),r();var D=JSON.parse(C.responseText);console.log(D);var E=D.datatable_preview;if(D.object_errors&&D.object_errors.generic_errors){var F=D.object_errors.generic_errors.map(function(G){return G.error_message});x(E,D.object_errors.generic_errors[0]),F.forEach(function(G){b.addNotification({message:G,type:'error'})})}})})}}});