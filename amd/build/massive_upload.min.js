function _typeof(a){if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("block_ases/massive_upload",["jquery","core/notification","core/templates","block_ases/ases_jquery_datatable","core/config","block_ases/sweetalert","block_ases/loading_indicator","block_ases/jquery.dataTables","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print"],function(a,b,c,d,e,f,g){var h=0,i="continue-button";var j=function(){return a("#cohorts").val()},k=function(){return a("#endpoints").val()},l=function(){a("#user-notifications .alert-error").remove()},m=function(a,b,c){return a.replace(new RegExp(b,"g"),c)},n=/[ -() \[\].]/,o=function(){a("body,html").animate({scrollTop:0},500)},p=function(b,c){if("SI"===c.error){a(b).addClass("error");if(c.errors){Object.keys(c.errors).forEach(function(d){a("td."+d,b).addClass("error");console.log(c.errors);var e=c.errors[d].map(function(a){return a.error_message}),f=e.join("; ");a("td."+d,b).prop("title",f)})}}},q=function(b){b.destroy=!0;b.autoWidth=!1;var c=a("#example");if(a.fn.dataTable.isDataTable("#example")){c.DataTable().destroy()}c.DataTable(b)},r=function(a){return e.wwwroot+"/blocks/ases/managers/mass_management/mass_upload_api.php/"+k()+"/"+j()+"/"+h+"/"+a},s=function(){if(a.fn.DataTable.isDataTable("#example")){a("#example").DataTable().destroy()}};var t=function(){a("#messages_area").html("")},u=function(a){var b=[];Object.keys(a).forEach(function(c){b=b.concat(a[c])});return b},v=function(){a("select").prop("disabled",!1)},w=function(){function a(a,b,c,d,e,f,g){this.data=a;this.object_errors=b?b:[];this.object_warnings=c?c:[];this.jquery_datatable=e?e:{};this.success_logs_events=d?d:[];this.error=f;this.initial_object_properties=g?g:[]}a.prototype.get_messages=function(){console.log(this);for(var a=[],b=0;b<this.data.length;b++){if(this.object_errors[b]&&"object"===_typeof(this.object_errors[b])&&this.object_errors[b].constructor!==Array||this.object_warnings[b]&&0<this.object_warnings[b].length||this.success_logs_events[b]&&0<this.success_logs_events[b].length){a.push(new H(b+1,this.object_errors[b],this.object_warnings[b],this.success_logs_events[b]))}}return a};a.get_from_response=function(b){var c=JSON.parse(b);return new a(c.data,c.object_errors,c.object_warnings,c.success_log_events,c.jquery_datatable,c.error,c.initial_object_properties)};return a}(),x=function(b,c){b.dom="Bfrtip";q(b);if(c.data_response&&c.data_response.object_properties&&c.data_response.file_headers){var d=c.data_response.object_properties,e=c.data_response.file_headers,f=[];f=f.concat(d.filter(function(a){return 0>e.indexOf(a)}));var g=[];g=g.concat(e.filter(function(a){return-1>=d.indexOf(a)}));if(0<f.length){f.forEach(function(b){a("."+b).css("background-color","#cccccc").attr("title","Columna faltante");console.log(b)})}if(0<g.length){g.forEach(function(b){console.log(b);a("."+b).css("background-color","red").attr("title","Columna sobrante")})}}},y=function(){return a("#send-file")},z=function(){return new FormData(a("#form-send-file").get(0))},A=function(b){var c=r(b),d=z();g.show();return a.ajax({url:c,data:d,cache:!1,contentType:!1,dataType:"html",processData:!1,type:"POST"}).then(function(a){g.hide();return a}).catch(function(a){g.hide();o();f({title:"Ocurrio un error",text:"En la secci\xF3n de notificaciones se muestra la lista de errores, adicionalmente en la consolase muestra informaci\xF3n detallada de los errores y su contexto",type:"error",closeOnConfirm:!0,confirmButtonText:"Aceptar"});return a})},B=function(){a("#"+i).remove()},C=function(){var a=y();return a.clone(!0).off().attr("id",i).html("Almacenar informaci\xF3n").attr("title","Guardar informaci\xF3n de forma persistente en la base de datos").appendTo("#buttons-section")},D=function(){f({title:"Confirmaci\xF3n de guardado",text:"Una vez acepte almacenar la informaci\xF3n, todo lo que se ha mostrado que se guardarava a ser almacenado en la base de datos y no habr\xE1 forma de volver a un estado anterior.Si da click en cancelar la base de datos no sufrira ningun cambio.",type:"warning",closeOnConfirm:!0,closeOnCancel:!0,showCancelButton:!0,confirmButtonText:"Almacenar informaci\xF3n?"},function(a){if(a){B();F(!0).then(function(){f({title:"La informaci\xF3n se ha guardado correctamente",text:"",type:"success",closeOnConfirm:!0,closeOnCancel:!0,showCancelButton:!1,confirmButtonText:"Vale"});v()})}})},E=function(){C().html("Nada para guardar").attr("disabled",!0)},F=function(a){s();return A(a).then(function(b){console.log(b,"response");l();s();t();var e=w.get_from_response(b),f=e.object_errors,g=e.jquery_datatable,h=e.get_messages();c.render("block_ases/massive_upload_messages",{data:h}).then(function(a,b){c.appendNodeContents("#messages_area",a,b)});Object.keys(f).forEach(function(a){g.data[a].errors=f[a]});g.data.forEach(function(a,b){a.index=b+1});g.data.forEach(function(a,b){if(f[b]&&(0<f[b].length||f[b].constructor===Object)){a.error="SI"}else{a.error="NO"}});g.columns.unshift({name:"index",data:"index",title:"Linea"});g.columns.push({name:"error",title:"Error",data:"error"});g.rowCallback=p;g.initComplete=d.add_column_filters(["error:name"]);q(g);console.log(a,"continue antes de a\xF1adir el boton continue");if(!e.error&&!a){if(0===e.success_logs_events.length){E()}else{C().click(D)}}}).catch(function(a){l();s();t();var c=JSON.parse(a.responseText);console.log(c,"error object at catch send file");var d=c.datatable_preview;if(c.object_errors&&c.object_errors.generic_errors){var e=c.object_errors.generic_errors.map(function(a){return a.error_message});x(d,c.object_errors.generic_errors[0]);e.forEach(function(a){console.log(a);b.addNotification({message:a,type:"error"})})}})},G=function(){return F(!1)},H=function(){return function(a,b,c,d){this.index=a;this.errors=b?u(b):[];this.warnings=c?c:[];this.success_logs=d?d:[]}}(),I=function(){a("#user-notifications").prependTo(a(".massive_upload"))};return{init:function init(b){a("select").change(function(){B()});h=b.instance_id;a("#send-file").click(function(){B();G().catch(function(){v()})});I()}}});
//# sourceMappingURL=massive_upload.min.js.map
