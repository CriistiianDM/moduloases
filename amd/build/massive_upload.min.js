define(["jquery","core/notification","core/templates","block_ases/ases_jquery_datatable","core/config","block_ases/sweetalert","block_ases/loading_indicator","block_ases/jquery.dataTables","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print"],function(e,t,r,a,o,s,n,c,i,l,d,u,_){var f=0;var h=function(){e("#user-notifications .alert-error").remove()},b=function(t,r){"SI"===r.error&&(e(t).addClass("error"),r.errors&&Object.keys(r.errors).forEach(a=>{e("td."+a,t).addClass("error"),console.log(r.errors);var o=r.errors[a].map(e=>e.error_message).join("; ");e("td."+a,t).prop("title",o)}))},m=function(t){t.destroy=!0,t.autoWidth=!1;var r=e("#example");e.fn.dataTable.isDataTable("#example")&&r.DataTable().destroy(),r.DataTable(t)},p=function(t){return o.wwwroot+"/blocks/ases/managers/mass_management/mass_upload_api.php/"+e("#endpoints").val()+"/"+e("#cohorts").val()+"/"+f+"/"+t},g=()=>{e.fn.DataTable.isDataTable("#example")&&e("#example").DataTable().destroy()};var j=function(){e("#messages_area").html("")},v=e=>{var t=[];return Object.keys(e).forEach(r=>{t=t.concat(e[r])}),t},y=function(){e("select").prop("disabled",!1)},k=function(){function e(e,t,r,a,o,s,n){this.data=e,this.object_errors=t||[],this.object_warnings=r||[],this.jquery_datatable=o||{},this.success_logs_events=a||[],this.error=s,this.initial_object_properties=n||[]}return e.prototype.get_messages=function(){console.log(this);for(var e=[],t=0;t<this.data.length;t++)(this.object_errors[t]&&"object"==typeof this.object_errors[t]&&this.object_errors[t].constructor!==Array||this.object_warnings[t]&&this.object_warnings[t].length>0||this.success_logs_events[t]&&this.success_logs_events[t].length>0)&&e.push(new E(t+1,this.object_errors[t],this.object_warnings[t],this.success_logs_events[t]));return e},e.get_from_response=function(t){var r=JSON.parse(t);return new e(r.data,r.object_errors,r.object_warnings,r.success_log_events,r.jquery_datatable,r.error,r.initial_object_properties)},e}(),w=function(t){var r=p(t),a=(()=>new FormData(e("#form-send-file").get(0)))();return n.show(),e.ajax({url:r,data:a,cache:!1,contentType:!1,dataType:"html",processData:!1,type:"POST"}).then(e=>(n.hide(),e)).catch(t=>(n.hide(),e("body,html").animate({scrollTop:0},500),s({title:"Ocurrio un error",text:"En la sección de notificaciones se muestra la lista de errores, adicionalmente en la consolase muestra información detallada de los errores y su contexto",type:"error",closeOnConfirm:!0,confirmButtonText:"Aceptar"}),t))},x=function(){e("#continue-button").remove()},T=function(){return e("#send-file").clone(!0).off().attr("id","continue-button").html("Almacenar información").attr("title","Guardar información de forma persistente en la base de datos").appendTo("#buttons-section")},O=()=>{s({title:"Confirmación de guardado",text:"Una vez acepte almacenar la información, todo lo que se ha mostrado que se guardarava a ser almacenado en la base de datos y no habrá forma de volver a un estado anterior.Si da click en cancelar la base de datos no sufrira ningun cambio.",type:"warning",closeOnConfirm:!0,closeOnCancel:!0,showCancelButton:!0,confirmButtonText:"Almacenar información?"},function(e){e&&(x(),C(!0).then(()=>{s({title:"La información se ha guardado correctamente",text:"",type:"success",closeOnConfirm:!0,closeOnCancel:!0,showCancelButton:!1,confirmButtonText:"Vale"}),y()}))})},C=o=>(g(),w(o).then(e=>{console.log(e,"response"),h(),g(),j();var t=k.get_from_response(e),s=t.object_errors,n=t.jquery_datatable,c=t.get_messages();r.render("block_ases/massive_upload_messages",{data:c}).then((e,t)=>{r.appendNodeContents("#messages_area",e,t)}),Object.keys(s).forEach((e,t)=>{n.data[e].errors=s[e]}),n.data.forEach((e,t)=>{e.index=t+1}),n.data.forEach((e,t)=>{s[t]&&(s[t].length>0||s[t].constructor===Object)?e.error="SI":e.error="NO"}),n.columns.unshift({name:"index",data:"index",title:"Linea"}),n.columns.push({name:"error",title:"Error",data:"error"}),n.rowCallback=b,n.initComplete=a.add_column_filters(["error:name"]),m(n),console.log(o,"continue antes de añadir el boton continue"),t.error||o||(0===t.success_logs_events.length?T().html("Nada para guardar").attr("disabled",!0):T().click(O))}).catch(r=>{h(),g(),j();var a=JSON.parse(r.responseText);console.log(a,"error object at catch send file");var o=a.datatable_preview;if(a.object_errors&&a.object_errors.generic_errors){var s=a.object_errors.generic_errors.map(e=>e.error_message);!function(t,r){if(t.dom="Bfrtip",m(t),r.data_response&&r.data_response.object_properties&&r.data_response.file_headers){var a=r.data_response.object_properties,o=r.data_response.file_headers,s=[];s=s.concat(a.filter(e=>o.indexOf(e)<0));var n=[];n=n.concat(o.filter(e=>a.indexOf(e)<=-1)),s.length>0&&s.forEach(t=>{e("."+t).css("background-color","#cccccc").attr("title","Columna faltante"),console.log(t)}),n.length>0&&n.forEach(t=>{console.log(t),e("."+t).css("background-color","red").attr("title","Columna sobrante")})}}(o,a.object_errors.generic_errors[0]),s.forEach(e=>{console.log(e),t.addNotification({message:e,type:"error"})})}})),E=function(){return function(e,t,r,a){this.index=e,this.errors=t?v(t):[],this.warnings=r||[],this.success_logs=a||[]}}();return{init:function(t){e("select").change(()=>{x()}),f=t.instance_id,e("#send-file").click(()=>{x(),C(!1).catch(()=>{y()})}),e("#user-notifications").prependTo(e(".massive_upload"))}}});