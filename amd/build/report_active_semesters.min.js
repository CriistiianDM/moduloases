define(["jquery","block_ases/Chart","block_ases/loading_indicator","block_ases/jquery.dataTables","block_ases/dataTables.autoFill","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print"],function(t,e,a){return{init:function(s){var o=s.instance_id,n="Activos sin cambio de carrera",r="Activos con cambio de carrera",l="Total activos",i="inactivos",c="Egresados",d="Total Estudiantes",u=["codigo","nombre","num_doc"];t(document).on("click","#tableActiveSemesters tbody tr td",function(){var e=t("#tableActiveSemesters").DataTable(),a=e.cell(this).index().column;if(a>=0&&a<=2){var s="student_profile.php"+location.search+"&student_code="+e.cell(e.row(this).index(),0).data();window.open(s,"_blank").focus()}});var m=[],h=function(){return function(t,e){var a=t.total_students;e.forEach(e=>{var s=a-(t.semesters[e][0]+t.semesters[e][1]);this[e]=100*s/a})}}(),v=function(){return function(t,e){var a=t.total_students;e.forEach(e=>{var s=t.semesters[e][1];this[e]=100*s/a})}}(),b=function(){return function(t,e){var a=t.total_students;e.forEach(e=>{var s=t.semesters[e][0];this[e]=100*s/a})}}(),f=function(){function t(t,e){this.total_students=e||0,this.semesters=[];for(var a=t.length,s=0;s<a;s++)this.semesters[t[s]]=[0,0,0,0]}return t.prototype.init_from_data=function(t,e){t.forEach(t=>{var a="";e.forEach(e=>{t[e].includes("NO")||t[e].includes("EGRESADO")||(t[e].includes(a)||""===a||this.semesters[e][2]++,a=t[e]),t[e].includes("SI")?this.semesters[e][0]++:t[e].includes("EGRESADO")&&this.semesters[e][1]++})});var a=0;e.forEach(t=>{a+=this.semesters[t][2],this.semesters[t][2]=a})},t}();var p=null,_=null,S=null,A=null;function g(){var e=document.getElementById("active_semesters_chart").toDataURL();t("#download_percentage_desertion").click(function(){t(this).attr("href",e)})}function C(s){var C="../managers/report_active_semesters/report_active_semesters_api.php/"+o;a.show();var x={function:"data_table",params:{instance_id:o,cohort_id:s}};t.ajax({method:"POST",url:C,data:x,dataType:"json"}).done(function(o){a.hide();var C=o.dataTable;t("#download_percentage_desertion").css("display","inline"),m=Object.values(o.semesters);var x=C.columns.map(t=>t.name),E=C.data.length;(p=new f(m,E)).init_from_data(C.data,m),_=new h(p,m),S=new v(p,m),A=new b(p,m),function(t,a,s,o,n){var r=[],l=[],i=[];t.forEach(t=>{r.push(a[t]),l.push(s[t]),i.push(o[t])});var c={type:"line",data:{labels:t,datasets:[{label:"Porcentaje de estudiantes activos durante el periodo",backgroundColor:"green",borderColor:"green",data:i,fill:!1},{label:"Porcentaje de estudiantes inactivos durante el periodo",backgroundColor:"red",borderColor:"red",data:r,fill:!1},{label:"Porcentaje de estudiantes graduados durante el periodo",backgroundColor:"blue",borderColor:"blue",data:l,fill:!1}]},options:{animation:{onComplete:function(){n()}},responsive:!0,title:{display:!0,text:"Reporte deserciÃ³n"},tooltips:{mode:"index",intersect:!1},hover:{mode:"nearest",intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Periodo"}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Porcentaje"}}]}}},d=document.getElementById("active_semesters_chart").getContext("2d");window.myLine=new e(d,c)}(m,_,S,A,g),C.rowCallback=function(e,a,s){t(m).each(function(s,o){a[o].includes("SI")?t("td."+o,e).addClass("active_semester"):a[o].includes("EGRESADO")&&t("td."+o,e).addClass("graduated_student")})},C.initComplete=function(){t("th:contains('20')").each(function(){t(this).addClass("Semestre")});var e=C.columns.map(t=>t.name?t.name:null),a=m;a.push("num_carreras");var s=function(t,e){var a,s=[];for(a=0;a<e.length;a++)t.includes(e[a])&&s.push(a);return s}(a,e);this.api().columns(s).every(function(){var e=this,a=t('<select><option value=""></option></select>').on("change",function(){var a=t.fn.dataTable.util.escapeRegex(t(this).val());e.search(a?"^"+a+"$":"",!0,!1).draw()});e.data().unique().sort().each(function(t,e){a.append('<option value="'+t+'">'+t+"</option>")})})},t.fn.dataTable.isDataTable("#tableActiveSemesters")&&(t("#div_table_report").html(""),t("#div_table_report").fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),t("#tableActiveSemesters").DataTable(C),t("#tableActiveSemesters").append(t("<tfoot/>").append(t("#tableActiveSemesters thead tr").clone().addClass("total_students"))),t("#tableActiveSemesters").append(t("<tfoot/>").append(t("#tableActiveSemesters thead tr").clone().addClass("total_nochange"))),t("#tableActiveSemesters").append(t("<tfoot/>").append(t("#tableActiveSemesters thead tr").clone().addClass("total_change"))),t("#tableActiveSemesters").append(t("<tfoot/>").append(t("#tableActiveSemesters thead tr").clone().addClass("total_active"))),t("#tableActiveSemesters").append(t("<tfoot/>").append(t("#tableActiveSemesters thead tr").clone().addClass("total_inactive"))),t("#tableActiveSemesters").append(t("<tfoot/>").append(t("#tableActiveSemesters thead tr").clone().addClass("total_grads"))),function(e,a,s){t("#tableActiveSemesters tfoot th").html(""),t("#tableActiveSemesters tfoot tr.total_students th")[1].textContent=d+" "+s,t("#tableActiveSemesters tfoot tr.total_nochange th")[1].textContent=n+" "+s,t("#tableActiveSemesters tfoot tr.total_change th")[1].textContent=r+" "+s,t("#tableActiveSemesters tfoot tr.total_active th")[1].textContent=l+" "+s,t("#tableActiveSemesters tfoot tr.total_inactive th")[1].textContent=i+" "+s,t("#tableActiveSemesters tfoot tr.total_grads th")[1].textContent=c+" "+s,a.forEach(function(a){t("#tableActiveSemesters tfoot tr.total_students th."+a).html(e.total_students),t("#tableActiveSemesters tfoot tr.total_nochange th."+a).html(e.semesters[a][0]-e.semesters[a][2]),t("#tableActiveSemesters tfoot tr.total_change th."+a).html(e.semesters[a][2]),t("#tableActiveSemesters tfoot tr.total_active th."+a).html(e.semesters[a][0]),t("#tableActiveSemesters tfoot tr.total_inactive th."+a).html(e.total_students-(e.semesters[a][0]+e.semesters[a][1])),t("#tableActiveSemesters tfoot tr.total_grads th."+a).html(e.semesters[a][1])})}(p,m,s),function(t,e){return t.filter(t=>-1!==e.indexOf(t)).length===e.length}(x,u)||console.error(" Las columnas dadas no coinciden con las columnas conocidas.","columnas daads:",x,"columnas conocidas: ",u)}).fail(function(t){a.hide()})}t("#cohorts").change(function(){var e=t("#cohorts option:selected").val();t("#tableActiveSemesters tfoot th")[0].textContent=l+" "+e,C(e)}),C(t("#cohorts option:selected").val())}}});