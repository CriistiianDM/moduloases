'use strict';define(['jquery','block_ases/Chart','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.autoFill','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c){return{init:function init(e){function f(H,I){var J=[],K;for(K=0;K<I.length;K++)H.includes(I[K])&&J.push(K);return J}function g(H,I,J){a('#tableActiveSemesters tfoot th').html(''),a('#tableActiveSemesters tfoot tr.total_students th')[1].textContent='Total Estudiantes'+' '+J,a('#tableActiveSemesters tfoot tr.total_active th')[1].textContent=s+' '+J,a('#tableActiveSemesters tfoot tr.total_inactive th')[1].textContent='Total inactivos'+' '+J,a('#tableActiveSemesters tfoot tr.total_grads th')[1].textContent='Total Egresados'+' '+J,I.forEach(function(K){a('#tableActiveSemesters tfoot tr.total_students th.'+K).html(H.total_students),a('#tableActiveSemesters tfoot tr.total_active th.'+K).html(H.semesters[K][0]),a('#tableActiveSemesters tfoot tr.total_inactive th.'+K).html(H.total_students-(H.semesters[K][0]+H.semesters[K][1])),a('#tableActiveSemesters tfoot tr.total_grads th.'+K).html(H.semesters[K][1])})}function h(H,I){return H.filter(function(J){return-1!==I.indexOf(J)}).length===I.length}function k(){var H=document.getElementById('active_semesters_chart').toDataURL();a('#download_percentage_desertion').click(function(){a(this).attr('href',H)})}function l(H,I,J,K,L){var M=[],N=[],O=[];H.forEach(function(S){M.push(I[S]),N.push(J[S]),O.push(K[S])});var Q=document.getElementById('active_semesters_chart'),R=Q.getContext('2d');window.myLine=new b(R,{type:'line',data:{labels:H,datasets:[{label:'Porcentaje de estudiantes activos durante el periodo',backgroundColor:'green',borderColor:'green',data:O,fill:!1},{label:'Porcentaje de estudiantes inactivos durante el periodo',backgroundColor:'red',borderColor:'red',data:M,fill:!1},{label:'Porcentaje de estudiantes graduados durante el periodo',backgroundColor:'blue',borderColor:'blue',data:N,fill:!1}]},options:{animation:{onComplete:function onComplete(){L()}},responsive:!0,title:{display:!0,text:'Reporte deserci\xF3n'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Periodo'}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Porcentaje'}}]}}})}function m(H){c.show();a.ajax({method:'POST',url:'../managers/report_active_semesters/report_active_semesters_api.php/'+n,data:{function:'data_table',params:{instance_id:n,cohort_id:H}},dataType:'json'}).done(function(K){c.hide();var L=K.dataTable;a('#download_percentage_desertion').css('display','inline'),x=K.semesters;var M=L.columns,N=M.map(function(P){return P.name}),O=L.data.length;console.log(x),C=new B(x,O),C.init_from_data(L.data,x),D=new y(C,x),E=new z(C,x),F=new A(C,x),l(x,D,E,F,k),L.rowCallback=function(P,Q){a(x).each(function(S,T){Q[T].includes('SI')?a('td.'+T,P).addClass('active_semester'):Q[T].includes('EGRESADO')&&a('td.'+T,P).addClass('graduated_student')})},L.initComplete=function(){a('th:contains(\'20\')').each(function(){a(this).addClass('Semestre')});var P=L.columns.map(function(S){return S.name?S.name:null}),Q=x;Q.push('num_carreras'),console.log(x);var R=f(Q,P);this.api().columns(R).every(function(){var S=this,T=a('<select><option value=""></option></select>').on('change',function(){var U=a.fn.dataTable.util.escapeRegex(a(this).val());S.search(U?'^'+U+'$':'',!0,!1).draw()});S.data().unique().sort().each(function(U){T.append('<option value="'+U+'">'+U+'</option>')})})},a.fn.dataTable.isDataTable('#tableActiveSemesters')&&(a('#div_table_report').html(''),a('#div_table_report').fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),o=a('#tableActiveSemesters').DataTable(L),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_students'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_active'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_inactive'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_grads'))),g(C,x,H),h(N,w)||console.error(' Las columnas dadas no coinciden con las columnas conocidas.','columnas daads:',N,'columnas conocidas: ',w)}).fail(function(){c.hide()})}var n=e.instance_id,o=null,s='Total activos',w=['codigo','nombre','num_doc'];a(document).on('click','#tableActiveSemesters tbody tr td',function(){var I=a('#tableActiveSemesters').DataTable(),J=I.cell(this).index().column;if(0<=J&&2>=J){var K='student_profile.php'+location.search+'&student_code='+I.cell(I.row(this).index(),0).data(),L=window.open(K,'_blank');L.focus()}});var x=[],y=function(){return function(I,J){var L=this,K=I.total_students;J.forEach(function(M){var N=K-(I.semesters[M][0]+I.semesters[M][1]);L[M]=100*N/K})}}(),z=function(){return function(I,J){var L=this,K=I.total_students;J.forEach(function(M){var N=I.semesters[M][1];L[M]=100*N/K})}}(),A=function(){return function(I,J){var L=this,K=I.total_students;J.forEach(function(M){var N=I.semesters[M][0];L[M]=100*N/K})}}(),B=function(){function H(I,J){this.total_students=J?J:0,this.semesters=[];for(var K=I.length,L=0;L<K;L++)this.semesters[I[L]]=[0,0]}return H.prototype.init_from_data=function(J,K){var L=this;J.forEach(function(M){K.forEach(function(N){M[N].includes('SI')?L.semesters[N][0]++:M[N].includes('EGRESADO')&&L.semesters[N][1]++})})},H}(),C=null,D=null,E=null,F=null;a('#cohorts').change(function(){var H=a('#cohorts option:selected').val();a('#tableActiveSemesters tfoot th')[0].textContent=s+' '+H,m(H)});var G=a('#cohorts option:selected').val();m(G)}}});