'use strict';define(['jquery','block_ases/Chart','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.autoFill','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c){return{init:function init(e){function f(B,C){var D=[],E;for(E=0;E<C.length;E++)B.includes(C[E])&&D.push(E);return D}function g(B,C,D){a('#tableActiveSemesters tfoot th').html(''),a('#tableActiveSemesters tfoot tr.total_active th')[0].textContent=s+' '+D,a('#tableActiveSemesters tfoot tr.total_inactive th')[0].textContent='Total inactivos'+' '+D,C.forEach(function(E){a('#tableActiveSemesters tfoot tr.total_active th.'+E).html(B[E]),a('#tableActiveSemesters tfoot tr.total_inactive th.'+E).html(B.total_students-B[E])})}function h(B,C){return B.filter(function(D){return-1!==C.indexOf(D)}).length===C.length}function k(){var B=document.getElementById('active_semesters_chart').toDataURL();a('#download_percentage_desertion').click(function(){a(this).attr('href',B)})}function l(B,C,D){var E=[];B.forEach(function(I){E.push(C[I])});var G=document.getElementById('active_semesters_chart'),H=G.getContext('2d');window.myLine=new b(H,{type:'line',data:{labels:B,datasets:[{label:'Porcentaje de estudiantes inactivos durante el periodo',backgroundColor:'red',borderColor:'red',data:E,fill:!1}]},options:{animation:{onComplete:function onComplete(){D()}},responsive:!0,title:{display:!0,text:'Reporte deserci\xF3n'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Periodo'}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Porcentaje'}}]}}})}function m(B){c.show();a.ajax({method:'POST',url:'../managers/report_active_semesters/report_active_semesters_api.php/'+n,data:{function:'data_table',params:{instance_id:n,cohort_id:B}},dataType:'json'}).done(function(E){c.hide();var F=E.dataTable;a('#download_percentage_desertion').css('display','inline'),v=E.semesters;var G=F.columns.map(function(I){return I.name}),H=F.data.length;y=new x(v,H),y.init_from_data(F.data,v),z=new w(y,v),l(v,z,k),F.rowCallback=function(I,J){a(v).each(function(L,M){'SI'===J[M]&&a('td.'+M,I).addClass('active_semester')})},F.initComplete=function(){var I=F.columns.map(function(L){return L.name?L.name:null}),J=v;J.push('cambio_carrera');var K=f(J,I);this.api().columns(K).every(function(){var L=this,M=a('<select><option value=""></option></select>').appendTo(a(L.header())).on('change',function(){var N=a.fn.dataTable.util.escapeRegex(a(this).val());L.search(N?'^'+N+'$':'',!0,!1).draw()});L.data().unique().sort().each(function(N){M.append('<option value="'+N+'">'+N+'</option>')})})},a.fn.dataTable.isDataTable('#tableActiveSemesters')&&(a('#div_table_report').html(''),a('#div_table_report').fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),o=a('#tableActiveSemesters').DataTable(F),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_active'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_inactive'))),g(y,v,B),h(G,u)||console.error(' Las columnas dadas no coinciden con las columnas conocidas.','columnas daads:',G,'columnas conocidas: ',u)}).fail(function(){c.hide()})}var n=e.instance_id,o=null,s='Total activos',u=['codigo','nombre','num_doc'];a(document).on('click','#tableActiveSemesters tbody tr td',function(){var C=a('#tableActiveSemesters').DataTable(),D=C.cell(this).index().column;if(0<=D&&2>=D){var E='student_profile.php'+location.search+'&student_code='+C.cell(C.row(this).index(),0).data(),F=window.open(E,'_blank');F.focus()}});var v=[],w=function(){return function(C,D){var F=this,E=C.total_students;D.forEach(function(G){var H=E-C[G];F[G]=100*H/E})}}(),x=function(){function B(C,D){var E=this;this.total_students=D?D:0,C.forEach(function(F){E[F]=0})}return B.prototype.init_from_data=function(D,E){var F=this;D.forEach(function(G){E.forEach(function(H){'SI'===G[H]&&F[H]++})})},B}(),y=null,z=null;a('#cohorts').change(function(){var B=a('#cohorts option:selected').val();a('#tableActiveSemesters tfoot th')[0].textContent=s+' '+B,m(B)});var A=a('#cohorts option:selected').val();m(A)}}});