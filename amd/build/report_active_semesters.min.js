'use strict';define(['jquery','block_ases/Chart','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.autoFill','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c){return{init:function init(e){function f(C,D){var E=[],F;for(F=0;F<D.length;F++)C.includes(D[F])&&E.push(F);return E}function g(C,D,E){a('#tableActiveSemesters tfoot th').html(''),a('#tableActiveSemesters tfoot tr.total_active th')[0].textContent=s+' '+E,a('#tableActiveSemesters tfoot tr.total_inactive th')[0].textContent='Total inactivos'+' '+E,a('#tableActiveSemesters tfoot tr.total_grads th')[0].textContent='Total Egresados'+' '+E,D.forEach(function(F){a('#tableActiveSemesters tfoot tr.total_active th.'+F).html(C.semesters[F][0]),a('#tableActiveSemesters tfoot tr.total_inactive th.'+F).html(C.total_students-(C.semesters[F][0]+C.semesters[F][1])),a('#tableActiveSemesters tfoot tr.total_grads th.'+F).html(C.semesters[F][1])})}function h(C,D){return C.filter(function(E){return-1!==D.indexOf(E)}).length===D.length}function k(){var C=document.getElementById('active_semesters_chart').toDataURL();a('#download_percentage_desertion').click(function(){a(this).attr('href',C)})}function l(C,D,E){var F=[];C.forEach(function(J){F.push(D[J])});var H=document.getElementById('active_semesters_chart'),I=H.getContext('2d');window.myLine=new b(I,{type:'line',data:{labels:C,datasets:[{label:'Porcentaje de estudiantes inactivos durante el periodo',backgroundColor:'red',borderColor:'red',data:F,fill:!1}]},options:{animation:{onComplete:function onComplete(){E()}},responsive:!0,title:{display:!0,text:'Reporte deserci\xF3n'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Periodo'}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Porcentaje'}}]}}})}function m(C){c.show();a.ajax({method:'POST',url:'../managers/report_active_semesters/report_active_semesters_api.php/'+n,data:{function:'data_table',params:{instance_id:n,cohort_id:C}},dataType:'json'}).done(function(F){c.hide();var G=F.dataTable;a('#download_percentage_desertion').css('display','inline'),w=F.semesters;var H=G.columns.map(function(J){return J.name}),I=G.data.length;console.log(w),z=new y(w,I),z.init_from_data(G.data,w),A=new x(z,w),l(w,A,k),G.rowCallback=function(J,K){a(w).each(function(M,N){'SI'===K[N]?a('td.'+N,J).addClass('active_semester'):'EGRESADO'===K[N]&&a('td.'+N,J).addClass('graduated_student')})},G.initComplete=function(){var J=G.columns.map(function(M){return M.name?M.name:null}),K=w;K.push('cambio_carrera');var L=f(K,J);this.api().columns(L).every(function(){var M=this,N=a('<select><option value=""></option></select>').appendTo(a(M.header())).on('change',function(){var O=a.fn.dataTable.util.escapeRegex(a(this).val());M.search(O?'^'+O+'$':'',!0,!1).draw()});M.data().unique().sort().each(function(O){N.append('<option value="'+O+'">'+O+'</option>')})})},a.fn.dataTable.isDataTable('#tableActiveSemesters')&&(a('#div_table_report').html(''),a('#div_table_report').fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),o=a('#tableActiveSemesters').DataTable(G),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_active'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_inactive'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_grads'))),g(z,w,C),h(H,v)||console.error(' Las columnas dadas no coinciden con las columnas conocidas.','columnas daads:',H,'columnas conocidas: ',v)}).fail(function(){c.hide()})}var n=e.instance_id,o=null,s='Total activos',v=['codigo','nombre','num_doc'];a(document).on('click','#tableActiveSemesters tbody tr td',function(){var D=a('#tableActiveSemesters').DataTable(),E=D.cell(this).index().column;if(0<=E&&2>=E){var F='student_profile.php'+location.search+'&student_code='+D.cell(D.row(this).index(),0).data(),G=window.open(F,'_blank');G.focus()}});var w=[],x=function(){return function(D,E){var G=this,F=D.total_students;E.forEach(function(H){var I=F-(D.semesters[H][0]+D.semesters[H][1]);G[H]=100*I/F})}}(),y=function(){function C(D,E){this.total_students=E?E:0,this.semesters=[];for(var F=D.length,G=0;G<F;G++)this.semesters[D[G]]=[0,0]}return C.prototype.init_from_data=function(E,F){var G=this;E.forEach(function(H){F.forEach(function(I){'SI'===H[I]?G.semesters[I][0]++:'EGRESADO'===H[I]&&G.semesters[I][1]++})})},C}(),z=null,A=null;a('#cohorts').change(function(){var C=a('#cohorts option:selected').val();a('#tableActiveSemesters tfoot th')[0].textContent=s+' '+C,m(C)});var B=a('#cohorts option:selected').val();m(B)}}});