define(["jquery","block_ases/Chart","block_ases/loading_indicator","block_ases/jquery.dataTables","block_ases/dataTables.autoFill","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print"],function(e,t,a){return{init:function(s){var o=s.instance_id,n="Activos sin cambio de carrera",l="Activos con cambio de carrera",r="Total activos",i="inactivos",c="Egresados",d="Total Estudiantes",u=["codigo","nombre","num_doc"];e(document).on("click","#tableActiveSemesters tbody tr td",function(){var t=e("#tableActiveSemesters").DataTable(),a=t.cell(this).index().column;if(a>=0&&a<=2){var s="student_profile.php"+location.search+"&student_code="+t.cell(t.row(this).index(),0).data();window.open(s,"_blank").focus()}});var m=[],h=function(){return function(e,t){var a=e.total_students;t.forEach(t=>{var s=a-(e.semesters[t][0]+e.semesters[t][1]);this[t]=100*s/a})}}(),v=function(){return function(e,t){var a=e.total_students;t.forEach(t=>{var s=e.semesters[t][1];this[t]=100*s/a})}}(),b=function(){return function(e,t){var a=e.total_students;t.forEach(t=>{var s=e.semesters[t][0];this[t]=100*s/a})}}(),f=function(){function e(e,t){this.total_students=t||0,this.semesters=[];for(var a=e.length,s=0;s<a;s++)this.semesters[e[s]]=[0,0,0,0]}return e.prototype.init_from_data=function(e,t){e.forEach(e=>{var a="";console.log(e),t.forEach(t=>{console.log("Semester:"),console.log(t),console.log("Item[semester:]"),console.log(e[t]),e[t].includes("NO")||e[t].includes("EGRESADO")||(e[t].includes(a)||""===a||this.semesters[t][2]++,a=e[t]),e[t].includes("SI")?this.semesters[t][0]++:e[t].includes("EGRESADO")&&this.semesters[t][1]++})});var a=0;t.forEach(e=>{a+=this.semesters[e][2],this.semesters[e][2]=a})},e}();var p=null,_=null,g=null,S=null;function A(){var t=document.getElementById("active_semesters_chart").toDataURL();e("#download_percentage_desertion").click(function(){e(this).attr("href",t)})}function C(s){var C="../managers/report_active_semesters/report_active_semesters_api.php/"+o;a.show();var x={function:"data_table",params:{instance_id:o,cohort_id:s}};e.ajax({method:"POST",url:C,data:x,dataType:"json"}).done(function(o){a.hide(),console.log(o);var C=o.dataTable;e("#download_percentage_desertion").css("display","inline"),m=Object.values(o.semesters);var x=C.columns.map(e=>e.name),E=C.data.length;console.log(m),(p=new f(m,E)).init_from_data(C.data,m),_=new h(p,m),g=new v(p,m),S=new b(p,m),function(e,a,s,o,n){var l=[],r=[],i=[];e.forEach(e=>{l.push(a[e]),r.push(s[e]),i.push(o[e])});var c={type:"line",data:{labels:e,datasets:[{label:"Porcentaje de estudiantes activos durante el periodo",backgroundColor:"green",borderColor:"green",data:i,fill:!1},{label:"Porcentaje de estudiantes inactivos durante el periodo",backgroundColor:"red",borderColor:"red",data:l,fill:!1},{label:"Porcentaje de estudiantes graduados durante el periodo",backgroundColor:"blue",borderColor:"blue",data:r,fill:!1}]},options:{animation:{onComplete:function(){n()}},responsive:!0,title:{display:!0,text:"Reporte deserciÃ³n"},tooltips:{mode:"index",intersect:!1},hover:{mode:"nearest",intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Periodo"}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:"Porcentaje"}}]}}},d=document.getElementById("active_semesters_chart").getContext("2d");window.myLine=new t(d,c)}(m,_,g,S,A),C.rowCallback=function(t,a,s){e(m).each(function(s,o){a[o].includes("SI")?e("td."+o,t).addClass("active_semester"):a[o].includes("EGRESADO")&&e("td."+o,t).addClass("graduated_student")})},C.initComplete=function(){e("th:contains('20')").each(function(){e(this).addClass("Semestre")});var t=C.columns.map(e=>e.name?e.name:null),a=m;a.push("num_carreras");var s=function(e,t){var a,s=[];for(a=0;a<t.length;a++)e.includes(t[a])&&s.push(a);return s}(a,t);this.api().columns(s).every(function(){var t=this,a=e('<select><option value=""></option></select>').on("change",function(){var a=e.fn.dataTable.util.escapeRegex(e(this).val());t.search(a?"^"+a+"$":"",!0,!1).draw()});t.data().unique().sort().each(function(e,t){a.append('<option value="'+e+'">'+e+"</option>")})})},e.fn.dataTable.isDataTable("#tableActiveSemesters")&&(e("#div_table_report").html(""),e("#div_table_report").fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),e("#tableActiveSemesters").DataTable(C),e("#tableActiveSemesters").append(e("<tfoot/>").append(e("#tableActiveSemesters thead tr").clone().addClass("total_students"))),e("#tableActiveSemesters").append(e("<tfoot/>").append(e("#tableActiveSemesters thead tr").clone().addClass("total_nochange"))),e("#tableActiveSemesters").append(e("<tfoot/>").append(e("#tableActiveSemesters thead tr").clone().addClass("total_change"))),e("#tableActiveSemesters").append(e("<tfoot/>").append(e("#tableActiveSemesters thead tr").clone().addClass("total_active"))),e("#tableActiveSemesters").append(e("<tfoot/>").append(e("#tableActiveSemesters thead tr").clone().addClass("total_inactive"))),e("#tableActiveSemesters").append(e("<tfoot/>").append(e("#tableActiveSemesters thead tr").clone().addClass("total_grads"))),function(t,a,s){e("#tableActiveSemesters tfoot th").html(""),e("#tableActiveSemesters tfoot tr.total_students th")[1].textContent=d+" "+s,e("#tableActiveSemesters tfoot tr.total_nochange th")[1].textContent=n+" "+s,e("#tableActiveSemesters tfoot tr.total_change th")[1].textContent=l+" "+s,e("#tableActiveSemesters tfoot tr.total_active th")[1].textContent=r+" "+s,e("#tableActiveSemesters tfoot tr.total_inactive th")[1].textContent=i+" "+s,e("#tableActiveSemesters tfoot tr.total_grads th")[1].textContent=c+" "+s,a.forEach(function(a){e("#tableActiveSemesters tfoot tr.total_students th."+a).html(t.total_students),e("#tableActiveSemesters tfoot tr.total_nochange th."+a).html(t.semesters[a][0]-t.semesters[a][2]),e("#tableActiveSemesters tfoot tr.total_change th."+a).html(t.semesters[a][2]),e("#tableActiveSemesters tfoot tr.total_active th."+a).html(t.semesters[a][0]),e("#tableActiveSemesters tfoot tr.total_inactive th."+a).html(t.total_students-(t.semesters[a][0]+t.semesters[a][1])),e("#tableActiveSemesters tfoot tr.total_grads th."+a).html(t.semesters[a][1])})}(p,m,s),function(e,t){return e.filter(e=>-1!==t.indexOf(e)).length===t.length}(x,u)||console.error(" Las columnas dadas no coinciden con las columnas conocidas.","columnas daads:",x,"columnas conocidas: ",u)}).fail(function(e){a.hide()})}e("#cohorts").change(function(){var t=e("#cohorts option:selected").val();e("#tableActiveSemesters tfoot th")[0].textContent=r+" "+t,C(t)}),C(e("#cohorts option:selected").val())}}});