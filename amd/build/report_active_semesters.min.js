'use strict';define(['jquery','block_ases/Chart','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.autoFill','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c){return{init:function init(e){function f(F,G){var H=[],I;for(I=0;I<G.length;I++)F.includes(G[I])&&H.push(I);return H}function g(F,G,H){a('#tableActiveSemesters tfoot th').html(''),a('#tableActiveSemesters tfoot tr.total_students th')[1].textContent='Total Estudiantes'+' '+H,a('#tableActiveSemesters tfoot tr.total_active th')[1].textContent=s+' '+H,a('#tableActiveSemesters tfoot tr.total_inactive th')[1].textContent='Total inactivos'+' '+H,a('#tableActiveSemesters tfoot tr.total_grads th')[1].textContent='Total Egresados'+' '+H,G.forEach(function(I){a('#tableActiveSemesters tfoot tr.total_students th.'+I).html(F.total_students),a('#tableActiveSemesters tfoot tr.total_active th.'+I).html(F.semesters[I][0]),a('#tableActiveSemesters tfoot tr.total_inactive th.'+I).html(F.total_students-(F.semesters[I][0]+F.semesters[I][1])),a('#tableActiveSemesters tfoot tr.total_grads th.'+I).html(F.semesters[I][1])})}function h(F,G){return F.filter(function(H){return-1!==G.indexOf(H)}).length===G.length}function k(){var F=document.getElementById('active_semesters_chart').toDataURL();a('#download_percentage_desertion').click(function(){a(this).attr('href',F)})}function l(F,G,H,I){var J=[],K=[];F.forEach(function(O){J.push(G[O]),K.push(H[O])});var M=document.getElementById('active_semesters_chart'),N=M.getContext('2d');window.myLine=new b(N,{type:'line',data:{labels:F,datasets:[{label:'Porcentaje de estudiantes inactivos durante el periodo',backgroundColor:'red',borderColor:'red',data:J,fill:!1},{label:'Porcentaje de estudiantes graduados durante el periodo',backgroundColor:'blue',borderColor:'blue',data:K,fill:!1}]},options:{animation:{onComplete:function onComplete(){I()}},responsive:!0,title:{display:!0,text:'Reporte deserci\xF3n'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Periodo'}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Porcentaje'}}]}}})}function m(F){c.show();a.ajax({method:'POST',url:'../managers/report_active_semesters/report_active_semesters_api.php/'+n,data:{function:'data_table',params:{instance_id:n,cohort_id:F}},dataType:'json'}).done(function(I){c.hide();var J=I.dataTable;a('#download_percentage_desertion').css('display','inline'),x=I.semesters;var K=J.columns,L=K.map(function(N){return N.name}),M=J.data.length;console.log(x),B=new A(x,M),B.init_from_data(J.data,x),C=new y(B,x),D=new z(B,x),l(x,C,D,k),J.rowCallback=function(N,O){a(x).each(function(Q,R){O[R].includes('SI')?a('td.'+R,N).addClass('active_semester'):O[R].includes('EGRESADO')&&a('td.'+R,N).addClass('graduated_student')})},J.initComplete=function(){a('th:contains(\'20\')').each(function(){a(this).addClass('Semestre')});var N=J.columns.map(function(Q){return Q.name?Q.name:null}),O=x;O.push('num_carreras'),console.log(x);var P=f(O,N);this.api().columns(P).every(function(){var Q=this,R=a('<select><option value=""></option></select>').on('change',function(){var S=a.fn.dataTable.util.escapeRegex(a(this).val());Q.search(S?'^'+S+'$':'',!0,!1).draw()});Q.data().unique().sort().each(function(S){R.append('<option value="'+S+'">'+S+'</option>')})})},a.fn.dataTable.isDataTable('#tableActiveSemesters')&&(a('#div_table_report').html(''),a('#div_table_report').fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),o=a('#tableActiveSemesters').DataTable(J),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_students'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_active'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_inactive'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_grads'))),g(B,x,F),h(L,w)||console.error(' Las columnas dadas no coinciden con las columnas conocidas.','columnas daads:',L,'columnas conocidas: ',w)}).fail(function(){c.hide()})}var n=e.instance_id,o=null,s='Total activos',w=['codigo','nombre','num_doc'];a(document).on('click','#tableActiveSemesters tbody tr td',function(){var G=a('#tableActiveSemesters').DataTable(),H=G.cell(this).index().column;if(0<=H&&2>=H){var I='student_profile.php'+location.search+'&student_code='+G.cell(G.row(this).index(),0).data(),J=window.open(I,'_blank');J.focus()}});var x=[],y=function(){return function(G,H){var J=this,I=G.total_students;H.forEach(function(K){var L=I-(G.semesters[K][0]+G.semesters[K][1]);J[K]=100*L/I})}}(),z=function(){return function(G,H){var J=this,I=G.total_students;H.forEach(function(K){var L=G.semesters[K][1];J[K]=100*L/I})}}(),A=function(){function F(G,H){this.total_students=H?H:0,this.semesters=[];for(var I=G.length,J=0;J<I;J++)this.semesters[G[J]]=[0,0]}return F.prototype.init_from_data=function(H,I){var J=this;H.forEach(function(K){I.forEach(function(L){K[L].includes('SI')?J.semesters[L][0]++:K[L].includes('EGRESADO')&&J.semesters[L][1]++})})},F}(),B=null,C=null,D=null;a('#cohorts').change(function(){var F=a('#cohorts option:selected').val();a('#tableActiveSemesters tfoot th')[0].textContent=s+' '+F,m(F)});var E=a('#cohorts option:selected').val();m(E)}}});