// Standard license block omitted.
/*
 * @package    block_ases
 * @copyright  ASES
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */ /**
  * @module block_ases/dphpforms_reports
 */ define(["jquery","block_ases/jszip","block_ases/jquery.dataTables","block_ases/dataTables.autoFill","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print","block_ases/bootstrap","block_ases/sweetalert","block_ases/jqueryui","block_ases/select2"],function($,a,b,c,d,e,f,g,h,i,j,k){return{init:function(){/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)||($("#container-control").find("*").prop("disabled",!0),$("#container-msg-chrome").fadeIn(300)),window.JSZip=a;var b=null;function c(c,k){if("seguimiento_pares"==k){for(var e=c.length,a=0;a<e;a++){for(var g=null,h=null,d=0;d<Object.keys(c[a]).length;d++)"-#$%-"==c[a][d].respuesta&&(c[a][d].respuesta=""),("puntuacion_riesgo_individual"==c[a][d].local_alias||"puntuacion_riesgo_familiar"==c[a][d].local_alias||"puntuacion_riesgo_academico"==c[a][d].local_alias||"puntuacion_riesgo_economico"==c[a][d].local_alias||"puntuacion_vida_uni"==c[a][d].local_alias)&&("1"==c[a][d].respuesta?c[a][d].respuesta="bajo":"2"==c[a][d].respuesta?c[a][d].respuesta="medio":"3"==c[a][d].respuesta&&(c[a][d].respuesta="alto")),"revisado_profesional"==c[a][d].local_alias&&("0"==c[a][d].respuesta?c[a][d].respuesta="marcado":"-1"==c[a][d].respuesta&&(c[a][d].respuesta="no_marcado")),"revisado_practicante"==c[a][d].local_alias&&("0"==c[a][d].respuesta?c[a][d].respuesta="marcado":"-1"==c[a][d].respuesta&&(c[a][d].respuesta="no_marcado")),g&&h||("id_estudiante"==c[a][d].local_alias&&(g=c[a][d].respuesta),"id_creado_por"!=c[a][d].local_alias||(h=c[a][d].respuesta));var i=parseInt($("#dphpforms-instance-id").data("instance-id"));$.ajax({type:"POST",url:"../managers/user_management/user_management_api.php",data:JSON.stringify({function:"get_crea_stud_mon_prac_prof",params:[g,h,i,b]}),contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(b){c[a][Object.keys(c[a]).length]={enunciado:"monitor_name",id:"00",local_alias:"monitor_name",respuesta:String(b.data_response.monitor.firstname)+" "+String(b.data_response.monitor.lastname)},c[a][Object.keys(c[a]).length]={enunciado:"practicing_name",id:"00",local_alias:"practicing_name",respuesta:String(b.data_response.practicing.firstname)+" "+String(b.data_response.practicing.lastname)},c[a][Object.keys(c[a]).length]={enunciado:"professional_name",id:"00",local_alias:"professional_name",respuesta:String(b.data_response.professional.firstname)+" "+String(b.data_response.professional.lastname)},c[a][Object.keys(c[a]).length]={enunciado:"created_by",id:"00",local_alias:"created_by",respuesta:String(b.data_response.created_by.firstname)+" "+String(b.data_response.created_by.lastname)};var d=b.data_response.student_username;d=d?b.data_response.student_username.split("-")[0]:"null",c[a][Object.keys(c[a]).length]={enunciado:"student_code",id:"00",local_alias:"student_code",respuesta:d},c[a][Object.keys(c[a]).length]={enunciado:"student_firstname",id:"00",local_alias:"student_firstname",respuesta:String(b.data_response.student.firstname)},c[a][Object.keys(c[a]).length]={enunciado:"student_lastname",id:"00",local_alias:"student_lastname",respuesta:String(b.data_response.student.lastname)}},failure:function(a){console.log(a)}});for(var j=3,f=Object.keys(c[a]).length-1;f>=0;f--)c[a][f+j]=$.extend(!0,{},c[a][f]);c[a][0]=$.extend(!0,{},c[a][Object.keys(c[a]).length-3]),c[a][1]=$.extend(!0,{},c[a][Object.keys(c[a]).length-2]),c[a][2]=$.extend(!0,{},c[a][Object.keys(c[a]).length-1]),delete c[a][Object.keys(c[a]).length-1],delete c[a][Object.keys(c[a]).length-1],delete c[a][Object.keys(c[a]).length-1],$("#progress-custom").find("div").width((100/e*(a+1)).toFixed(0)+"%"),$("#progress-custom").find("div").html((100/e*(a+1)).toFixed(0)+"%"),$("#progress-custom").find("div").attr("aria-valuenow",(100/e*(a+1)).toFixed(0))}return $("#progress-custom").find("div").addClass("progress-bar-success"),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),c}if("inasistencia"!=k)return $("#progress-custom").find("div").addClass("progress-bar-success"),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),c;for(var e=c.length,a=0;a<e;a++){for(var g=null,h=null,d=0;d<Object.keys(c[a]).length;d++)"-#$%-"==c[a][d].respuesta&&(c[a][d].respuesta=""),("puntuacion_riesgo_individual"==c[a][d].local_alias||"puntuacion_riesgo_familiar"==c[a][d].local_alias||"puntuacion_riesgo_academico"==c[a][d].local_alias||"puntuacion_riesgo_economico"==c[a][d].local_alias||"puntuacion_vida_uni"==c[a][d].local_alias)&&("1"==c[a][d].respuesta?c[a][d].respuesta="bajo":"2"==c[a][d].respuesta?c[a][d].respuesta="medio":"3"==c[a][d].respuesta&&(c[a][d].respuesta="alto")),"revisado_profesional"==c[a][d].local_alias&&("0"==c[a][d].respuesta?c[a][d].respuesta="marcado":"-1"==c[a][d].respuesta&&(c[a][d].respuesta="no_marcado")),"revisado_practicante"==c[a][d].local_alias&&("0"==c[a][d].respuesta?c[a][d].respuesta="marcado":"-1"==c[a][d].respuesta&&(c[a][d].respuesta="no_marcado")),g&&h||("id_estudiante"==c[a][d].local_alias&&(g=c[a][d].respuesta),"id_creado_por"!=c[a][d].local_alias||(h=c[a][d].respuesta));var i=parseInt($("#dphpforms-instance-id").data("instance-id"));$.ajax({type:"POST",url:"../managers/user_management/user_management_api.php",data:JSON.stringify({function:"get_crea_stud_mon_prac_prof",params:[g,h,i,b]}),contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(b){c[a][Object.keys(c[a]).length]={enunciado:"monitor_name",id:"00",local_alias:"monitor_name",respuesta:String(b.data_response.monitor.firstname)+" "+String(b.data_response.monitor.lastname)},c[a][Object.keys(c[a]).length]={enunciado:"practicing_name",id:"00",local_alias:"practicing_name",respuesta:String(b.data_response.practicing.firstname)+" "+String(b.data_response.practicing.lastname)},c[a][Object.keys(c[a]).length]={enunciado:"professional_name",id:"00",local_alias:"professional_name",respuesta:String(b.data_response.professional.firstname)+" "+String(b.data_response.professional.lastname)},c[a][Object.keys(c[a]).length]={enunciado:"created_by",id:"00",local_alias:"created_by",respuesta:String(b.data_response.created_by.firstname)+" "+String(b.data_response.created_by.lastname)};var d=b.data_response.student_username;d=d?b.data_response.student_username.split("-")[0]:"null",c[a][Object.keys(c[a]).length]={enunciado:"student_code",id:"00",local_alias:"student_code",respuesta:d},c[a][Object.keys(c[a]).length]={enunciado:"student_firstname",id:"00",local_alias:"student_firstname",respuesta:String(b.data_response.student.firstname)},c[a][Object.keys(c[a]).length]={enunciado:"student_lastname",id:"00",local_alias:"student_lastname",respuesta:String(b.data_response.student.lastname)}},failure:function(a){console.log(a)}});for(var j=3,f=Object.keys(c[a]).length-1;f>=0;f--)c[a][f+j]=$.extend(!0,{},c[a][f]);c[a][0]=$.extend(!0,{},c[a][Object.keys(c[a]).length-3]),c[a][1]=$.extend(!0,{},c[a][Object.keys(c[a]).length-2]),c[a][2]=$.extend(!0,{},c[a][Object.keys(c[a]).length-1]),delete c[a][Object.keys(c[a]).length-1],delete c[a][Object.keys(c[a]).length-1],delete c[a][Object.keys(c[a]).length-1],$("#progress-custom").find("div").width((100/e*(a+1)).toFixed(0)+"%"),$("#progress-custom").find("div").html((100/e*(a+1)).toFixed(0)+"%"),$("#progress-custom").find("div").attr("aria-valuenow",(100/e*(a+1)).toFixed(0))}return $("#progress-custom").find("div").addClass("progress-bar-success"),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),c}function d(d){var b,a,c=function(c){if(null==(b=c.data||null)||!b.length)return null;f=c.columnDelimiter||",",g=c.lineDelimiter||"\n",i=Object.keys(b[0]);for(var a,h,i,f,g,b,e=[],d=0;d<Object.keys(b[0]).length;d++)try{e.push(b[0][d].local_alias)}catch(j){console.log("ERROR"),console.log(b[0])}return a="",a+=e.join(f),a+=g,b.forEach(function(b){h=0,i.forEach(function(c){h>0&&(a+=f);try{a+='"'+b[c].respuesta.replace(/"/g,"'")+'"'}catch(d){}h++}),a+=g}),a}({data:d});if(null!=c){b="reporte.csv",csvData=new Blob([c],{type:"text/csv"});var a=document.createElement("a");if(void 0!==a.download){var e=URL.createObjectURL(csvData);a.setAttribute("href",e),a.setAttribute("download",b),a.style="visibility:hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}}$("#base_fields_check").on("change",function(){$("#base_fields_check").prop("checked")?$("#base_fields input[type='checkbox']").prop("checked",!0):$("#base_fields input[type='checkbox']").prop("checked",!1)}),$("#dimensions_fields_check").on("change",function(){$("#dimensions_fields_check").prop("checked")?$("#dimensions_fields input[type='checkbox']").prop("checked",!0):$("#dimensions_fields input[type='checkbox']").prop("checked",!1)}),$("#comments_fields_check").on("change",function(){$("#comments_fields_check").prop("checked")?$("#comments_fields input[type='checkbox']").prop("checked",!0):$("#comments_fields input[type='checkbox']").prop("checked",!1)}),$("#risks_fields_check").on("change",function(){$("#risks_fields_check").prop("checked")?$("#risks_fields input[type='checkbox']").prop("checked",!0):$("#risks_fields input[type='checkbox']").prop("checked",!1)}),$("#themes_fields_check").on("change",function(){$("#themes_fields_check").prop("checked")?$("#themes_fields input[type='checkbox']").prop("checked",!0):$("#themes_fields input[type='checkbox']").prop("checked",!1)}),$("#btn-generar-reporte").click(function(){var e=$("#start_date").val(),f=$("#end_date").val(),a=$("#code_student_dphpforms").val(),h=$("#check_seguimiento").prop("checked"),i=$("#check_inasistencia").prop("checked");if(e>=f)swal({title:"Informaci\xf3n",text:"Intervalo de fechas inv\xe1lido",type:"warning"},function(){});else if(a&&12!=a.length)swal({title:"Informaci\xf3n",text:"Corroborar el c\xf3digo suministrado",type:"warning"},function(){});else{let j=$("#dphpforms-instance-id").data("instance-id");if($.ajax({type:"POST",url:"../managers/periods_management/periods_api.php",data:JSON.stringify({function:"core_periods_get_period_by_date",params:[e,f,j]}),contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(a){b=a.data_response},failure:function(a){}}),b&&!a&& !0==h){var g=JSON.parse($("#dphpforms-reports-preguntas1").html());let k=$("#dphpforms-instance-id").data("instance-id");$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").width("0%"),$(".progress-bar").html("0%"),$(".progress-bar").attr("aria-valuenow","0"),$("#progress_group").css("display","block"),$("#progress_group").removeClass("hidden"),$("#message").removeClass("alert alert-success"),$("#message").addClass("alert alert-info"),$("#message").html("<strong>Info!</strong> Se est\xe1 generando el reporte, esto puede tardar un par de minutos dependiendo de su conexi\xf3n a internet, capacidad del ordenador, intervalo de tiempo seleccionado y rapidez del campus virtual."),$.ajax({type:"POST",url:"../managers/dphpforms/v2/dphpforms_api.php",data:JSON.stringify({function:"find_records",params:[{form:"seguimiento_pares",filterFields:[["fecha",[[e,">="],[f,"<="]],!1],["id_instancia",[[k,"LIKE"]],!1]],orderFields:[],orderByDatabaseRecordDate:!1,recordStatus:["!deleted"],selectedFields:[],asFields:[]}]}),contentType:"aplication/json",dataType:"json",cache:"false",success:function(b){let e=Object.keys(b.data_response).length,h=[],f=0;for(var a=0;a<e;a++)$.get("../managers/dphpforms/dphpforms_get_record.php?record_id="+b.data_response[a].id_registro,function(a){if(Object.keys(a.record).length>0){for(var b=$.extend(!0,{},g),i=0;i<Object.keys(a.record.campos).length;i++)for(var j=0;j<Object.keys(b).length;j++)b[j].id==parseInt(a.record.campos[i].id_pregunta)&&(b[j].respuesta=a.record.campos[i].respuesta);h.push(b)}f++,$("#progress-download").find("div").width((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").html((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").attr("aria-valuenow",(100/e*f).toFixed(0)),f==e&&($("#progress-download").find("div").addClass("progress-bar-success"),setTimeout(function(){d(c(h,"seguimiento_pares"))},10))}).fail(function(a){console.log(a)}),$("#progress").text(Math.round(f));0==e&&($("#progress").text(100),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),$("#progress_group").addClass("hidden"))},error:function(a){}})}else if(b&&a&& !0==h){var g=JSON.parse($("#dphpforms-reports-preguntas1").html());let l=$("#dphpforms-instance-id").data("instance-id");$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").width("0%"),$(".progress-bar").html("0%"),$(".progress-bar").attr("aria-valuenow","0"),$("#progress_group").css("display","block"),$("#progress_group").removeClass("hidden"),$("#message").removeClass("alert alert-success"),$("#message").addClass("alert alert-info"),$("#message").html("<strong>Info!</strong> Se est\xe1 generando el reporte, esto puede tardar un par de minutos dependiendo de su conexi\xf3n a internet, capacidad del ordenador, intervalo de tiempo seleccionado y rapidez del campus virtual."),$.ajax({type:"POST",url:"../managers/dphpforms/v2/dphpforms_api.php",data:JSON.stringify({function:"find_records",params:[{form:"seguimiento_pares",filterFields:[["fecha",[[e,">="],[f,"<="]],!1],["id_instancia",[[l,"LIKE"]],!1],["username",[[a,"LIKE"]],!1]],orderFields:[],orderByDatabaseRecordDate:!1,recordStatus:["!deleted"],selectedFields:[],asFields:[]}]}),contentType:"aplication/json",dataType:"json",cache:"false",success:function(b){let e=Object.keys(b.data_response).length,h=[],f=0;for(var a=0;a<e;a++)$.get("../managers/dphpforms/dphpforms_get_record.php?record_id="+b.data_response[a].id_registro,function(a){if(Object.keys(a.record).length>0){for(var b=$.extend(!0,{},g),i=0;i<Object.keys(a.record.campos).length;i++)for(var j=0;j<Object.keys(b).length;j++)b[j].id==parseInt(a.record.campos[i].id_pregunta)&&(b[j].respuesta=a.record.campos[i].respuesta);h.push(b)}f++,$("#progress-download").find("div").width((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").html((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").attr("aria-valuenow",(100/e*f).toFixed(0)),f==e&&($("#progress-download").find("div").addClass("progress-bar-success"),setTimeout(function(){d(c(h,"seguimiento_pares"))},10))}).fail(function(a){console.log(a)}),$("#progress").text(Math.round(f));0==e&&($("#progress").text(100),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),$("#progress_group").addClass("hidden"))},error:function(a){}})}else if(b&&!a&& !0==i){var g=JSON.parse($("#dphpforms-reports-preguntas2").html());let m=$("#dphpforms-instance-id").data("instance-id");$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").width("0%"),$(".progress-bar").html("0%"),$(".progress-bar").attr("aria-valuenow","0"),$("#progress_group").css("display","block"),$("#progress_group").removeClass("hidden"),$("#message").removeClass("alert alert-success"),$("#message").addClass("alert alert-info"),$("#message").html("<strong>Info!</strong> Se est\xe1 generando el reporte, esto puede tardar un par de minutos dependiendo de su conexi\xf3n a internet, capacidad del ordenador, intervalo de tiempo seleccionado y rapidez del campus virtual."),$.ajax({type:"POST",url:"../managers/dphpforms/v2/dphpforms_api.php",data:JSON.stringify({function:"find_records",params:[{form:"inasistencia",filterFields:[["in_fecha",[[e,">="],[f,"<="]],!1],["in_id_instancia",[[m,"LIKE"]],!1],],orderFields:[],orderByDatabaseRecordDate:!1,recordStatus:["!deleted"],selectedFields:[],asFields:[]}]}),contentType:"aplication/json",dataType:"json",cache:"false",success:function(b){let e=Object.keys(b.data_response).length,h=[],f=0;for(var a=0;a<e;a++)$.get("../managers/dphpforms/dphpforms_get_record.php?record_id="+b.data_response[a].id_registro,function(a){if(Object.keys(a.record).length>0){for(var b=$.extend(!0,{},g),i=0;i<Object.keys(a.record.campos).length;i++)for(var j=0;j<Object.keys(b).length;j++)b[j].id==parseInt(a.record.campos[i].id_pregunta)&&(b[j].respuesta=a.record.campos[i].respuesta);h.push(b)}f++,$("#progress-download").find("div").width((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").html((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").attr("aria-valuenow",(100/e*f).toFixed(0)),f==e&&($("#progress-download").find("div").addClass("progress-bar-success"),setTimeout(function(){d(c(h,"inasistencia"))},10))}).fail(function(a){console.log(a)}),$("#progress").text(Math.round(f));0==e&&($("#progress").text(100),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),$("#progress_group").addClass("hidden"))},error:function(a){}})}else if(b&&a&& !0==i){var g=JSON.parse($("#dphpforms-reports-preguntas2").html());let n=$("#dphpforms-instance-id").data("instance-id");$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").width("0%"),$(".progress-bar").html("0%"),$(".progress-bar").attr("aria-valuenow","0"),$("#progress_group").css("display","block"),$("#progress_group").removeClass("hidden"),$("#message").removeClass("alert alert-success"),$("#message").addClass("alert alert-info"),$("#message").html("<strong>Info!</strong> Se est\xe1 generando el reporte, esto puede tardar un par de minutos dependiendo de su conexi\xf3n a internet, capacidad del ordenador, intervalo de tiempo seleccionado y rapidez del campus virtual."),$.ajax({type:"POST",url:"../managers/dphpforms/v2/dphpforms_api.php",data:JSON.stringify({function:"find_records",params:[{form:"inasistencia",filterFields:[["in_fecha",[[e,">="],[f,"<="]],!1],["in_id_instancia",[[n,"LIKE"]],!1],["in_id_estudiante",[[a,"LIKE"]],!1]],orderFields:[],orderByDatabaseRecordDate:!1,recordStatus:["!deleted"],selectedFields:[],asFields:[]}]}),contentType:"aplication/json",dataType:"json",cache:"false",success:function(b){let e=Object.keys(b.data_response).length,h=[],f=0;for(var a=0;a<e;a++)$.get("../managers/dphpforms/dphpforms_get_record.php?record_id="+b.data_response[a].id_registro,function(a){if(Object.keys(a.record).length>0){for(var b=$.extend(!0,{},g),i=0;i<Object.keys(a.record.campos).length;i++)for(var j=0;j<Object.keys(b).length;j++)b[j].id==parseInt(a.record.campos[i].id_pregunta)&&(b[j].respuesta=a.record.campos[i].respuesta);h.push(b)}f++,$("#progress-download").find("div").width((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").html((100/e*f).toFixed(0)+"%"),$("#progress-download").find("div").attr("aria-valuenow",(100/e*f).toFixed(0)),f==e&&($("#progress-download").find("div").addClass("progress-bar-success"),setTimeout(function(){d(c(h,"inasistencia"))},10))}).fail(function(a){console.log(a)}),$("#progress").text(Math.round(f));0==e&&($("#progress").text(100),$("#message").removeClass("alert alert-info"),$("#message").addClass("alert alert-success"),$("#message").html("<strong>Info!</strong>  Reporte generado."),$("#progress_group").addClass("hidden"))},error:function(a){}})}else swal({title:"Informaci\xf3n",text:"Las fechas deben estar en el lapso de tiempo que comprende un periodo acad\xe9mico. ",type:"error"},function(){})}})}}})