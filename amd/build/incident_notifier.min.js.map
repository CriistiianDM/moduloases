{"version":3,"sources":["../src/incident_notifier.js"],"names":["define","$","Cookies","visible","current_ids","page_title","text","append","check_incidents","callback","ajax","type","url","data","JSON","stringify","contentType","dataType","async","success","data_response","failure","add_counter_page","number","playSound","get","document","getElementById","innerHTML","set","menu_incidents_manager","find","console","log","init","length","number_open_incidents","forEach","element","push","id","setInterval","beep","new_elements","ids","indexOf","remove"],"mappings":"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","sourcesContent":["// Standard license block omitted.\n/*\n * @package    block_ases\n * @copyright  ASES\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @author Jeison Cardona GÃ³mez <jeison.cardona@correounivalle.edu.co>\n * @module block_ases/incident_notifier\n */\n\ndefine([\n    'jquery',\n    'block_ases/jscookie'\n], function ($, Cookies) {\n\n\n    let visible = false;\n    let current_ids = [];\n    let page_title = $(\"title\").text();\n\n\n    $(\"html\").append('<div id=\"notification_sound\" style=\"display:none;\"></div>');\n\n    function check_incidents(callback) {\n        $.ajax({\n            type: \"POST\",\n            url: \"../managers/incident_manager/incident_api.php\",\n            data: JSON.stringify({ \"function\": \"get_ids_open_incidents\", \"params\": [] }),\n            contentType: \"application/json; charset=utf-8\",\n            dataType: \"json\",\n            async: false,\n            success: function (data) {\n                if (typeof callback === 'function') {\n                    callback(data.data_response);\n                }\n            },\n            failure: function (errMsg) { }\n        });\n    }\n\n    function add_counter_page(number) {\n        if (number > 0) {\n            $(\"title\").text(\"(\" + number + \")\" + \" \" + page_title);\n        } else {\n            $(\"title\").text(page_title);\n        }\n    }\n\n    function playSound() {\n        if (Cookies.get('beep') == \"true\") {\n            let filename = 'notification_sound';\n            let mp3Source = '<source src=\"../resources/' + filename + '.mp3\" type=\"audio/mpeg\">';\n            let oggSource = '<source src=\"../resources/' + filename + '.ogg\" type=\"audio/ogg\">';\n            let embedSource = '<embed hidden=\"true\" autostart=\"true\" loop=\"false\" src=\"../resources/' + filename + '.mp3\">';\n            document.getElementById(\"notification_sound\").innerHTML = '<audio autoplay=\"autoplay\">' + mp3Source + oggSource + embedSource + '</audio>';\n            Cookies.set('beep', \"false\");\n        }\n    }\n\n    let menu_incidents_manager = $(\"#menu_incidents_manager\").find(\".menu_a\");\n\n    console.log(\"Incident notifier initialised\");\n\n    return {\n        init: function () {\n\n            if (menu_incidents_manager.length) {\n\n                check_incidents(\n                    function (data) {\n\n                        let number_open_incidents = data.length;\n                        add_counter_page(number_open_incidents);\n\n                        if (number_open_incidents > 0) {\n                            visible = true;\n\n                            data.forEach(element => {\n                                current_ids.push(element.id)\n                            });\n\n                            menu_incidents_manager.append(' <span id=\"incidents_counter\" class=\"badge badge-secondary\">' + data.length + '</span>');\n                        }\n\n                    }\n                );\n\n\n                setInterval(() => {\n\n                    check_incidents(\n                        function (data) {\n                            let beep = false;\n                            let number_open_incidents = data.length;\n                            add_counter_page(number_open_incidents);\n\n                            if ((number_open_incidents > 0) && !visible) {\n                                visible = true;\n                                beep = true;\n                                Cookies.set('beep', beep);\n                                menu_incidents_manager.append(' <span id=\"incidents_counter\" class=\"badge badge-secondary\">' + data.length + '</span>');\n                            } else if ((number_open_incidents > 0) && visible) {\n\n                                let new_elements = false;\n                                let ids = [];\n                                data.forEach(element => {\n                                    ids.push(element.id)\n                                    if (current_ids.indexOf(element.id) === -1) {\n                                        new_elements = true;\n                                    };\n                                });\n\n                                if (new_elements) {\n                                    current_ids = ids;\n                                    beep = true;\n                                    Cookies.set('beep', beep);\n                                    $(\"#incidents_counter\").text(data.length);\n                                }\n\n\n                            } else if (number_open_incidents === 0) {\n                                $(\"#incidents_counter\").remove();\n                            }\n\n                            if (beep) {\n                                playSound();\n                                beep = false;\n                            }\n\n                        }\n                    );\n\n                }, 3000);\n\n            }\n\n        }\n    };\n});"],"file":"incident_notifier.min.js"}