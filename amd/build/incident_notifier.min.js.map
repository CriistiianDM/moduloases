{"version":3,"sources":["../src/incident_notifier.js"],"names":["define","$","Cookies","visible","current_ids","page_title","text","append","check_incidents","callback","ajax","type","url","data","JSON","stringify","contentType","dataType","async","success","data_response","failure","add_counter_page","number","playSound","get","document","getElementById","innerHTML","set","menu_incidents_manager","find","console","log","init","length","number_open_incidents","forEach","element","push","id","setInterval","beep","new_elements","ids","indexOf","remove"],"mappings":"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","sourcesContent":["// Standard license block omitted.\r\n/*\r\n * @package    block_ases\r\n * @copyright  ASES\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * @author Jeison Cardona GÃ³mez <jeison.cardona@correounivalle.edu.co>\r\n * @module block_ases/incident_notifier\r\n */\r\n\r\ndefine([\r\n    'jquery',\r\n    'block_ases/jscookie'\r\n], function ($, Cookies) {\r\n\r\n\r\n    let visible = false;\r\n    let current_ids = [];\r\n    let page_title = $(\"title\").text();\r\n\r\n\r\n    $(\"html\").append('<div id=\"notification_sound\" style=\"display:none;\"></div>');\r\n\r\n    function check_incidents(callback) {\r\n        $.ajax({\r\n            type: \"POST\",\r\n            url: \"../managers/incident_manager/incident_api.php\",\r\n            data: JSON.stringify({ \"function\": \"get_ids_open_incidents\", \"params\": [] }),\r\n            contentType: \"application/json; charset=utf-8\",\r\n            dataType: \"json\",\r\n            async: false,\r\n            success: function (data) {\r\n                if (typeof callback === 'function') {\r\n                    callback(data.data_response);\r\n                }\r\n            },\r\n            failure: function (errMsg) { }\r\n        });\r\n    }\r\n\r\n    function add_counter_page(number) {\r\n        if (number > 0) {\r\n            $(\"title\").text(\"(\" + number + \")\" + \" \" + page_title);\r\n        } else {\r\n            $(\"title\").text(page_title);\r\n        }\r\n    }\r\n\r\n    function playSound() {\r\n        if (Cookies.get('beep') == \"true\") {\r\n            let filename = 'notification_sound';\r\n            let mp3Source = '<source src=\"../resources/' + filename + '.mp3\" type=\"audio/mpeg\">';\r\n            let oggSource = '<source src=\"../resources/' + filename + '.ogg\" type=\"audio/ogg\">';\r\n            let embedSource = '<embed hidden=\"true\" autostart=\"true\" loop=\"false\" src=\"../resources/' + filename + '.mp3\">';\r\n            document.getElementById(\"notification_sound\").innerHTML = '<audio autoplay=\"autoplay\">' + mp3Source + oggSource + embedSource + '</audio>';\r\n            Cookies.set('beep', \"false\");\r\n        }\r\n    }\r\n\r\n    let menu_incidents_manager = $(\"#menu_incidents_manager\").find(\".menu_a\");\r\n\r\n    console.log(\"Incident notifier initialised\");\r\n\r\n    return {\r\n        init: function () {\r\n\r\n            if (menu_incidents_manager.length) {\r\n\r\n                check_incidents(\r\n                    function (data) {\r\n\r\n                        let number_open_incidents = data.length;\r\n                        add_counter_page(number_open_incidents);\r\n\r\n                        if (number_open_incidents > 0) {\r\n                            visible = true;\r\n\r\n                            data.forEach(element => {\r\n                                current_ids.push(element.id)\r\n                            });\r\n\r\n                            menu_incidents_manager.append(' <span id=\"incidents_counter\" class=\"badge badge-secondary\">' + data.length + '</span>');\r\n                        }\r\n\r\n                    }\r\n                );\r\n\r\n\r\n                setInterval(() => {\r\n\r\n                    check_incidents(\r\n                        function (data) {\r\n                            let beep = false;\r\n                            let number_open_incidents = data.length;\r\n                            add_counter_page(number_open_incidents);\r\n\r\n                            if ((number_open_incidents > 0) && !visible) {\r\n                                visible = true;\r\n                                beep = true;\r\n                                Cookies.set('beep', beep);\r\n                                menu_incidents_manager.append(' <span id=\"incidents_counter\" class=\"badge badge-secondary\">' + data.length + '</span>');\r\n                            } else if ((number_open_incidents > 0) && visible) {\r\n\r\n                                let new_elements = false;\r\n                                let ids = [];\r\n                                data.forEach(element => {\r\n                                    ids.push(element.id)\r\n                                    if (current_ids.indexOf(element.id) === -1) {\r\n                                        new_elements = true;\r\n                                    };\r\n                                });\r\n\r\n                                if (new_elements) {\r\n                                    current_ids = ids;\r\n                                    beep = true;\r\n                                    Cookies.set('beep', beep);\r\n                                    $(\"#incidents_counter\").text(data.length);\r\n                                }\r\n\r\n\r\n                            } else if (number_open_incidents === 0) {\r\n                                $(\"#incidents_counter\").remove();\r\n                            }\r\n\r\n                            if (beep) {\r\n                                playSound();\r\n                                beep = false;\r\n                            }\r\n\r\n                        }\r\n                    );\r\n\r\n                }, 3000);\r\n\r\n            }\r\n\r\n        }\r\n    };\r\n});"],"file":"incident_notifier.min.js"}