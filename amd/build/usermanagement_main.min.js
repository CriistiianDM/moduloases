define(["jquery","block_ases/bootstrap","block_ases/datatables.net","block_ases/datatables.net-buttons","block_ases/buttons.flash","block_ases/jszip","block_ases/pdfmake","block_ases/buttons.html5","block_ases/buttons.print","block_ases/sweetalert","block_ases/select2"],function(e,a,n,r,s,t,o,i,l,u,c){var d;return{init:function(){function a(){e.ajax({type:"POST",url:"../managers/user_management/load_role.php",async:!1,success:function(a){e("#role_select").empty();for(role in a){var n='<option value="'+a[role].nombre_rol+'">'+a[role].nombre_rol+"</option>";e("#role_select").append(n)}roleLoaded=!0},dataType:"json",error:function(e){alert("error al cargar roles")}})}function n(a,n){var r=a;r||(r=e("#users").val()),e.ajax({type:"POST",data:{dat:r,idinstancia:g()},url:"../managers/user_management/search_user.php",success:function(a){n?n(a):a.error?(swal("Error",a.error,"error"),e(".assignment_li").addClass("hidden"),e("#form_mon_student").css({display:"none"}),e("#users").val("").trigger("change.select2"),e("#users").prop("disabled",!1),e("#name_lastname").val(" "),e("#search_button").prop("disabled",!1)):(e("#contenedor_add_fields").html(""),""==a.firstname?(swal("Error","El usuario no existe en la base de datos","error"),e("#users").prop("disabled",!1)):(e(".assignment_li").removeClass("hidden"),e("#name_lastname").val(a.firstname+" "+a.lastname),e("#user_id").val(a.id),""==a.rol?e("#role_select").val("no_asignado"):("profesional_ps"==a.rol?(e("#select_prof_type").val(a.profesion),e("#form_prof_type").fadeIn(),e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut()):"monitor_ps"==a.rol?(o(),i(4,a.boss),e("#form_mon_student").fadeIn(),e("#form_prof_type").fadeOut()):"practicante_ps"==a.rol?(i(7,a.boss),e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut()):(e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut()),e("#role_select").val(a.rol))))},dataType:"json",error:function(a){swal("Error","El usuario no existe en la base de datos","error"),e(".assignment_li").addClass("hidden"),e("#form_mon_student").css({display:"none"}),e("#users").val("").trigger("change.select2"),e("#users").prop("disabled",!1),e("#name_lastname").val(" "),e("#search_button").prop("disabled",!1)}})}function r(){var a=e("#role_select").val(),r=e("#users").val(),s=new Array;if(e('input[name="array_students[]"]').each(function(){s.push(e(this).val().split(" - ")[0])}),e('select[name="array_students[]"]').each(function(){s.push(e(this).val().split(" - ")[0])}),"profesional_ps"==a){var t=e("#select_prof_type").val();if("no_asignado"==t)swal("Error",'El usuario no tiene un "tipo de profesional" asignado, debe asignar un "tipo de profesional".',"error");else{var o={role:a,username:r,professional:t,idinstancia:g()};e.ajax({type:"POST",data:o,url:"../managers/user_management/update_role_user.php",success:function(e){swal("Información!",e,"info"),n(r)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error asignando profesional","error")}})}}else if("monitor_ps"==a){var i=e("#boss_select").val();e.ajax({type:"POST",data:{role:a,username:r,students:s,boss:i,idinstancia:g()},url:"../managers/user_management/update_role_user.php",success:function(e){alert(e),swal({title:"Información!",text:e,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),n(r)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}else if("practicante_ps"==a){var i=e("#boss_select").val();e.ajax({type:"POST",data:{role:a,username:r,boss:i,idinstancia:g()},url:"../managers/user_management/update_role_user.php",success:function(e){swal({title:"Información!",text:e,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),n(r)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}else e.ajax({type:"POST",data:{role:a,username:r,idinstancia:g()},url:"../managers/user_management/update_role_user.php",success:function(e){swal("Información!",e,"info")},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}function s(a){e("#"+a).select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}},dropdownAutoWidth:!0})}function t(){var a=10,n=(e("#contenedor_add_fields"),e("#agregarCampo"));e.ajax({type:"POST",data:{"function":"students_consult",instancia:g()},url:"../managers/user_management/seguimiento.php",success:function(r){d=r;var t=e("#contenedor_add_fields div").length+1,o=t-1;e(n).click(function(n){if(a>=t){o++;var r="";for(var i in d)r+='<option value="'+d[i].username+'">'+d[i].username+" - "+d[i].firstname+" "+d[i].lastname+"</option>";e("#contenedor_add_fields").append('<div class="select-pilos"><select class="form-select-pilos" name="array_students[]" id="campo_'+o+'"">'+r+"</select></div>"),s("campo_"+o),t++}return!1}),e("body").on("click",".eliminar_add_fields",function(a){var n=e(this).parent("div").children("input").val(),r=e(this).parent("div");return n&&swal({title:"Estas seguro/a?",text:"Se desvinculará el prensente monitor del estudiante con codigo "+n,type:"warning",showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"No",closeOnConfirm:!0},function(e){e&&(l(n),r.remove(),t--)}),!1})},dataType:"json",cache:"false",error:function(e){alert("error al consultar estudiantes")}})}function o(){var a=new Array,n=e("#user_id").val();a.push({name:"function",value:"load_grupal"}),a.push({name:"user_management",value:n}),a.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:a,url:"../managers/user_management/seguimiento.php",success:function(a){if(e("#contenedor_add_fields").html(""),0!=a.rows){var n="";for(var r in d)n+='<option value="'+d[r].username+'">'+d[r].username+" - "+d[r].firstname+" "+d[r].lastname+"</option>";var s=a.content;for(x in s)e("#contenedor_add_fields").append('<div id="contenedor_add_fields"> <div class="added_add_fields"> <input type="text"  class="inputs_students" name="array_students[]" id="campo_1" value="'+s[x].username+" - "+s[x].firstname+" "+s[x].lastname+'" readonly/> <a href="#" class="eliminar_add_fields"><img src="../icon/ico_wrong.png"></a> </div> </div>')}},dataType:"json",cache:"false",error:function(e){alert("error al cargar estudiantes")}})}function i(a,n){var r=new Array,s=0;r.push({name:"function",value:"cargar"}),r.push({name:"role",value:a}),r.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:r,url:"../managers/user_management/search_user.php",success:function(a){e("#boss_select").html(""),e("#boss_select").append('<option value="ninguno">Ninguno</option>');for(x in a){var r=a[x].firstname.split(" "),t=a[x].lastname.split(" "),o=!1;n==a[x].id?(e("#boss_select").append('<option value="'+a[x].id+'" selected>'+a[x].username+"-"+r[0]+" "+t[0]+"</option>"),o=!0,s=a[x].id):e("#boss_select").append('<option value="'+a[x].id+'" >'+a[x].username+"-"+r[0]+" "+t[0]+"</option>")}e("#boss_li").removeClass("hide")},dataType:"json",cache:"false",error:function(e){alert("error al cargar profesionales")}})}function l(a){var n=new Array,r=(e("#user_id").val(),e("#users").val());n.push({name:"deleteStudent",value:"delete"}),n.push({name:"student",value:a.split(" - ")[0]}),n.push({name:"username",value:r}),n.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:n,url:"../managers/user_management/update_role_user.php",success:function(e){},dataType:"json",cache:"false",error:function(e){alert("Error al eliminar estudiante")}})}function u(){e.ajax({type:"POST",data:{idinstancia:g()},url:"../managers/user_management/load_role_users.php",success:function(a){e("#div_users").empty(),e("#div_users").append('<table id="tableUsers" class="display" cellspacing="0" width="100%"><thead><thead></table>');e("#tableUsers").DataTable(a);e("#div_users #delete_user").css("cursor","pointer")},dataType:"json",cache:"false",error:function(e){alert("Error al cargar usuarios")}})}function c(a,s){var t=new Array;t.push({name:"function",value:"load_grupal"}),t.push({name:"user_management",value:a.id}),t.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:t,url:"../managers/user_management/seguimiento.php",success:function(e){if(0!=e.rows){var t=e.content,o='<p align=justify">Se ha encontrado que el usuario tiene asignado el rol MONITOR y tiene a cargo los siguientes estudiantes:</p><br><br> ';o+='<div class="pre-scrollable" style="max-height:200px"><table id="tableStudent" class="table table-striped"> <thead> <tr> <th>Código</th> <th>Nombre</th> <th>Apellido</th></tr> </thead><tbody>';for(x in t)o+="<tr> <td>"+t[x].username+"</td> <td>"+t[x].firstname+"</td> <td>"+t[x].lastname+"</td> </tr>";o+='</tbody></table></div><br><br><p align=justify">Para continuar se creará un nuevo usuario con rol monitor quien se hará a cargo de los anteriores estudiante(s).<br> Por favor escribe el código del nuevo usuario:</p>';var i="";i=s?"Antes de eliminar!":"Antes de Actualizar!",swal({title:i,html:!0,text:o,type:"input",showCancelButton:!0,closeOnConfirm:!1,confirmButtonColor:"#d51b23",confirmButtonText:"Continuar",cancelButtonText:"Cancelar!",animation:"slide-from-top",inputPlaceholder:"Código"},function(e){return e===!1?!1:""===e?(swal.showInputError("Escibe el código del nuevo monitor!"),!1):void n(e,function(e){return e.error?swal.showInputError(e.error):p(e,a,s),!1})})}else r(),u()},dataType:"json",cache:"false",error:function(e){alert("error al validar monitor")}})}function p(e,a,n){var r="";r="ninguno"==e.rol?"El usuario <strong>"+e.firstname+" "+e.lastname+"</strong> con código <strong>"+e.username+"</strong> se le asiganara el rol monitor y tendrá a cargo los estudiantes del anterior monitor<br>¿Está de acuerdo con los cambios que se efectuarán?":"El usuario <strong>"+e.firstname+" "+e.lastname+"</strong> con código <strong>"+e.username+"</strong> ya tiene el rol <strong>"+e.rol+"</strong>  en el sistema.<br>Perderá el presente rol y se le asiganará el rol monitor.<br> Tendrá a cargo los estudiantes del anterior monitor.<br><br><strong>¿Estás de acuerdo con los cambios que se efectuarán?</strong>",swal({title:"Estás seguro/a?",text:r,type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"Atras!",closeOnConfirm:!1,closeOnCancel:!1,animation:"slide-from-top"},function(r){r?m(e,a,n):c(a,n)})}function m(a,n,s){var t=new Array;t.push({name:"changeMonitor",value:"changeMonitor"}),t.push({name:"oldUser",value:JSON.stringify([n.id,n.username])}),t.push({name:"newUser",value:JSON.stringify([a.id,a.username])}),t.push({name:"isdelete",value:s}),t.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:t,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(s?swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"):(swal("Hecho!","El proceso de reasignación de estudiantes se completó satisfactoriamente. Por favor actualiza y guarda el nuevo rol","success"),r(),u()),u()):swal("Error!",e,"error")},dataType:"text",cache:"false",error:function(e){alert("Error al cambiar monitor")}})}function f(a){var n=new Array;n.push({name:"deleteProfesional",value:"deleteProfesional"}),n.push({name:"user",value:JSON.stringify([a.id,a.username])}),n.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:n,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"),u()):swal("Error!",e,"error")},dataType:"json",cache:"false",error:function(e){alert("Error al eliminar profesional")}})}function _(a){var n=new Array;n.push({name:"deleteOtheruser",value:"deleteOtheruser"}),n.push({name:"user",value:JSON.stringify([a.id,a.username,a.rol])}),n.push({name:"idinstancia",value:g()}),e.ajax({type:"POST",data:n,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"),u()):swal("Error!",e,"error")},dataType:"json",cache:"false",error:function(e){alert("Error al eliminar otros usuarios")}})}function g(){var e=location.search.split("&");for(x in e)if(e[x].indexOf("instanceid")>=0){var a=e[x].split("=");return a[1]}return 0}e("#users").select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}},dropdownAutoWidth:!0}),e(document).ready(function(){var s=!1;e(".assignment_li").css({display:"none"}),e("#form_mon_student").css({display:"none"}),e("#search_button").on("click",function(){e("#search_button").prop("disabled",!0),s||a(),n(),e("#users").prop("disabled",!0),e(".assignment_li").slideToggle("fast")}),e("#ok-button").on("click",function(){var a=e("#role_select").val();n(null,function(n){if("monitor_ps"==n.rol&&n.rol!=a){var s=new Array;s.id=e("#user_id").val(),s.username=e("#users").val(),c(s,!1)}else r(),u()})}),e("#cancel-button").on("click",function(){e(".assignment_li").addClass("hidden"),e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#users").val("").trigger("change.select2"),e("#users").prop("disabled",!1),e("#search_button").prop("disabled",!1),e("#name_lastname").val(" "),e("#form_prof_type").fadeOut()}),e("#form_mon_estudiante").css({display:"none"}),e("#form_prof_type").css({display:"none"}),e("#role_select").on("change",function(){"monitor_ps"==e("#role_select").val()?(e("#form_prof_type").fadeOut(),e("#form_mon_student").fadeIn(),i(4),e("#boss_li").fadeIn()):"profesional_ps"==e("#role_select").val()?(e("#form_prof_type").fadeIn(),e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut()):"practicante_ps"==e("#role_select").val()?(e("#form_prof_type").fadeOut(),e("#form_mon_student").fadeOut(),i(7),e("#boss_li").fadeIn()):(e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut())}),e("#list-users-panel").on("click",function(){u()}),e("#div_users").on("click","#delete_user",function(){var a=e("#div_users #tableUsers").DataTable(),r=e(this).parent(),s=e(this).children("span").attr("id"),t=(a.cell(r).index().column,a.cell(a.row(r).index(),0).data()),o=a.cell(a.row(r).index(),1).data(),i=a.cell(a.row(r).index(),2).data(),l=a.cell(a.row(r).index(),3).data(),u=new Array;u.id=s,u.username=t,swal({title:"Estas seguro/a?",text:"Al usuario <strong>"+o+" "+i+"</strong> con código <strong>"+t+"</strong> se le inhabilitará los permisos del rol <strong>"+l+"</strong>.<br><strong>¿Estás de acuerdo con los cambios que se efectuarán?</strong>",type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"No",closeOnConfirm:!0},function(e){e&&n(t,function(e){u.rol=e.rol;var a=e.rol;switch(a){case"monitor_ps":c(u,!0);break;case"profesional_ps":f(u);break;default:_(u)}})})}),t()})}}});