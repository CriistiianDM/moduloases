/**
 * Management - Tracks (seguimiento de pilos)
 * @module amd/src/pilos_tracking_main 
 * @author Isabella Serna Ram√≠rez <isabella.serna@correounivalle.edu.co>
 * @author Jeison Cardona Gomez <jeison.cardona@correounivalle.edu.co>
 * @license  http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */ define(["jquery","block_ases/Modernizr-v282","block_ases/bootstrap","block_ases/jquery.dataTables","block_ases/sweetalert","block_ases/select2","block_ases/loading_indicator"],function($,a,b,c,d,e,f){return{init:function(){var e=[],g=0,h=0,i="",j="",k="",l=parseInt($("#current_ases_semester").data("info"));function m(b,c,d,e){let a="get_tracking_count";e&&(a="get_tracking_count_student"),f.show(),$.ajax({type:"POST",data:JSON.stringify({function:a,params:[b,c,d]}),url:"../managers/pilos_tracking/v2/pilos_tracking_api.php",dataType:"json",cache:"false",success:function(h){f.hide();let b=h.data_response,c=0,d=0,e=0,g=0,i=0,k=0;for(let a=0;a<b.length;a++){c=b[a].count.revisado_profesional+b[a].count.not_revisado_profesional,d=b[a].count.not_revisado_profesional,e=b[a].count.not_revisado_practicante,g=b[a].count.in_revisado_profesional+b[a].count.in_not_revisado_profesional;let j='                                <div class="conteo">                                    <div class="row">                                         <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">                                             Fichas: <strong>'+c+'</strong>                                        </div>                                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">                                             <div class="pend-prof">Pendientes Prof: </div>'+d+'                                        </div>                                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">                                             <div class="pend-pract">Pendientes pract: </div>'+e+'                                        </div>                                    </div>                                    <div class="row">                                         <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">                                             Inasistencias: <strong>'+g+'</strong>                                        </div>                                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">                                             <div class="pend-prof">Pendientes Prof: </div>'+(i=b[a].count.in_not_revisado_profesional)+'                                        </div>                                        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">                                             <div class="pend-pract">Pendientes pract: </div>'+b[a].count.in_not_revisado_practicante+"                                        </div>                                    </div>                                </div>                            ";$("#counting_"+b[a].username).find(".loader").html(j)}},error:function(a){f.hide(),console.log(a),swal({title:"Error!",text:"",html:!0,type:"error",confirmButtonColor:"#d51b23"})}})}function n(a){$("#general_rev_pro").html("*"),$("#general_rev_prac").html("*"),$("#general_not_rev_pro").html("*"),$("#general_not_rev_prac").html("*"),$("#general_pro_t").html("*"),$("#general_prac_t").html("*"),$("#general_in_rev_pro").html("*"),$("#general_in_rev_prac").html("*"),$("#general_in_not_rev_pro").html("*"),$("#general_in_not_rev_prac").html("*"),$("#general_in_pro_t").html("*"),$("#general_in_prac_t").html("*"),f.show(),$.ajax({type:"POST",data:{type:"user_specific_counting",user:a,instance:s()},url:"../managers/pilos_tracking/pilos_tracking_report.php",async:!0,dataType:"json",cache:"false",success:function(a){f.hide(),$("#general_rev_pro").html(a.revisado_profesional),$("#general_rev_prac").html(a.revisado_practicante),$("#general_not_rev_pro").html(a.not_revisado_profesional),$("#general_not_rev_prac").html(a.not_revisado_practicante),$("#general_pro_t").html(a.total_profesional),$("#general_prac_t").html(a.total_practicante),$("#general_in_rev_pro").html(a.in_revisado_profesional),$("#general_in_rev_prac").html(a.in_revisado_practicante),$("#general_in_not_rev_pro").html(a.in_not_revisado_profesional),$("#general_in_not_rev_prac").html(a.in_not_revisado_practicante),$("#general_in_pro_t").html(a.in_total_profesional),$("#general_in_prac_t").html(a.in_total_practicante)},error:function(a){f.hide()}})}function a(){$('a[class*="practicant"]').click(function(){let a=$(this).data("username");if(-1==e.indexOf(a)){e.push(a);var d=$(this).attr("href").split("#practicant")[1],g=$(this).attr("href");f.show(),$.ajax({type:"POST",data:{type:"get_practicants_of_professional",practicant_code:d,instance:s()},url:"../managers/pilos_tracking/pilos_tracking_report.php",async:!0,dataType:"json",cache:"false",success:function(a){f.hide(),$(g+" > div").empty(),$(g+" > div").append(a.render),a.counting,m(d,l,parseInt(s()),!1),b(),c()},error:function(a){f.hide(),swal({title:"Oops !",text:"Se present\xf3 un inconveniente con el practicante seleccionado.",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}})}})}function b(){$('a[class*="monitor"]').click(function(){let a=$(this).data("username");if(-1==e.indexOf(a)){e.push(a);var b=$(this).attr("href").split("#monitor")[1],g=$(this).attr("href");f.show(),$.ajax({type:"POST",data:{type:"get_monitors_of_practicant",monitor_code:b,instance:s()},url:"../managers/pilos_tracking/pilos_tracking_report.php",async:!0,dataType:"json",cache:"false",success:function(a){f.hide(),$(g+" > div").empty(),$(g+" > div").append(a),m(b,l,parseInt(s()),!0),d(),c()},error:function(a){f.hide(),swal({title:"Oops !",text:"Se present\xf3 un inconveniente con el monitor seleccionado.",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}})}})}function c(){$('a[class*="groupal"]').click(function(){var a=$(this).attr("href").split("#groupal")[1],b=$(this).attr("href");f.show(),$.ajax({type:"POST",data:{type:"get_groupal_trackings",student_code:a,instance:s()},url:"../managers/pilos_tracking/pilos_tracking_report.php",async:!1,success:function(a){f.hide(),$(b+" > div").empty(),$(b+" > div").append(a)},dataType:"json",cache:"false",error:function(a){f.hide(),swal({title:"Oops !",text:"Se present\xf3 un inconveniente con los seguimientos grupales seleccionados.",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}})})}function d(){$('a[class*="student"]').click(function(){let a=$(this).data("username");if(-1==e.indexOf(a)){e.push(a);var b=$(this).attr("href").split("#student")[1],c=$(this).attr("href");f.show(),$.ajax({type:"POST",data:{type:"get_student_trackings",student_code:b,instance:s()},url:"../managers/pilos_tracking/pilos_tracking_report.php",async:!1,success:function(a){f.hide(),$(c+" > div").empty(),$(c+" > div").append(a)},dataType:"json",cache:"false",error:function(a){f.hide(),swal({title:"Oops !",text:"Se present\xf3 un inconveniente con el estudiante seleccionado.",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}})}}),$(".see_history").unbind().click(function(b){var a=$(this).parents().eq(3).attr("href").split("#monitor")[1];f.show(),$.ajax({type:"POST",data:{type:"redirect_tracking_time_control",monitor:a},url:"../managers/pilos_tracking/pilos_tracking_report.php",async:!1,success:function(b){f.hide();var c=window.location.href.replace("report_trackings","tracking_time_control");try{var a=window.open(c+"&&monitorid="+b,"_blank");a&&a.focus()}catch(d){alert("Se ha producido un error al abrir la ventana : "+d)}},dataType:"json",cache:"false",error:function(a){f.hide(),swal({title:"Oops !",text:"Se present\xf3 un inconveniente al reedirecionar al reporte de horas.",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}})})}function o(e,g,i){$("#periodos").change(function(){if("sistemas"!=k){var g=$("#periodos").val(),j=h;f.show(),$.ajax({type:"POST",data:{id_persona:j,id_semestre:g,instance:e,otro:!0,type:"consulta_sistemas"},url:"../../../blocks/ases/managers/pilos_tracking/pilos_tracking_report.php",dataType:"text",cache:"false",success:function(e){f.hide(),""==e?$("#reemplazarToogle").html("<label> No se encontraron registros </label>"):($("#reemplazarToogle").html(e),d(),b(),a(),c()),$(".well.col-md-10.col-md-offset-1.reporte-seguimiento.oculto").slideDown("slow"),m(i,g,parseInt(s()),!1)},error:function(a){f.hide(),swal("ERROR!","Oops!, Se present\xf3 un error al consultar seguimientos de personas","error")}})}})}function p(g){$("#personas").val("").change(),$("#personas").select2({placeholder:"Seleccionar persona",language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}}}),$("#periodos").select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}}}),r(g,k),$("#consultar_persona").on("click",function(){var g=$("#personas").children(":selected").attr("value"),h=$("#periodos").children(":selected").attr("value");let i=$("#personas").children(":selected").data("username");if(e=[],void 0==g)swal({title:"Debe escoger una persona para realizar la consulta",html:!0,type:"warning",confirmButtonColor:"#d51b23"});else{$(".well.col-md-10.col-md-offset-1.reporte-seguimiento.oculto").show(),$(".se-pre-con").show(),$("#reemplazarToogle").hide();let j=g;f.show(),$.ajax({type:"POST",data:{id_persona:g,id_semestre:h,instance:s(),type:"consulta_sistemas"},url:"../../../blocks/ases/managers/pilos_tracking/pilos_tracking_report.php",dataType:"text",cache:"false",success:function(e){f.hide(),""==e?$("#reemplazarToogle").html("<label> No se encontraron registros </label>"):($("#reemplazarToogle").html(e),$("input[name=practicante]").prop("disabled",!0),$("input[name=profesional]").prop("disabled",!0)),n(j),d(),b(),a(),c(),$(".well.col-md-10.col-md-offset-1.reporte-seguimiento.oculto").slideDown("slow"),m(i,h,parseInt(s()),!1)},error:function(a){f.hide(),swal("ERROR!","Oops!, Se present\xf3 un error al cargar seguimientos de personas","error")},complete:function(){$(".se-pre-con").hide(),$("#reemplazarToogle").fadeIn()}})}})}function q(a){$("body").on("click","#send_observation",function(){var h=$("form").serializeArray(),i={};$(h).each(function(b,a){i[a.name]=a.value});var j=i.id_registro,e=$("#observation_text");if(""==e.val())swal({title:"Para enviar una observaci\xf3n debe llenar el campo correspondiente.",html:!0,type:"error",confirmButtonColor:"#d51b23"});else{var g="individual",b=$(".id_creado_por").find("input").val();void 0==b&&(b=$(".in_id_creado_por").find("input").val(),g="individual_inasistencia");var c=$(".fecha").find("input").val();void 0==c&&(c=$(".in_fecha").find("input").val());var k=e.val(),l=$("#periodos").val(),d=$(".lugar").find("input").val();void 0==d&&(d=$(".in_lugar").find("input").val());let m=$("#dphpforms_block_courseid").data("info");f.show(),$.ajax({type:"POST",data:{id_tracking:j,type:"send_email_to_user",form:"new_form",tracking_type:g,monitor_code:b,date:c,message_to_send:k,semester:l,instance:a,place:d,courseid:m},url:"../../../blocks/ases/managers/pilos_tracking/pilos_tracking_report.php",async:!1,success:function(a){f.hide(),0===(a=JSON.parse(a)).status_code?(swal({title:"Correo enviado",html:!0,type:"success",confirmButtonColor:"#d51b23"}),e.val("")):(console.log(`mensaje error : ${a.error_message}`),swal({title:"Error al enviar correos",text:a?.error_message,html:!0,type:"error",confirmButtonColor:"#d51b23"}))},dataType:"text",cache:"false",error:function(a){f.hide(),console.log("mensaje error : "),console.log(a),swal("ERROR!","Oops!, Se present\xf3 un error al enviar el correo","error")}})}})}function r(a,b){$("#periodos").change(function(){var c=$("#periodos").val();f.show(),$.ajax({type:"POST",data:{id:c,instance:a,type:"update_people"},url:"../../../blocks/ases/managers/pilos_tracking/pilos_tracking_report.php",async:!1,success:function(a){if(f.hide(),$("#personas").empty(),$("#personas").select2({placeholder:"Seleccionar persona",language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}}}),"sistemas"==b){var c='<option value="">Seleccionar persona</option>';$("#personas").attr("selectedIndex","-1").find("option:selected").removeAttr("selected"),$("#personas").append(c+a)}},dataType:"text",cache:"false",error:function(a){f.hide(),swal("ERROR!","Oops!, Se present\xf3 un error al cargar personas","error")}})})}function s(){for(var c=window.location.search.split("&"),a=0;a<c.length;a++){var b=c[a].split("=");if("?instanceid"==b[0]||"instanceid"==b[0])var d=b[1]}return d}$("#msg-cache").click(function(){swal({title:"\xa1Informaci\xf3n!",text:"Est\xe1 observando una versi\xf3n reciente del conteo, m\xe1s no una versi\xf3n en vivo. El conteo se actualizar\xe1 en un intervalo de tiempo no mayor a 30 minutos.",type:"info"})}),$(document).on("click",".btn-dphpforms-close",function(){$(this).closest('div[class="mymodal"]').fadeOut(300)}),$(".outside").click(function(){var a=$(this);swal({title:"Confirmaci\xf3n de salida",text:"",type:"warning",showCancelButton:!0,confirmButtonText:"Salir"},function(b){b&&$(a).parent(".mymodal").fadeOut(300)})}),$(document).ready(function(){$(".se-pre-con").fadeOut("slow"),$("#reemplazarToogle").fadeIn("slow");let b="";f.show(),$.ajax({type:"POST",data:{type:"getInfo",instance:s()},url:"../../../blocks/ases/managers/pilos_tracking/pilos_tracking_report.php",async:!1,success:function(a){f.hide(),i=($data=$.parseJSON(a)).username,b=$data.username,h=$data.id,j=$data.email,g=$data.rol,k=$data.name_rol},dataType:"text",cache:"false",error:function(a){f.hide(),swal({title:"error al obtener informaci\xf3n del usuario, getInfo.",html:!0,type:"error",confirmButtonColor:"#d51b23"})}}),i="";var a=[];a.id=h,a.name=i,a.namerol=k,n(a),"practicante_ps"==k?(m(b,l,parseInt(s()),!1),o(s(),a,b),q(s())):"profesional_ps"==k?(m(b,l,parseInt(s()),!1),o(s(),a,b),q(s())):"monitor_ps"==k?(m(b,l,parseInt(s()),!0),o(s(),a,b),q(s())):"sistemas"==k&&(p(s()),q(s()))}),$(".mymodal-close").click(function(){$(this).parent().parent().parent().parent().fadeOut(300)}),d(),b(),a(),c()}}})