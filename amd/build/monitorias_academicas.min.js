define(["jquery","block_ases/jquery.dataTables","block_ases/dataTables.buttons","block_ases/buttons.html5","block_ases/buttons.flash","block_ases/buttons.print","block_ases/_general_modal_manager","block_ases/select2","block_ases/jqueryui","block_ases/loading_indicator","block_ases/sweetalert","extras"],function(a,e,t,n,o,r,i,s,c,l,m,d){return{init:function(){a(document).on("click","#anadir_monitoria",p),a(document).on("click","#config-icon",u),a.datepicker.setDefaults({closeText:"Cerrar",prevText:"&#x3C;Ant",nextText:"Sig&#x3E;",currentText:"Hoy",monthNames:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],monthNamesShort:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],dayNames:["domingo","lunes","martes","miércoles","jueves","viernes","sábado"],dayNamesShort:["dom","lun","mar","mié","jue","vie","sáb"],dayNamesMin:["D","L","M","X","J","V","S"],weekHeader:"Sm",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""})},cargar_monitorias_default:function(e){a("#div_table").html(""),a("#div_table").fadeIn(500).append('<table id="tableResult" class="stripe row-border order-column" cellspacing="0" width="100%"><thead> </thead></table>'),a("#tableResult").DataTable(e)},continuar_setup_inicial:function(e){e?a(".dt-button.buttons-print.eliminar").toggle():a(".dt-button.buttons-print.eliminar").click(g)}};function u(){a.when(a.ajax({url:"../templates/monitorias_academicas_config.mustache",data:null,dataType:"text",async:!0,success:function(a){let e=a;i.generate_modal("modal_config","Configuración",e,null,function(){i.show_modal(".modal_config")})},error:function(){console.log("../templates/monitorias_academicas_config.mustache cannot be reached.")}})).done(()=>{a.ajax({type:"POST",data:JSON.stringify({function:"cargar_grupos",params:[d.getUrlParams(document.location.search).courseid]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){var t=a.map(e.data_response,function(a){return{id:a.id,text:a.nombre}});a("#grupos").select2({data:t,placeholder:"Seleccionar grupo"}),a("#grupos").val(e.seleccionado.id_number).change()},error:function(e){console.log("Error consulta BD grupo"),console.log(e),a("#debug").html(e.responseText)}}),a("#cancel_config").click(()=>{a(".general_modal_close").first().click()}),a("#form_config").submit(function(e){e.preventDefault(),l.show();var t=a("select[name='grupo']").val();a.ajax({type:"POST",data:JSON.stringify({function:"actualizar_config",params:[parseInt(t)]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){l.hide(),a(".general_modal_close").first().click(),0!=e.status_code&&(swal("Error!","Oops!: "+e.data_response,"error"),console.log(e))},error:function(e){console.log("Error update bd de config en backend"),a("#debug").html(e.responseText)}})})})}function p(){a.ajax({url:"../templates/monitorias_academicas_anadir.mustache",data:null,dataType:"text",async:!0,success:function(e){let t=e;i.generate_modal("modal_fomulario_anadir","Añadir monitoria",t,null,function(){i.show_modal(".modal_fomulario_anadir")}),function(){(function(){function e(e){if(e.hasOwnProperty("newTag")&&e.newTag)return a(`<span id="materia_nueva" class="opcion-select">${e.text}<span style="opacity:0.5;margin-left:1ch">(agregar)</span><div class="icono-agregar-materia"><span>`);var t=a(`<span id="materia_${e.id}" class="opcion-select">${e.text}<div class="boton-eliminar-materia"><span>`);return t}function t(e){return""===a.trim(e.term)||a.trim(e.term).length<3?null:{id:-1,text:e.term,newTag:!0}}a.ajax({type:"POST",data:JSON.stringify({function:"cargar_materias",params:[]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(n){var o=a.map(n.data_response,function(a){return{id:a.id,text:a.nombre}});a("#materia").select2({data:o,placeholder:"Seleccionar materia",templateResult:e,createTag:t,tags:!0,escapeMarkup:function(a){return a}}).on("select2:closing",function(e){var t=e.params.args.originalEvent;if(null!=t&&a(t.target).hasClass("boton-eliminar-materia")){var n=e.params.args.originalSelect2Event.data;e.preventDefault(),e.stopPropagation(),a.ajax({type:"POST",data:JSON.stringify({function:"eliminar_materia",params:[parseInt(n.id)]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){0==e.status_code?(a("#materia").find(`option[value=${n.id}]`)[0].remove(),a("#materia").trigger("change"),a(t.target).parent(".opcion-select").parent(".select2-results__option").hide()):swal("Error!","Oops!: "+e.error_response,"error")},error:function(e){console.log("Error eliminar bd de materia en backend"),a("#debug").html(e.responseText)}})}}).on("select2:opening",function(e){prevselection=a(e.target).find(":selected"),a("#materia").val(null)}).on("select2:select",function(e){var t=e.params.data;-1==t.id&&a.ajax({type:"POST",data:JSON.stringify({function:"anadir_materia",params:[t.text]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){if(0==e.status_code){a("#materia").find("option[value=-1]")[0].value=e.id;var n=new Option(t.text,e.id,!1,!0);a("#materia").append(n).trigger("change")}else swal("Error!","Oops!: "+e.data_response,"error")},error:function(e){console.log("Error insercion bd de materia en backend"),a("#debug").html(e.responseText)}})})},error:function(a){console.log("Error consulta BD materias"),console.log(a)}})})(),a.ajax({type:"POST",data:JSON.stringify({function:"cargar_monitores",params:[d.getUrlParams(document.location.search).instanceid]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){var t=a.map(e.data_response,function(a){return{id:a.id,text:a.nombre+" "+a.apellido}});a("#monitor").select2({data:t,placeholder:"Seleccionar monitor"})},error:function(e){console.log("Error consulta BD monitores"),a("#debug").html(e.responseText)}}),a("#cancel_monitoria_btn").click(()=>{a(".general_modal_close").first().click()}),a("#form_anadir").submit(function(e){e.preventDefault(),l.show();var t=a("select[name='dia']").val(),n=a("#hora_inicio1 option:selected").text()+" "+a("#hora_inicio2 option:selected").text()+" - "+a("#hora_final1 option:selected").text()+" "+a("#hora_final2 option:selected").text(),o=a("#materia").find(":selected").first().val(),r=a("#monitor").find(":selected").first().val(),i=a("#programar_monitorias_chckbx").prop("checked");if(i)var s=a("#fecha_hasta").val();else var s=-1;a.ajax({type:"POST",data:JSON.stringify({function:"anadir_monitoria",params:[t,n,o,r,i,s]}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(e){l.hide(),a(".general_modal_close").first().click(),0==e.status_code?swal({title:"Monitoria registrada",text:"Se ha agregado correctamente la monitoria",icon:"success"},function(a){location.reload()}):(swal("Error!","Oops!: "+e.data_response,"error"),console.log(e))},error:function(e){console.log("Error insercion bd de monitoria en backend"),a("#debug").html(e.responseText)}})}),a("#fecha_hasta").datepicker({minDate:0,showWeek:!0,dateFormat:"dd/M/y"}),a("#programar_monitorias_chckbx").change(()=>{a("#fecha_hasta").attr("required",a("#programar_monitorias_chckbx").prop("checked")),a("#seleccionar-fecha-anadir").toggle(300)})}()},error:function(){console.log("../templates/monitorias_academicas_anadir.mustache cannot be reached.")}})}function g(e){let t=a(e.target).parent().parent().find("td").toArray().map(a=>a.innerHTML);swal({title:"Eliminar monitoría",text:"¿Deseas eliminar la monitoría de  "+t[0]+" programada los "+t[1]+" de "+t[2]+"?",type:"warning",showCancelButton:!0,confirmButtonText:"Eliminar"},function(t){t&&a.ajax({type:"POST",data:JSON.stringify({function:"eliminar_monitoria",params:e.target.id}),url:"../managers/asistencia_monitorias/asistencia_monitorias_api.php",dataType:"json",success:function(a){location.reload()},error:function(a){swal("Error!",a,"error"),console.log(a)}})})}}),define("extras",function(){return{getUrlParams:function(a){for(var e=[],t=a.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");e[o[0]]=o[1]}return e}}});